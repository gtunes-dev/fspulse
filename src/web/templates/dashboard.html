<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FsPulse Dashboard - Dev Mode</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', system-ui, sans-serif;
            background: #fafafa;
            color: #1d1d1f;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .header {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: saturate(180%) blur(20px);
            border-bottom: 1px solid rgba(0,0,0,0.08);
            padding: 0;
            height: 52px;
            display: flex;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-title {
            font-size: 1.25rem;
            font-weight: 600;
            letter-spacing: -0.01em;
            color: #1d1d1f;
            margin: 0;
            padding: 0 24px;
        }

        .hamburger {
            display: none;
            cursor: pointer;
            font-size: 1.5rem;
        }

        .container {
            display: flex;
            min-height: calc(100vh - 52px);
        }

        .sidebar {
            width: 64px;
            background: #fafafa;
            border-right: 1px solid rgba(0,0,0,0.08);
            padding: 12px 0;
            transition: width 0.2s ease;
            overflow: hidden;
            position: relative;
        }

        .sidebar:hover {
            width: 240px;
        }

        .nav-item {
            padding: 10px 16px;
            margin: 0 8px 2px 8px;
            cursor: pointer;
            border: none;
            background: none;
            width: calc(100% - 16px);
            text-align: left;
            font-size: 0.9375rem;
            font-weight: 400;
            color: #1d1d1f;
            transition: background-color 0.15s ease;
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 12px;
            white-space: nowrap;
        }

        .nav-item:hover {
            background: rgba(0,0,0,0.04);
        }

        .nav-item.active {
            background: rgba(0,122,255,0.1);
            color: #007aff;
            font-weight: 500;
        }

        .nav-icon {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
            opacity: 0.6;
        }

        .nav-item.active .nav-icon {
            opacity: 1;
        }

        .nav-label {
            opacity: 0;
            transition: opacity 0.15s ease;
        }

        .sidebar:hover .nav-label {
            opacity: 1;
        }

        .nav-divider {
            margin: 12px 16px;
            border-top: 1px solid rgba(0,0,0,0.08);
        }

        .nav-section-header {
            font-size: 0.8125rem;
            font-weight: 600;
            letter-spacing: 0.06em;
            text-transform: uppercase;
            color: #86868b;
            padding: 12px 16px 8px 16px;
            margin-top: 8px;
            white-space: nowrap;
        }

        .nav-section-header .nav-label {
            opacity: 0;
            transition: opacity 0.15s ease;
        }

        .sidebar:hover .nav-section-header .nav-label {
            opacity: 1;
        }

        .main-content {
            flex: 1;
            padding: 32px;
            background: #fafafa;
        }

        .overview-modules {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .card {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: left;
        }

        .card h3 {
            margin-bottom: 1rem;
            color: #333;
            font-size: 1.1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .module-link {
            color: #2196f3;
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: normal;
        }

        .module-link:hover {
            text-decoration: underline;
        }

        /* List Components */
        .list-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 16px 12px 16px;
            gap: 12px;
            border-bottom: 1px solid rgba(0,0,0,0.06);
        }

        .search-filter {
            flex: 1;
            max-width: 320px;
        }

        .search-filter input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid rgba(0,0,0,0.12);
            border-radius: 8px;
            font-size: 0.9375rem;
            font-family: inherit;
            background: #fafafa;
            transition: all 0.15s ease;
        }

        .search-filter input:focus {
            outline: none;
            border-color: #007aff;
            background: #ffffff;
            box-shadow: 0 0 0 3px rgba(0,122,255,0.1);
        }

        .search-filter input::placeholder {
            color: #86868b;
        }

        .sortable-header {
            cursor: pointer;
            user-select: none;
            position: relative;
            padding-right: 20px;
        }

        .sortable-header:hover {
            background: #e8f4fd;
        }

        .sort-indicator {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.7rem;
            color: #666;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .sortable-header:hover .sort-indicator {
            opacity: 0.5;
        }

        .sortable-header.active .sort-indicator {
            opacity: 1;
            color: #2196f3;
        }

        .data-table {
            width: auto;
            border-collapse: collapse;
            margin: 0;
        }

        .data-table th,
        .data-table td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid rgba(0,0,0,0.06);
            font-size: 0.9375rem;
        }

        .data-table thead {
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .data-table th {
            background: #fafafa;
            font-weight: 600;
            font-size: 0.8125rem;
            color: #86868b;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            padding: 16px 16px;
            border-bottom: 1px solid rgba(0,0,0,0.08);
        }

        .data-table td {
            color: #1d1d1f;
            line-height: 1.4;
        }

        .data-table tbody tr {
            transition: background-color 0.1s ease;
        }

        .data-table tbody tr:hover {
            background: rgba(0,0,0,0.02);
        }

        .data-table tbody tr:last-child td {
            border-bottom: none;
        }

        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-active {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .status-inactive {
            background: #fff3e0;
            color: #ef6c00;
        }

        .pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            border-top: 1px solid rgba(0,0,0,0.06);
            background: #fafafa;
            border-radius: 0 0 12px 12px;
            align-self: stretch;
        }

        .pagination-info {
            color: #86868b;
            font-size: 0.8125rem;
            font-weight: 500;
        }

        .pagination-controls {
            display: flex;
            gap: 8px;
        }

        .pagination-btn {
            padding: 6px 14px;
            border: 1px solid rgba(0,0,0,0.12);
            background: #ffffff;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            color: #1d1d1f;
            font-family: inherit;
            transition: all 0.15s ease;
        }

        .pagination-btn:hover:not(:disabled) {
            background: #f5f5f7;
            border-color: rgba(0,0,0,0.18);
        }

        .pagination-btn:active:not(:disabled) {
            transform: scale(0.98);
        }

        .pagination-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        /* Entity View Layout - Apple-inspired design */
        .entity-view-header {
            margin-bottom: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .entity-view-title {
            font-size: 2rem;
            font-weight: 600;
            letter-spacing: -0.02em;
            color: #1d1d1f;
            margin: 0;
            padding: 0;
        }

        .primary-action-btn {
            display: inline-flex;
            align-items: center;
            padding: 8px 16px;
            background: #007aff;
            color: #ffffff;
            border: none;
            border-radius: 8px;
            font-size: 0.9375rem;
            font-weight: 500;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.15s ease;
            box-shadow: 0 1px 3px rgba(0,122,255,0.2);
        }

        .primary-action-btn:hover {
            background: #0051d5;
            box-shadow: 0 2px 8px rgba(0,122,255,0.3);
        }

        .primary-action-btn:active {
            transform: scale(0.98);
        }

        .section-with-sidebar {
            display: flex;
            gap: 20px;
            min-height: calc(100vh - 200px);
        }

        .column-list-sidebar {
            min-width: 280px;
            width: fit-content;
            max-width: 400px;
            background: #ffffff;
            border-radius: 12px;
            padding: 0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04), 0 4px 16px rgba(0,0,0,0.06);
            align-self: stretch;
            display: flex;
            flex-direction: column;
        }

        .column-list-header {
            padding: 20px 8px 12px 8px;
            border-bottom: 1px solid rgba(0,0,0,0.06);
            display: flex;
            align-items: center;
        }

        .column-list-header-labels {
            display: flex;
            align-items: center;
            width: 100%;
            padding: 0 8px;
        }

        .column-list-header-labels .drag-spacer {
            width: 28px; /* drag handle 20px + margin 8px */
            flex-shrink: 0;
        }

        .column-list-header-labels .column-label {
            width: 24px; /* checkbox 16px + margin 8px */
            font-size: 0.8125rem;
            font-weight: 600;
            color: #86868b;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            flex-shrink: 0;
        }

        .column-list-header-labels .name-spacer {
            flex: 1;
        }

        .column-list-header-labels .sort-label {
            width: 32px;
            text-align: center;
            font-size: 0.8125rem;
            font-weight: 600;
            color: #86868b;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            flex-shrink: 0;
        }

        .column-list-header-labels .filter-label {
            width: 80px;
            text-align: center;
            font-size: 0.8125rem;
            font-weight: 600;
            color: #86868b;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            flex-shrink: 0;
            margin-left: 8px;
        }

        .column-list {
            list-style: none;
            padding: 8px 8px 16px 8px;
            margin: 0;
            overflow-y: auto;
            flex: 1;
        }

        .column-item {
            display: flex;
            align-items: center;
            padding: 10px 8px;
            margin-bottom: 0;
            background: transparent;
            border: none;
            transition: all 0.15s ease;
            cursor: pointer;
        }

        .column-item:hover {
            background: rgba(0,0,0,0.04);
        }

        .column-item.selected {
            background: rgba(0,122,255,0.1);
        }

        .column-item.dragging {
            opacity: 0.4;
            cursor: grabbing;
        }

        .column-item.drag-over-top {
            box-shadow: inset 0 2px 0 0 #007aff;
        }

        .column-item.drag-over-bottom {
            box-shadow: inset 0 -2px 0 0 #007aff;
        }

        .drag-handle {
            width: 20px;
            height: 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: grab;
            margin-right: 8px;
            color: #86868b;
            user-select: none;
            transition: color 0.15s ease;
        }

        .column-item:hover .drag-handle {
            color: #1d1d1f;
        }

        .drag-handle:active {
            cursor: grabbing;
        }

        .drag-handle::before {
            content: '⋮⋮';
            font-size: 0.875rem;
            letter-spacing: -2px;
            line-height: 1;
        }

        .column-checkbox {
            margin: 0 8px 0 0;
            cursor: pointer;
            width: 16px;
            height: 16px;
            accent-color: #007aff;
        }

        .column-name {
            flex: 1;
            font-size: 0.9375rem;
            font-weight: 400;
            color: #1d1d1f;
            cursor: pointer;
            user-select: none;
            line-height: 1.4;
            white-space: nowrap;
            min-width: 0;
        }

        .sort-control {
            width: 32px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border-radius: 6px;
            color: #86868b;
            font-size: 0.875rem;
            transition: all 0.15s ease;
            flex-shrink: 0;
        }

        .sort-control:hover {
            background: rgba(0,0,0,0.06);
        }

        .sort-control.active {
            color: #007aff;
            background: rgba(0,122,255,0.08);
        }

        .filter-display {
            width: 80px;
            margin-left: 8px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .filter-add-btn {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border-radius: 4px;
            color: #86868b;
            font-size: 1rem;
            transition: all 0.15s ease;
            border: none;
            background: transparent;
            padding: 0;
        }

        .filter-add-btn:hover {
            background: rgba(0,0,0,0.06);
            color: #1d1d1f;
        }

        .filter-value-chip {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 6px;
            background: rgba(0,122,255,0.1);
            border: 1px solid rgba(0,122,255,0.2);
            border-radius: 4px;
            font-size: 0.6875rem;
            color: #007aff;
            font-family: 'SF Mono', Monaco, monospace;
            cursor: pointer;
            transition: all 0.15s ease;
            max-width: 76px;
        }

        .filter-value-chip:hover {
            background: rgba(0,122,255,0.15);
        }

        .filter-value-text {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .filter-value-remove {
            cursor: pointer;
            opacity: 0.6;
            transition: opacity 0.15s ease;
            font-size: 0.75rem;
            line-height: 1;
            flex-shrink: 0;
        }

        .filter-value-remove:hover {
            opacity: 1;
        }

        .section-main-content {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
        }

        .section-main-content .card {
            background: #ffffff;
            border-radius: 12px;
            padding: 0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04), 0 4px 16px rgba(0,0,0,0.06);
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        /* Filter Modal */
        .filter-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.4);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(8px);
        }

        .filter-modal-overlay.active {
            display: flex;
        }

        .filter-modal {
            background: #ffffff;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 480px;
            padding: 0;
            animation: modalSlideIn 0.2s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: scale(0.95) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .filter-modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid rgba(0,0,0,0.06);
        }

        .filter-modal-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1d1d1f;
            margin: 0;
        }

        .filter-modal-body {
            padding: 24px;
        }

        .filter-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid rgba(0,0,0,0.12);
            border-radius: 8px;
            font-size: 0.9375rem;
            font-family: 'SF Mono', Monaco, 'Courier New', monospace;
            background: #fafafa;
            transition: all 0.15s ease;
            margin-bottom: 12px;
        }

        .filter-input:focus {
            outline: none;
            border-color: #007aff;
            background: #ffffff;
            box-shadow: 0 0 0 3px rgba(0,122,255,0.1);
        }

        .filter-hint {
            font-size: 0.8125rem;
            color: #86868b;
            line-height: 1.5;
            white-space: pre-wrap;
            margin: 0;
        }

        .filter-error {
            font-size: 0.8125rem;
            color: #ff3b30;
            margin-top: 8px;
            display: none;
        }

        .filter-error.visible {
            display: block;
        }

        /* Add Root Modal */
        .add-root-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.4);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(8px);
        }

        .add-root-modal-overlay.active {
            display: flex;
        }

        .add-root-modal {
            background: #ffffff;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 540px;
            padding: 0;
            animation: modalSlideIn 0.2s ease;
        }

        .add-root-modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid rgba(0,0,0,0.08);
        }

        .add-root-modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1d1d1f;
            margin: 0;
        }

        .add-root-modal-body {
            padding: 24px;
        }

        .add-root-form-group {
            margin-bottom: 20px;
        }

        .add-root-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: #1d1d1f;
            margin-bottom: 8px;
        }

        .add-root-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid rgba(0,0,0,0.12);
            border-radius: 8px;
            font-size: 0.9375rem;
            font-family: -apple-system, BlinkMacSystemFont, 'SF Mono', 'Monaco', 'Courier New', monospace;
            background: #fafafa;
            transition: all 0.15s ease;
        }

        .add-root-input:focus {
            outline: none;
            border-color: #007aff;
            background: #ffffff;
            box-shadow: 0 0 0 3px rgba(0,122,255,0.1);
        }

        .add-root-hint {
            font-size: 0.8125rem;
            color: #86868b;
            margin-top: 8px;
        }

        .add-root-error {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            padding: 12px;
            background: #fff5f5;
            border: 1px solid rgba(255,59,48,0.2);
            border-radius: 8px;
            margin-top: 12px;
            display: none;
        }

        .add-root-error.visible {
            display: flex;
        }

        .add-root-error-icon {
            color: #ff3b30;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .add-root-error-text {
            font-size: 0.875rem;
            color: #ff3b30;
            line-height: 1.4;
        }

        .add-root-success {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px;
            background: #f0fdf4;
            border: 1px solid rgba(34,197,94,0.2);
            border-radius: 8px;
            margin-top: 12px;
            display: none;
        }

        .add-root-success.visible {
            display: flex;
        }

        .add-root-success-icon {
            color: #22c55e;
            flex-shrink: 0;
        }

        .add-root-success-text {
            font-size: 0.875rem;
            color: #15803d;
            line-height: 1.4;
        }

        .add-root-modal-footer {
            padding: 16px 24px;
            border-top: 1px solid rgba(0,0,0,0.08);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .add-root-btn-cancel {
            padding: 8px 16px;
            border: 1px solid rgba(0,0,0,0.12);
            background: #ffffff;
            border-radius: 8px;
            font-size: 0.9375rem;
            font-weight: 500;
            color: #1d1d1f;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .add-root-btn-cancel:hover {
            background: #f5f5f7;
            border-color: rgba(0,0,0,0.18);
        }

        .add-root-btn-submit {
            padding: 8px 16px;
            background: #007aff;
            color: #ffffff;
            border: none;
            border-radius: 8px;
            font-size: 0.9375rem;
            font-weight: 500;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.15s ease;
            box-shadow: 0 1px 3px rgba(0,122,255,0.2);
        }

        .add-root-btn-submit:hover:not(:disabled) {
            background: #0051d5;
            box-shadow: 0 2px 8px rgba(0,122,255,0.3);
        }

        .add-root-btn-submit:active:not(:disabled) {
            transform: scale(0.98);
        }

        .add-root-btn-submit:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .filter-modal-footer {
            padding: 16px 24px;
            border-top: 1px solid rgba(0,0,0,0.06);
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }

        .modal-btn {
            padding: 8px 16px;
            border: 1px solid rgba(0,0,0,0.12);
            background: #ffffff;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            font-family: inherit;
            transition: all 0.15s ease;
        }

        .modal-btn:hover {
            background: #f5f5f7;
            border-color: rgba(0,0,0,0.18);
        }

        .modal-btn.primary {
            background: #007aff;
            border-color: #007aff;
            color: #ffffff;
        }

        .modal-btn.primary:hover {
            background: #0051d5;
            border-color: #0051d5;
        }

        .modal-btn:active {
            transform: scale(0.97);
        }

        .alert-item {
            padding: 0.75rem 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .alert-item:last-child {
            border-bottom: none;
        }

        .alert-severity {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            margin-right: 0.5rem;
        }

        .severity-high {
            background: #ffebee;
            color: #c62828;
        }

        .severity-medium {
            background: #fff3e0;
            color: #ef6c00;
        }

        .severity-low {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .loading {
            color: #666;
            font-style: italic;
        }

        /* Active Scans Section */
        .active-scans-container {
            margin-bottom: 1.5rem;
        }

        .scan-card {
            background: #ffffff;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04), 0 4px 16px rgba(0,0,0,0.06);
            transition: all 0.15s ease;
        }

        .scan-card:hover {
            box-shadow: 0 2px 6px rgba(0,0,0,0.06), 0 6px 20px rgba(0,0,0,0.08);
        }

        .scan-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
            gap: 16px;
        }

        .scan-title {
            font-size: 1rem;
            font-weight: 500;
            color: #1d1d1f;
            font-family: 'SF Mono', Monaco, monospace;
            flex: 1;
        }

        .scan-progress-section {
            margin-bottom: 12px;
        }

        .scan-progress-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 0.875rem;
            color: #86868b;
        }

        .scan-progress-bar-container {
            width: 100%;
            height: 6px;
            background: rgba(0,0,0,0.06);
            border-radius: 3px;
            overflow: hidden;
        }

        .scan-progress-bar {
            height: 100%;
            background: #007aff;
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .scan-stats {
            font-size: 0.9375rem;
            color: #1d1d1f;
            margin-top: 8px;
        }

        .scan-details-toggle {
            margin-top: 12px;
            padding: 6px 12px;
            border: none;
            background: none;
            color: #007aff;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .scan-details-toggle:hover {
            background: rgba(0,122,255,0.08);
        }

        .scan-details-toggle .chevron {
            transition: transform 0.2s ease;
            font-size: 0.75rem;
        }

        .scan-details-toggle.expanded .chevron {
            transform: rotate(180deg);
        }

        .scan-thread-details {
            margin-top: 12px;
            padding: 12px;
            background: #fafafa;
            border-radius: 8px;
            display: none;
        }

        .scan-thread-details.visible {
            display: block;
        }

        .scan-thread-item {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(0,0,0,0.06);
            font-size: 0.875rem;
        }

        .scan-thread-item:last-child {
            border-bottom: none;
        }

        .scan-thread-status {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            margin-right: 12px;
            width: 80px;
            flex-shrink: 0;
            text-align: center;
        }

        .scan-thread-status.scanning,
        .scan-thread-status.hashing,
        .scan-thread-status.validating {
            background: rgba(52,199,89,0.15);
            color: #34c759;
        }

        .scan-thread-status.idle {
            background: rgba(134,134,139,0.15);
            color: #86868b;
        }

        .scan-thread-file {
            flex: 1;
            color: #1d1d1f;
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 0.8125rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .no-scans-state {
            background: #ffffff;
            border-radius: 12px;
            padding: 32px;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04), 0 4px 16px rgba(0,0,0,0.06);
        }

        .no-scans-state h3 {
            margin-bottom: 16px;
        }

        .start-scan-btn {
            padding: 10px 20px;
            border: none;
            background: #007aff;
            color: #ffffff;
            border-radius: 8px;
            font-size: 0.9375rem;
            font-weight: 500;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.15s ease;
        }

        .start-scan-btn:hover {
            background: #0051d5;
        }

        .start-scan-btn:active {
            transform: scale(0.98);
        }

        .scan-stop-btn {
            padding: 10px 20px;
            border: none;
            background: #ff3b30;
            color: #ffffff;
            border-radius: 8px;
            font-size: 0.9375rem;
            font-weight: 500;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.15s ease;
        }

        .scan-stop-btn:hover {
            background: #e32b1f;
        }

        .scan-stop-btn:active {
            transform: scale(0.98);
        }

        .scan-stop-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .scan-stop-btn:disabled:hover {
            background: #ff3b30;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .hamburger {
                display: block;
            }

            .sidebar {
                position: fixed;
                left: -250px;
                top: 80px;
                height: calc(100vh - 80px);
                z-index: 1000;
                transition: left 0.3s ease;
            }

            .sidebar.open {
                left: 0;
            }

            .main-content {
                padding: 1rem;
            }

            .overview-modules {
                gap: 1rem;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <h1 class="header-title">FsPulse</h1>
    </header>

    <div class="container">
        <nav class="sidebar" id="sidebar">
            <!-- Insights Section -->
            <button class="nav-item active" onclick="showSection('overview')">
                <svg class="nav-icon" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" />
                </svg>
                <span class="nav-label">Overview</span>
            </button>
            <button class="nav-item" onclick="showSection('alerts')">
                <svg class="nav-icon" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                </svg>
                <span class="nav-label">Alerts</span>
            </button>
            <button class="nav-item" onclick="showSection('activity')">
                <svg class="nav-icon" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z" />
                </svg>
                <span class="nav-label">Activity</span>
            </button>
            <button class="nav-item" onclick="showSection('manage-roots')">
                <svg class="nav-icon" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M2 6a2 2 0 012-2h5l2 2h5a2 2 0 012 2v6a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" />
                    <path d="M10 9a1 1 0 011 1v3a1 1 0 11-2 0v-3a1 1 0 011-1z" />
                    <path d="M10 8a1 1 0 100-2 1 1 0 000 2z" />
                </svg>
                <span class="nav-label">Manage Roots</span>
            </button>

            <div class="nav-divider"></div>

            <!-- Data Explorer Section -->
            <div class="nav-section-header">
                <span class="nav-label">Data Explorer</span>
            </div>
            <button class="nav-item" onclick="showSection('roots')">
                <svg class="nav-icon" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M2 6a2 2 0 012-2h5l2 2h5a2 2 0 012 2v6a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" />
                </svg>
                <span class="nav-label">Roots</span>
            </button>
            <button class="nav-item" onclick="showSection('scans')">
                <svg class="nav-icon" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M9 9a2 2 0 114 0 2 2 0 01-4 0z" />
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-13a4 4 0 00-3.446 6.032l-2.261 2.26a1 1 0 101.414 1.415l2.261-2.261A4 4 0 1011 5z" clip-rule="evenodd" />
                </svg>
                <span class="nav-label">Scans</span>
            </button>
            <button class="nav-item" onclick="showSection('items')">
                <svg class="nav-icon" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd" />
                </svg>
                <span class="nav-label">Items</span>
            </button>
            <button class="nav-item" onclick="showSection('changes')">
                <svg class="nav-icon" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" />
                </svg>
                <span class="nav-label">Changes</span>
            </button>

            <div class="nav-divider"></div>

            <!-- Configuration Section -->
            <button class="nav-item" onclick="showSection('settings')">
                <svg class="nav-icon" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" />
                </svg>
                <span class="nav-label">Settings</span>
            </button>
        </nav>

        <main class="main-content">
            <div id="overview-section">
                <h2 style="margin-bottom: 1.5rem;">Overview</h2>

                <!-- Active Scan Section -->
                <div class="active-scans-container">
                    <div id="active-scans-content">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>

                <div class="overview-modules">
                    <div class="card">
                        <h3>
                            📈 System Status
                        </h3>
                        <div id="status-summary" class="loading">Loading status...</div>
                    </div>

                    <div class="card">
                        <h3>
                            🚨 Active Alerts
                            <a href="#" class="module-link" onclick="showSection('alerts')">View All →</a>
                        </h3>
                        <div id="alerts-summary" class="loading">Loading alerts...</div>
                    </div>

                    <div class="card">
                        <h3>
                            📊 Current Activity
                            <a href="#" class="module-link" onclick="showSection('activity')">View All →</a>
                        </h3>
                        <div id="activity-summary" class="loading">Loading activity...</div>
                    </div>

                    <div class="card">
                        <h3>
                            📋 Recent Activity
                            <a href="#" class="module-link" onclick="showSection('activity')">View All →</a>
                        </h3>
                        <div id="recent-activity" class="loading">Loading recent activity...</div>
                    </div>
                </div>
            </div>

            <!-- Insights Sections -->
            <div id="alerts-section" style="display: none;">
                <h2>Active Alerts</h2>
                <p>Detailed alerts management coming soon...</p>
            </div>

            <div id="activity-section" style="display: none;">
                <h2>Activity Monitor</h2>
                <p>Detailed activity monitoring coming soon...</p>
            </div>

            <!-- Manage Roots Section -->
            <div id="manage-roots-section" style="display: none;">
                <div class="entity-view-header">
                    <h1 class="entity-view-title">Manage Roots</h1>
                    <button class="primary-action-btn" onclick="showAddRootModal()">
                        <svg width="16" height="16" viewBox="0 0 20 20" fill="currentColor" style="margin-right: 6px;">
                            <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                        </svg>
                        Add Root
                    </button>
                </div>

                <div class="card">
                    <table class="data-table">
                        <tbody id="manage-roots-table-body">
                            <tr>
                                <td style="text-align: center; color: #86868b; padding: 2rem;">
                                    Loading roots...
                                </td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="pagination">
                        <div class="pagination-info" id="manage-roots-pagination-info">
                            Showing 0 - 0 of 0 roots
                        </div>
                        <div class="pagination-controls">
                            <button class="pagination-btn" id="manage-roots-prev-btn" onclick="changeManageRootsPage(-1)">Previous</button>
                            <button class="pagination-btn" id="manage-roots-next-btn" onclick="changeManageRootsPage(1)">Next</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Data Management Sections -->
            <div id="roots-section" style="display: none;">
                <div class="entity-view-header">
                    <h1 class="entity-view-title">Data Explorer - Roots</h1>
                </div>

                <div class="section-with-sidebar">
                    <!-- Column List Sidebar -->
                    <aside class="column-list-sidebar">
                        <div class="column-list-header">
                            <div class="column-list-header-labels">
                                <div class="drag-spacer"></div>
                                <div class="column-label">Column</div>
                                <div class="name-spacer"></div>
                                <div class="sort-label">Sort</div>
                                <div class="filter-label">Filter</div>
                            </div>
                        </div>
                        <ul class="column-list" id="roots-column-list">
                            <li style="text-align: center; color: #86868b; padding: 1rem; font-size: 0.875rem;">Loading columns...</li>
                        </ul>
                    </aside>

                    <!-- Main Content Area -->
                    <div class="section-main-content">
                        <div class="card">
                            <table class="data-table">
                                <thead>
                                    <tr id="roots-table-header">
                                        <th colspan="2">Loading...</th>
                                    </tr>
                                </thead>
                                <tbody id="roots-table-body">
                                    <tr><td colspan="2">Loading...</td></tr>
                                </tbody>
                            </table>

                            <div class="pagination">
                                <div class="pagination-info" id="roots-pagination-info">
                                    Showing 0 - 0 of 0 roots
                                </div>
                                <div class="pagination-controls">
                                    <button class="pagination-btn" id="roots-prev-btn" onclick="changeRootsPage(-1)">Previous</button>
                                    <button class="pagination-btn" id="roots-next-btn" onclick="changeRootsPage(1)">Next</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="scans-section" style="display: none;">
                <div class="entity-view-header">
                    <h1 class="entity-view-title">Data Explorer - Scans</h1>
                </div>

                <div class="section-with-sidebar">
                    <!-- Column List Sidebar -->
                    <aside class="column-list-sidebar">
                        <div class="column-list-header">
                            <div class="column-list-header-labels">
                                <div class="drag-spacer"></div>
                                <div class="column-label">Column</div>
                                <div class="name-spacer"></div>
                                <div class="sort-label">Sort</div>
                                <div class="filter-label">Filter</div>
                            </div>
                        </div>
                        <ul class="column-list" id="scans-column-list">
                            <li style="text-align: center; color: #86868b; padding: 1rem; font-size: 0.875rem;">Loading columns...</li>
                        </ul>
                    </aside>

                    <!-- Main Content Area -->
                    <div class="section-main-content">
                        <div class="card">
                            <table class="data-table">
                                <thead>
                                    <tr id="scans-table-header">
                                        <th colspan="9">Loading...</th>
                                    </tr>
                                </thead>
                                <tbody id="scans-table-body">
                                    <tr><td colspan="9">Loading...</td></tr>
                                </tbody>
                            </table>

                            <div class="pagination">
                                <div class="pagination-info" id="scans-pagination-info">
                                    Showing 0 - 0 of 0 scans
                                </div>
                                <div class="pagination-controls">
                                    <button class="pagination-btn" id="scans-prev-btn" onclick="changeScansPage(-1)">Previous</button>
                                    <button class="pagination-btn" id="scans-next-btn" onclick="changeScansPage(1)">Next</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="items-section" style="display: none;">
                <div class="entity-view-header">
                    <h1 class="entity-view-title">Data Explorer - Items</h1>
                </div>

                <div class="section-with-sidebar">
                    <!-- Column List Sidebar -->
                    <aside class="column-list-sidebar">
                        <div class="column-list-header">
                            <div class="column-list-header-labels">
                                <div class="drag-spacer"></div>
                                <div class="column-label">Column</div>
                                <div class="name-spacer"></div>
                                <div class="sort-label">Sort</div>
                                <div class="filter-label">Filter</div>
                            </div>
                        </div>
                        <ul class="column-list" id="items-column-list">
                            <li style="text-align: center; color: #86868b; padding: 1rem; font-size: 0.875rem;">Loading columns...</li>
                        </ul>
                    </aside>

                    <!-- Main Content Area -->
                    <div class="section-main-content">
                        <div class="card">
                            <table class="data-table">
                                <thead>
                                    <tr id="items-table-header">
                                        <th colspan="5">Loading...</th>
                                    </tr>
                                </thead>
                                <tbody id="items-table-body">
                                    <tr><td colspan="5">Loading...</td></tr>
                                </tbody>
                            </table>

                            <div class="pagination">
                                <div class="pagination-info" id="items-pagination-info">
                                    Showing 0 - 0 of 0 items
                                </div>
                                <div class="pagination-controls">
                                    <button class="pagination-btn" id="items-prev-btn" onclick="changeItemsPage(-1)">Previous</button>
                                    <button class="pagination-btn" id="items-next-btn" onclick="changeItemsPage(1)">Next</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="changes-section" style="display: none;">
                <div class="entity-view-header">
                    <h1 class="entity-view-title">Data Explorer - Changes</h1>
                </div>

                <div class="section-with-sidebar">
                    <!-- Column List Sidebar -->
                    <aside class="column-list-sidebar">
                        <div class="column-list-header">
                            <div class="column-list-header-labels">
                                <div class="drag-spacer"></div>
                                <div class="column-label">Column</div>
                                <div class="name-spacer"></div>
                                <div class="sort-label">Sort</div>
                                <div class="filter-label">Filter</div>
                            </div>
                        </div>
                        <ul class="column-list" id="changes-column-list">
                            <li style="text-align: center; color: #86868b; padding: 1rem; font-size: 0.875rem;">Loading columns...</li>
                        </ul>
                    </aside>

                    <!-- Main Content Area -->
                    <div class="section-main-content">
                        <div class="card">
                            <table class="data-table">
                                <thead>
                                    <tr id="changes-table-header">
                                        <th colspan="5">Loading...</th>
                                    </tr>
                                </thead>
                                <tbody id="changes-table-body">
                                    <tr><td colspan="5">Loading...</td></tr>
                                </tbody>
                            </table>

                            <div class="pagination">
                                <div class="pagination-info" id="changes-pagination-info">
                                    Showing 0 - 0 of 0 changes
                                </div>
                                <div class="pagination-controls">
                                    <button class="pagination-btn" id="changes-prev-btn" onclick="changeChangesPage(-1)">Previous</button>
                                    <button class="pagination-btn" id="changes-next-btn" onclick="changeChangesPage(1)">Next</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Configuration Section -->
            <div id="settings-section" style="display: none;">
                <h2>Settings</h2>
                <p>System configuration and preferences...</p>
            </div>
        </main>
    </div>

    <!-- Filter Modals -->
    <!-- Items Filter Modal -->
    <div class="filter-modal-overlay" id="items-filter-modal-overlay" onclick="closeItemsFilterModal()">
        <div class="filter-modal" onclick="event.stopPropagation()">
            <div class="filter-modal-header">
                <h2 class="filter-modal-title" id="items-filter-modal-title">Filter Column</h2>
            </div>
            <div class="filter-modal-body">
                <input type="text" class="filter-input" id="items-filter-input" placeholder="Enter filter value...">
                <p class="filter-hint" id="items-filter-hint">Filter syntax hint will appear here</p>
                <p class="filter-error" id="items-filter-error">Error message</p>
            </div>
            <div class="filter-modal-footer">
                <button class="modal-btn" onclick="closeItemsFilterModal()">Cancel</button>
                <button class="modal-btn primary" onclick="saveItemsFilter()">Apply Filter</button>
            </div>
        </div>
    </div>

    <!-- Roots Filter Modal -->
    <div class="filter-modal-overlay" id="roots-filter-modal-overlay" onclick="closeRootsFilterModal()">
        <div class="filter-modal" onclick="event.stopPropagation()">
            <div class="filter-modal-header">
                <h2 class="filter-modal-title" id="roots-filter-modal-title">Filter Column</h2>
            </div>
            <div class="filter-modal-body">
                <input type="text" class="filter-input" id="roots-filter-input" placeholder="Enter filter value...">
                <p class="filter-hint" id="roots-filter-hint">Filter syntax hint will appear here</p>
                <p class="filter-error" id="roots-filter-error">Error message</p>
            </div>
            <div class="filter-modal-footer">
                <button class="modal-btn" onclick="closeRootsFilterModal()">Cancel</button>
                <button class="modal-btn primary" onclick="saveRootsFilter()">Apply Filter</button>
            </div>
        </div>
    </div>

    <!-- Scans Filter Modal -->
    <div class="filter-modal-overlay" id="scans-filter-modal-overlay" onclick="closeScansFilterModal()">
        <div class="filter-modal" onclick="event.stopPropagation()">
            <div class="filter-modal-header">
                <h2 class="filter-modal-title" id="scans-filter-modal-title">Filter Column</h2>
            </div>
            <div class="filter-modal-body">
                <input type="text" class="filter-input" id="scans-filter-input" placeholder="Enter filter value...">
                <p class="filter-hint" id="scans-filter-hint">Filter syntax hint will appear here</p>
                <p class="filter-error" id="scans-filter-error">Error message</p>
            </div>
            <div class="filter-modal-footer">
                <button class="modal-btn" onclick="closeScansFilterModal()">Cancel</button>
                <button class="modal-btn primary" onclick="saveScansFilter()">Apply Filter</button>
            </div>
        </div>
    </div>

    <!-- Changes Filter Modal -->
    <div class="filter-modal-overlay" id="changes-filter-modal-overlay" onclick="closeChangesFilterModal()">
        <div class="filter-modal" onclick="event.stopPropagation()">
            <div class="filter-modal-header">
                <h2 class="filter-modal-title" id="changes-filter-modal-title">Filter Column</h2>
            </div>
            <div class="filter-modal-body">
                <input type="text" class="filter-input" id="changes-filter-input" placeholder="Enter filter value...">
                <p class="filter-hint" id="changes-filter-hint">Filter syntax hint will appear here</p>
                <p class="filter-error" id="changes-filter-error">Error message</p>
            </div>
            <div class="filter-modal-footer">
                <button class="modal-btn" onclick="closeChangesFilterModal()">Cancel</button>
                <button class="modal-btn primary" onclick="saveChangesFilter()">Apply Filter</button>
            </div>
        </div>
    </div>

    <!-- Start New Scan Modal -->
    <div class="filter-modal-overlay" id="start-scan-modal-overlay" onclick="closeStartScanModal()">
        <div class="filter-modal" onclick="event.stopPropagation()">
            <div class="filter-modal-header">
                <h2 class="filter-modal-title">Choose Root to Scan</h2>
            </div>
            <div class="filter-modal-body">
                <select id="scan-root-select" class="filter-input" style="font-family: inherit; margin-bottom: 20px;" onchange="handleRootSelection()">
                    <option value="">Loading roots...</option>
                </select>

                <!-- Scan Options (always shown) -->
                <div id="scan-options">
                    <div style="margin-bottom: 16px;">
                        <label style="font-size: 0.875rem; font-weight: 600; color: #1d1d1f; display: block; margin-bottom: 8px;">Hash:</label>
                        <label style="display: inline-flex; align-items: center; margin-right: 16px; cursor: pointer;">
                            <input type="radio" name="hash-mode" value="None" style="margin-right: 6px;">
                            <span style="font-size: 0.875rem;">None</span>
                        </label>
                        <label style="display: inline-flex; align-items: center; margin-right: 16px; cursor: pointer;">
                            <input type="radio" name="hash-mode" value="New" style="margin-right: 6px;">
                            <span style="font-size: 0.875rem;">New or Changed</span>
                        </label>
                        <label style="display: inline-flex; align-items: center; cursor: pointer;">
                            <input type="radio" name="hash-mode" value="All" checked style="margin-right: 6px;">
                            <span style="font-size: 0.875rem;">All</span>
                        </label>
                    </div>

                    <div>
                        <label style="font-size: 0.875rem; font-weight: 600; color: #1d1d1f; display: block; margin-bottom: 8px;">Validate:</label>
                        <label style="display: inline-flex; align-items: center; margin-right: 16px; cursor: pointer;">
                            <input type="radio" name="validate-mode" value="None" style="margin-right: 6px;">
                            <span style="font-size: 0.875rem;">None</span>
                        </label>
                        <label style="display: inline-flex; align-items: center; margin-right: 16px; cursor: pointer;">
                            <input type="radio" name="validate-mode" value="New" checked style="margin-right: 6px;">
                            <span style="font-size: 0.875rem;">New or Changed</span>
                        </label>
                        <label style="display: inline-flex; align-items: center; cursor: pointer;">
                            <input type="radio" name="validate-mode" value="All" style="margin-right: 6px;">
                            <span style="font-size: 0.875rem;">All</span>
                        </label>
                    </div>
                </div>

                <p class="filter-error" id="scan-error">Error message</p>
            </div>
            <div class="filter-modal-footer">
                <button class="modal-btn" onclick="closeStartScanModal()">Cancel</button>
                <button class="modal-btn primary" id="scan-action-btn" onclick="startScan()">Start Scan</button>
            </div>
        </div>
    </div>

    <!-- Add Root Modal -->
    <div class="add-root-modal-overlay" id="add-root-modal-overlay" onclick="hideAddRootModal()">
        <div class="add-root-modal" onclick="event.stopPropagation()">
            <div class="add-root-modal-header">
                <h2 class="add-root-modal-title">Add New Root</h2>
            </div>
            <div class="add-root-modal-body">
                <div class="add-root-form-group">
                    <label class="add-root-label" for="add-root-path-input">Root Path</label>
                    <input
                        type="text"
                        class="add-root-input"
                        id="add-root-path-input"
                        placeholder="/absolute/path/to/directory"
                        autocomplete="off"
                        spellcheck="false">
                    <p class="add-root-hint">Enter the absolute path to the directory you want to track</p>
                </div>

                <div class="add-root-error" id="add-root-error">
                    <svg class="add-root-error-icon" width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                    </svg>
                    <p class="add-root-error-text" id="add-root-error-text">Error message</p>
                </div>

                <div class="add-root-success" id="add-root-success">
                    <svg class="add-root-success-icon" width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                    </svg>
                    <p class="add-root-success-text" id="add-root-success-text">Root added successfully!</p>
                </div>
            </div>
            <div class="add-root-modal-footer">
                <button class="add-root-btn-cancel" onclick="hideAddRootModal()">Cancel</button>
                <button class="add-root-btn-submit" id="add-root-submit-btn" onclick="submitNewRoot()">Add Root</button>
            </div>
        </div>
    </div>

    <script>
        // Load dashboard data
        async function loadDashboardData() {
            try {
                // Load status
                const statusResponse = await fetch('/api/status');
                const statusData = await statusResponse.json();
                document.getElementById('status-summary').innerHTML = `
                    <div>Server: <strong>${statusData.server}</strong></div>
                    <div>Database: <strong>${statusData.database}</strong></div>
                    <div>Active Scans: <strong>${statusData.active_scans}</strong></div>
                `;

                // Load alerts
                const alertsResponse = await fetch('/api/alerts');
                const alertsData = await alertsResponse.json();
                const alertsHtml = alertsData.alerts.slice(0, 3).map(alert => `
                    <div class="alert-item">
                        <span class="alert-severity severity-${alert.severity}">${alert.severity}</span>
                        <div>${alert.message}</div>
                        <small style="color: #666;">${new Date(alert.timestamp).toLocaleString()}</small>
                    </div>
                `).join('');
                document.getElementById('alerts-summary').innerHTML = alertsHtml || '<div>No active alerts</div>';

                // Load activity
                const activityResponse = await fetch('/api/activity');
                const activityData = await activityResponse.json();
                const currentScans = activityData.current_scans;
                const activityHtml = currentScans.length > 0 ?
                    currentScans.map(scan => `
                        <div>Scanning: <strong>${scan.root_path}</strong></div>
                        <div>Progress: <strong>${scan.progress}%</strong> (${scan.files_scanned}/${scan.files_total} files)</div>
                    `).join('') :
                    '<div>No active scans</div>';
                document.getElementById('activity-summary').innerHTML = activityHtml;

                // Load recent activity
                const recentHtml = [
                    ...activityData.recent_scans.slice(0, 3).map(scan => `
                        <div class="alert-item">
                            <div>Completed scan: <strong>${scan.root_path}</strong></div>
                            <small style="color: #666;">
                                ${scan.files_scanned} files scanned in ${scan.duration_seconds}s
                                • ${new Date(scan.completed).toLocaleString()}
                            </small>
                        </div>
                    `),
                    ...activityData.recent_changes.slice(0, 2).map(change => `
                        <div class="alert-item">
                            <div>File ${change.change_type}: <strong>${change.file_path}</strong></div>
                            <small style="color: #666;">${new Date(change.timestamp).toLocaleString()}</small>
                        </div>
                    `)
                ].join('');
                document.getElementById('recent-activity').innerHTML = recentHtml || '<div>No recent activity</div>';

            } catch (error) {
                console.error('Failed to load dashboard data:', error);
                document.querySelectorAll('.loading').forEach(el => {
                    el.innerHTML = '<div style="color: #f44336;">Failed to load data</div>';
                });
            }
        }

        // =============================================================================
        // ScanManager - Manages active scans display and WebSocket updates
        // =============================================================================

        class ScanManager {
            constructor() {
                this.activeScans = new Map(); // scanId -> scan data
                this.ws = null; // Current WebSocket connection
                this.expandedScans = new Set(); // Track which scan details are expanded
                this.currentScanId = null;
                this.scanPhase = 1; // Track current phase (1=scanning, 2=sweeping, 3=analyzing)
                this.threadStates = new Map(); // Track individual thread states
                this.scanningCounts = { files: 0, directories: 0 }; // Track scanning progress
                this.phaseBreadcrumbs = []; // Track completed phases
                this.renderPending = false; // Track if a render is already scheduled
            }

            scheduleRender() {
                // Use requestAnimationFrame to batch renders and sync with browser paint cycle
                // This prevents render() from interfering with event handling while ensuring
                // all state updates are displayed accurately
                if (!this.renderPending) {
                    this.renderPending = true;
                    requestAnimationFrame(() => {
                        this.renderPending = false;
                        this.render();
                    });
                }
            }

            render() {
                const container = document.getElementById('active-scans-content');

                if (this.activeScans.size === 0) {
                    container.innerHTML = `
                        <div class="no-scans-state">
                            <h3 style="margin-bottom: 1rem; font-size: 1.1rem; color: #333;">No Active Scan</h3>
                            <button class="start-scan-btn" onclick="showStartScanModal()">+ Start New Scan</button>
                        </div>
                    `;
                    return;
                }

                // Remove "No Active Scan" UI if present
                const noScansState = container.querySelector('.no-scans-state');
                if (noScansState) {
                    noScansState.remove();
                }

                // Check if scan card already exists
                for (const [scanId, scan] of this.activeScans.entries()) {
                    let scanCard = document.getElementById(`scan-card-${scanId}`);

                    if (!scanCard) {
                        // Create the scan card structure once
                        scanCard = this.createScanCard(scanId, scan);
                        container.appendChild(scanCard);
                    }

                    // Update only the dynamic content
                    this.updateScanCard(scanId, scan);
                }
            }

            createScanCard(scanId, scan) {
                // Create the scan card DOM structure once - this stays in the DOM
                const card = document.createElement('div');
                card.className = 'scan-card';
                card.id = `scan-card-${scanId}`;

                card.innerHTML = `
                    <div class="scan-header">
                        <div class="scan-title">Scanning: ${scan.root_path}</div>
                        <button id="stop-btn-${scanId}" class="scan-stop-btn" style="display: none;">Stop</button>
                    </div>
                    <div id="breadcrumbs-${scanId}"></div>
                    <div class="scan-progress-section">
                        <div class="scan-progress-label">
                            <span id="phase-label-${scanId}"></span>
                            <span id="percentage-${scanId}"></span>
                        </div>
                        <div class="scan-progress-bar-container">
                            <div id="progress-bar-${scanId}" class="scan-progress-bar" style="width: 0%"></div>
                        </div>
                        <div id="stats-${scanId}" class="scan-stats"></div>
                    </div>
                    <button id="details-btn-${scanId}" class="scan-details-toggle" data-scan-id="${scanId}" style="display: none;">
                        <span>Details</span>
                        <span class="chevron">▼</span>
                    </button>
                    <div id="thread-details-${scanId}" class="scan-thread-details"></div>
                `;

                // Attach click handlers directly to the buttons
                const stopButton = card.querySelector(`#stop-btn-${scanId}`);
                stopButton.addEventListener('click', () => {
                    this.stopScan(scanId);
                });

                const detailsButton = card.querySelector(`#details-btn-${scanId}`);
                detailsButton.addEventListener('click', () => {
                    this.toggleDetails(scanId);
                });

                return card;
            }

            updateScanCard(scanId, scan) {
                // Update only the dynamic content - button stays untouched
                const phaseNames = ['Scanning Files', 'Tombstoning Deletes', 'Analyzing'];
                const phaseName = phaseNames[scan.phase - 1] || 'Processing';

                // Update breadcrumbs
                const breadcrumbsContainer = document.getElementById(`breadcrumbs-${scanId}`);
                if (this.phaseBreadcrumbs.length > 0) {
                    breadcrumbsContainer.innerHTML = `
                        <div style="margin-bottom: 12px;">
                            ${this.phaseBreadcrumbs.map(crumb => `
                                <div style="font-size: 0.875rem; color: #34c759; margin-bottom: 4px;">
                                    ✓ ${crumb}
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else {
                    breadcrumbsContainer.innerHTML = '';
                }

                // Update phase label and percentage
                document.getElementById(`phase-label-${scanId}`).textContent = `Phase ${scan.phase} of 3: ${phaseName}`;
                document.getElementById(`percentage-${scanId}`).textContent = `${scan.progress.percentage.toFixed(1)}%`;

                // Update progress bar
                document.getElementById(`progress-bar-${scanId}`).style.width = `${scan.progress.percentage}%`;

                // Update stats
                const statsContainer = document.getElementById(`stats-${scanId}`);
                if (scan.phase === 3) {
                    statsContainer.textContent = `${scan.progress.current.toLocaleString()} / ${scan.progress.total.toLocaleString()} files`;
                    statsContainer.style.color = '';
                } else if (scan.phase === 1) {
                    statsContainer.textContent = `Scanned ${this.scanningCounts.files.toLocaleString()} files in ${this.scanningCounts.directories.toLocaleString()} directories...`;
                    statsContainer.style.color = '#007aff';
                }

                // Update Stop button visibility and state
                const stopButton = document.getElementById(`stop-btn-${scanId}`);
                // Status is an object like {status: "running"}, check the status field
                const statusValue = scan.status?.status || 'running';

                if (statusValue === 'running') {
                    stopButton.style.display = 'inline-block';
                    stopButton.disabled = false;
                    stopButton.textContent = 'Stop';
                } else if (statusValue === 'cancelling') {
                    stopButton.style.display = 'inline-block';
                    stopButton.disabled = true;
                    stopButton.textContent = 'Stopping';
                } else if (statusValue === 'stopped') {
                    stopButton.style.display = 'inline-block';
                    stopButton.disabled = true;
                    stopButton.textContent = 'Stopped';
                } else if (statusValue === 'completed') {
                    // Check if we were in the middle of stopping (race condition)
                    if (stopButton.textContent === 'Stopping') {
                        // User clicked stop but scan completed anyway
                        stopButton.style.display = 'inline-block';
                        stopButton.disabled = true;
                        stopButton.textContent = 'Completed';
                    } else {
                        // Normal completion - hide button
                        stopButton.style.display = 'none';
                    }
                } else {
                    // error - hide button
                    stopButton.style.display = 'none';
                }

                // Show/hide and update button for phase 3
                const button = document.getElementById(`details-btn-${scanId}`);
                const threadDetailsContainer = document.getElementById(`thread-details-${scanId}`);

                if (scan.phase === 3) {
                    button.style.display = 'flex';

                    // Update button expanded state
                    const isExpanded = this.expandedScans.has(scanId);
                    button.className = `scan-details-toggle ${isExpanded ? 'expanded' : ''}`;
                    threadDetailsContainer.className = `scan-thread-details ${isExpanded ? 'visible' : ''}`;

                    // Update thread details content
                    if (scan.threads && scan.threads.length > 0) {
                        const threadsHtml = scan.threads.map(thread => {
                            let operation = 'idle';
                            let filePath = thread.current_file || '-';

                            if (thread.current_file) {
                                if (thread.current_file.startsWith('Hashing:')) {
                                    operation = 'hashing';
                                    filePath = thread.current_file.substring(9).trim();
                                } else if (thread.current_file.startsWith('Validating:')) {
                                    operation = 'validating';
                                    filePath = thread.current_file.substring(12).trim();
                                } else if (thread.status === 'active') {
                                    operation = 'scanning';
                                }
                            }

                            const statusLabels = {
                                'hashing': 'HASHING',
                                'validating': 'VALIDATING',
                                'scanning': 'SCANNING',
                                'idle': 'IDLE'
                            };

                            return `
                                <div class="scan-thread-item">
                                    <span class="scan-thread-status ${operation}">${statusLabels[operation]}</span>
                                    <span class="scan-thread-file">${filePath}</span>
                                </div>
                            `;
                        }).join('');
                        threadDetailsContainer.innerHTML = threadsHtml;
                    } else {
                        threadDetailsContainer.innerHTML = '<div style="padding: 12px; color: #86868b; font-style: italic;">Waiting for thread activity...</div>';
                    }
                } else {
                    button.style.display = 'none';
                    threadDetailsContainer.innerHTML = '';
                }
            }

            renderScan(scan) {
                const isExpanded = this.expandedScans.has(scan.scan_id);
                const phaseNames = ['Scanning Files', 'Tombstoning Deletes', 'Analyzing'];
                const phaseName = phaseNames[scan.phase - 1] || 'Processing';

                // Render breadcrumbs for completed phases
                const breadcrumbsHtml = this.phaseBreadcrumbs.length > 0 ? `
                    <div style="margin-bottom: 12px;">
                        ${this.phaseBreadcrumbs.map(crumb => `
                            <div style="font-size: 0.875rem; color: #34c759; margin-bottom: 4px;">
                                ✓ ${crumb}
                            </div>
                        `).join('')}
                    </div>
                ` : '';

                // Show scanning activity for phase 1
                const scanningActivityHtml = scan.phase === 1 ? `
                    <div class="scan-stats" style="margin-top: 12px; color: #007aff;">
                        Scanned ${this.scanningCounts.files.toLocaleString()} files in ${this.scanningCounts.directories.toLocaleString()} directories...
                    </div>
                ` : '';

                const threadsHtml = scan.threads ? scan.threads.map(thread => {
                    // Parse thread message to determine operation type
                    let operation = 'idle';
                    let filePath = thread.current_file || '-';

                    if (thread.current_file) {
                        if (thread.current_file.startsWith('Hashing:')) {
                            operation = 'hashing';
                            filePath = thread.current_file.substring(9).trim(); // Remove "Hashing: " prefix
                        } else if (thread.current_file.startsWith('Validating:')) {
                            operation = 'validating';
                            filePath = thread.current_file.substring(12).trim(); // Remove "Validating: " prefix
                        } else if (thread.status === 'active') {
                            operation = 'scanning';
                        }
                    }

                    const statusLabels = {
                        'hashing': 'HASHING',
                        'validating': 'VALIDATING',
                        'scanning': 'SCANNING',
                        'idle': 'IDLE'
                    };

                    return `
                        <div class="scan-thread-item">
                            <span class="scan-thread-status ${operation}">${statusLabels[operation]}</span>
                            <span class="scan-thread-file">${filePath}</span>
                        </div>
                    `;
                }).join('') : '';

                return `
                    <div class="scan-card">
                        <div class="scan-title">Scanning: ${scan.root_path}</div>
                        ${breadcrumbsHtml}
                        <div class="scan-progress-section">
                            <div class="scan-progress-label">
                                <span>Phase ${scan.phase} of 3: ${phaseName}</span>
                                <span>${scan.progress.percentage.toFixed(1)}%</span>
                            </div>
                            <div class="scan-progress-bar-container">
                                <div class="scan-progress-bar" style="width: ${scan.progress.percentage}%"></div>
                            </div>
                            ${scan.phase === 3 ? `
                                <div class="scan-stats">
                                    ${scan.progress.current.toLocaleString()} / ${scan.progress.total.toLocaleString()} files
                                </div>
                            ` : scanningActivityHtml}
                        </div>
                        ${scan.phase === 3 ? `
                            <button class="scan-details-toggle ${isExpanded ? 'expanded' : ''}"
                                    data-scan-id="${scan.scan_id}">
                                <span>Details</span>
                                <span class="chevron">▼</span>
                            </button>
                            <div class="scan-thread-details ${isExpanded ? 'visible' : ''}">
                                ${threadsHtml || '<div style="padding: 12px; color: #86868b; font-style: italic;">Waiting for thread activity...</div>'}
                            </div>
                        ` : ''}
                    </div>
                `;
            }

            toggleDetails(scanId) {
                // Toggle the expanded state
                if (this.expandedScans.has(scanId)) {
                    this.expandedScans.delete(scanId);
                } else {
                    this.expandedScans.add(scanId);
                }

                // Directly update the button and details container - no re-render needed
                const isExpanded = this.expandedScans.has(scanId);
                const button = document.getElementById(`details-btn-${scanId}`);
                const threadDetailsContainer = document.getElementById(`thread-details-${scanId}`);

                if (button) {
                    button.className = `scan-details-toggle ${isExpanded ? 'expanded' : ''}`;
                }
                if (threadDetailsContainer) {
                    threadDetailsContainer.className = `scan-thread-details ${isExpanded ? 'visible' : ''}`;
                }
            }

            async stopScan(scanId) {
                // Optimistically update button state immediately
                const stopButton = document.getElementById(`stop-btn-${scanId}`);
                if (stopButton) {
                    stopButton.disabled = true;
                    stopButton.textContent = 'Stopping';
                }

                try {
                    const response = await fetch(`/api/scans/${scanId}/cancel`, {
                        method: 'POST'
                    });

                    if (!response.ok) {
                        console.error('Failed to cancel scan:', response.statusText);
                        alert('Failed to cancel scan. Please try again.');
                        // Revert button state on error
                        if (stopButton) {
                            stopButton.disabled = false;
                            stopButton.textContent = 'Stop';
                        }
                    }
                    // Backend will set status to "cancelling" which will update the UI via WebSocket
                } catch (error) {
                    console.error('Error cancelling scan:', error);
                    alert('Error cancelling scan. Please check your connection.');
                    // Revert button state on error
                    if (stopButton) {
                        stopButton.disabled = false;
                        stopButton.textContent = 'Stop';
                    }
                }
            }

            connectScanWebSocket(scanId, rootPath) {
                // Close existing connection if any
                if (this.ws) {
                    this.ws.close();
                }

                // Initialize scan state
                this.currentScanId = scanId;
                this.scanPhase = 1;
                this.threadStates.clear();
                this.scanningCounts = { files: 0, directories: 0 };
                this.phaseBreadcrumbs = [];

                this.activeScans.set(scanId, {
                    scan_id: scanId,
                    root_path: rootPath,
                    phase: 1,
                    progress: {
                        current: 0,
                        total: 1,
                        percentage: 0
                    },
                    threads: []
                });
                this.expandedScans.add(scanId); // Expand by default
                this.scheduleRender();

                // Connect to WebSocket
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}/ws/scans/progress`;

                this.ws = new WebSocket(wsUrl);

                this.ws.onopen = () => {
                    // WebSocket connected
                };

                this.ws.onmessage = (event) => {
                    const state = JSON.parse(event.data);
                    this.handleStateUpdate(state);
                };

                this.ws.onerror = (error) => {
                    console.error('WebSocket error:', error);
                };

                this.ws.onclose = () => {
                    // Remove scan from active list after a delay
                    setTimeout(() => {
                        this.activeScans.delete(scanId);
                        this.scheduleRender();
                    }, 2000);
                };
            }

            handleStateUpdate(state) {
                // Handle error state
                if (state.error) {
                    console.error('WebSocket error:', state.error);
                    return;
                }

                // Update or create scan data from complete state snapshot
                const scanData = this.activeScans.get(state.scan_id) || {
                    scan_id: state.scan_id,
                    root_path: state.root_path,
                    phase: 1,
                    progress: { current: 0, total: 1, percentage: 0 },
                    threads: []
                };

                // Map phase name to phase number
                if (state.current_phase) {
                    if (state.current_phase.name === 'scanning') {
                        scanData.phase = 1;
                        this.scanPhase = 1;
                    } else if (state.current_phase.name === 'sweeping') {
                        scanData.phase = 2;
                        this.scanPhase = 2;
                    } else if (state.current_phase.name === 'analyzing') {
                        scanData.phase = 3;
                        this.scanPhase = 3;
                    }
                }

                // Update completed phase breadcrumbs
                this.phaseBreadcrumbs = state.completed_phases || [];

                // Update scanning progress (phase 1)
                if (state.scanning_progress) {
                    this.scanningCounts = {
                        files: state.scanning_progress.files_scanned || 0,
                        directories: state.scanning_progress.directories_scanned || 0
                    };
                }

                // Update overall progress (phase 3)
                if (state.overall_progress) {
                    scanData.progress = {
                        current: state.overall_progress.completed,
                        total: state.overall_progress.total,
                        percentage: state.overall_progress.percentage
                    };
                }

                // Update thread states
                if (state.thread_states && state.thread_states.length > 0) {
                    scanData.threads = state.thread_states.map(thread => {
                        if (thread.operation.type === 'idle') {
                            return { id: thread.thread_index, status: 'idle', current_file: null };
                        }

                        let prefix = '';
                        let file = '';
                        if (thread.operation.type === 'hashing') {
                            prefix = 'Hashing:';
                            file = thread.operation.file;
                        } else if (thread.operation.type === 'validating') {
                            prefix = 'Validating:';
                            file = thread.operation.file;
                        }

                        return {
                            id: thread.thread_index,
                            status: 'active',
                            current_file: prefix ? `${prefix} ${file}` : file
                        };
                    });
                }

                // Update scan status
                if (state.status) {
                    scanData.status = state.status;
                }

                // Update the scan in activeScans
                this.activeScans.set(state.scan_id, scanData);

                // Handle scan completion
                // Status is an object like {status: "running"}, check the status field
                if (state.status && state.status.status) {
                    const statusValue = state.status.status;

                    if (statusValue === 'completed') {
                        // Scan completed - remove after delay
                        setTimeout(() => {
                            this.activeScans.delete(state.scan_id);
                            this.scheduleRender();
                        }, 2000);
                    } else if (statusValue === 'stopped') {
                        // Scan stopped (cancelled) - remove after delay
                        setTimeout(() => {
                            this.activeScans.delete(state.scan_id);
                            this.scheduleRender();
                        }, 2000);
                    } else if (statusValue === 'error') {
                        console.error('Scan error:', state.status.message);
                        alert(`Scan error: ${state.status.message}`);
                        // Remove scan on error after delay
                        setTimeout(() => {
                            this.activeScans.delete(state.scan_id);
                            this.scheduleRender();
                        }, 3000);
                    }
                    // For 'running' and 'cancelling' states, keep the scan visible
                }

                this.scheduleRender();
            }

            // Demo method - adds a mock scan for testing UI
            addMockScan() {
                const mockScan = {
                    scan_id: '123',
                    root_path: '/Users/demo/Documents',
                    phase: 2,
                    phase_name: 'Analysis',
                    total_phases: 3,
                    progress: {
                        current: 2450,
                        total: 5400,
                        percentage: 45.37
                    },
                    threads: [
                        { id: 1, status: 'active', current_file: 'Hashing: /Users/demo/Documents/video.mp4' },
                        { id: 2, status: 'active', current_file: 'Validating: /Users/demo/Documents/report.pdf' },
                        { id: 3, status: 'active', current_file: 'Hashing: /Users/demo/Documents/photo.jpg' },
                        { id: 4, status: 'idle', current_file: null }
                    ]
                };

                this.activeScans.set('123', mockScan);
                this.expandedScans.add('123'); // Expand by default
                this.scheduleRender();
            }

            async checkForActiveScan() {
                try {
                    const response = await fetch('/api/scans/current');
                    if (!response.ok) return;

                    const data = await response.json();

                    // If there's an active scan, connect to WebSocket for state updates
                    if (data && data.scan_id) {
                        console.log('Found active scan:', data);
                        // Connect to WebSocket - state snapshots will rebuild the UI automatically
                        this.connectScanWebSocket(data.scan_id, data.root_path);
                    }
                } catch (error) {
                    console.error('Failed to check for active scan:', error);
                }
            }

        }

        // Global scan manager instance
        const scanManager = new ScanManager();

        // Store scan status data globally
        let scanStatusData = null;

        // Start New Scan Modal Functions
        async function showStartScanModal() {
            const modal = document.getElementById('start-scan-modal-overlay');
            const select = document.getElementById('scan-root-select');
            const error = document.getElementById('scan-error');

            error.classList.remove('visible');

            // Load scan status (includes roots and incomplete scan info)
            try {
                const response = await fetch('/api/scans/status');
                scanStatusData = await response.json();

                if (scanStatusData.roots && scanStatusData.roots.length > 0) {
                    // Populate dropdown with roots (no "Select a root..." option)
                    select.innerHTML = scanStatusData.roots.map(root => {
                        const label = root.has_incomplete_scan
                            ? `${root.root_path} (Resume)`
                            : root.root_path;
                        return `<option value="${root.root_id}">${label}</option>`;
                    }).join('');

                    // Trigger selection handler for first root
                    handleRootSelection();
                } else {
                    select.innerHTML = '<option value="">No roots available</option>';
                }
            } catch (err) {
                console.error('Failed to load scan status:', err);
                select.innerHTML = '<option value="">Error loading roots</option>';
            }

            modal.classList.add('active');
        }

        function handleRootSelection() {
            const select = document.getElementById('scan-root-select');
            const rootId = parseInt(select.value);

            if (!rootId || !scanStatusData) return;

            const root = scanStatusData.roots.find(r => r.root_id === rootId);
            if (!root) return;

            const actionBtn = document.getElementById('scan-action-btn');

            // Get all radio inputs
            const hashRadios = document.querySelectorAll('input[name="hash-mode"]');
            const validateRadios = document.querySelectorAll('input[name="validate-mode"]');

            if (root.has_incomplete_scan) {
                // Resume mode: Set values from existing scan and make read-only
                actionBtn.textContent = 'Resume Scan';

                // Set radio values to match existing scan
                hashRadios.forEach(radio => {
                    radio.checked = radio.value === root.scan_options.hash_mode;
                    radio.disabled = true;
                    radio.parentElement.style.opacity = '0.6';
                    radio.parentElement.style.cursor = 'not-allowed';
                });

                validateRadios.forEach(radio => {
                    radio.checked = radio.value === root.scan_options.validate_mode;
                    radio.disabled = true;
                    radio.parentElement.style.opacity = '0.6';
                    radio.parentElement.style.cursor = 'not-allowed';
                });
            } else {
                // New scan mode: Enable editing with defaults
                actionBtn.textContent = 'Start Scan';

                // Reset to defaults and enable
                hashRadios.forEach(radio => {
                    radio.checked = radio.value === 'All'; // Default to All
                    radio.disabled = false;
                    radio.parentElement.style.opacity = '1';
                    radio.parentElement.style.cursor = 'pointer';
                });

                validateRadios.forEach(radio => {
                    radio.checked = radio.value === 'New'; // Default to New
                    radio.disabled = false;
                    radio.parentElement.style.opacity = '1';
                    radio.parentElement.style.cursor = 'pointer';
                });
            }
        }

        function closeStartScanModal() {
            const modal = document.getElementById('start-scan-modal-overlay');
            modal.classList.remove('active');
        }

        async function startScan() {
            const select = document.getElementById('scan-root-select');
            const rootId = parseInt(select.value);
            const root = scanStatusData.roots.find(r => r.root_id === rootId);
            const error = document.getElementById('scan-error');

            error.classList.remove('visible');

            // Determine scan options
            let hashMode, validateMode;
            if (root.has_incomplete_scan) {
                // Use existing scan options
                hashMode = root.scan_options.hash_mode;
                validateMode = root.scan_options.validate_mode;
            } else {
                // Use user-selected options
                hashMode = document.querySelector('input[name="hash-mode"]:checked').value;
                validateMode = document.querySelector('input[name="validate-mode"]:checked').value;
            }

            try {
                // Call the API to start/resume the scan
                const response = await fetch('/api/scans/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        root_id: rootId,
                        hash_mode: hashMode,
                        validate_mode: validateMode
                    })
                });

                if (!response.ok) {
                    throw new Error(`Failed to start scan: ${response.statusText}`);
                }

                const data = await response.json();
                const scanId = data.scan_id;

                // Connect to WebSocket for real-time progress
                scanManager.connectScanWebSocket(scanId, root.root_path);

                closeStartScanModal();
            } catch (err) {
                console.error('Failed to start scan:', err);
                error.textContent = `Failed to start scan: ${err.message}`;
                error.classList.add('visible');
            }
        }

        // =============================================================================
        // DataTableView - Unified implementation for Roots, Scans, and Items
        // =============================================================================
        // Single class handles all table views with column management & filtering
        // Eliminates ~1000 lines of duplicated code
        // =============================================================================

        class DataTableView {
            constructor(domain, displayName) {
                this.domain = domain;
                this.displayName = displayName;
                this.columnState = [];
                this.selectedColumnIndex = null;
                this.activeFilters = [];
                this.currentFilterColumnIndex = null;
                this.currentPage = 1;
                this.draggedColumnIndex = null;
                this.dropPosition = null;
            }

            // DOM ID helpers
            getElementId(suffix) {
                return `${this.domain}-${suffix}`;
            }

            getElement(suffix) {
                return document.getElementById(this.getElementId(suffix));
            }

            async loadMetadata() {
                try {
                    const response = await fetch(`/api/metadata/${this.domain}`);
                    const data = await response.json();

                    this.columnState = data.columns.map((col, index) => ({
                        name: col.name,
                        displayName: col.display_name,
                        colType: col.col_type,
                        alignment: col.alignment,
                        visible: col.is_default,
                        sortDirection: 'none',
                        position: index,
                        filterInfo: col.filter_info
                    }));

                    this.renderColumnList();
                    this.loadData();
                } catch (error) {
                    console.error(`Failed to load ${this.domain} metadata:`, error);
                    this.getElement('column-list').innerHTML =
                        '<li style="color: #f44336; padding: 1rem;">Failed to load columns</li>';
                }
            }

            renderColumnList() {
                const list = this.getElement('column-list');
                const sortedColumns = [...this.columnState].sort((a, b) => a.position - b.position);

                list.innerHTML = sortedColumns.map((col, displayIndex) => {
                    const actualIndex = this.columnState.findIndex(c => c.name === col.name);
                    const sortIcon = col.sortDirection === 'asc' ? '↑' :
                                    col.sortDirection === 'desc' ? '↓' : '·';
                    const sortClass = col.sortDirection !== 'none' ? 'active' : '';

                    const activeFilter = this.activeFilters.find(f => f.columnName === col.name);
                    const filterDisplay = activeFilter
                        ? `<div class="filter-value-chip" onclick="event.stopPropagation(); views.${this.domain}.openFilterModal(${actualIndex})" title="${activeFilter.filterValue}">
                             <span class="filter-value-text">${activeFilter.filterValue}</span>
                             <span class="filter-value-remove" onclick="event.stopPropagation(); views.${this.domain}.removeFilter('${col.name}')">×</span>
                           </div>`
                        : `<button class="filter-add-btn" onclick="event.stopPropagation(); views.${this.domain}.openFilterModal(${actualIndex})" title="Add filter">+</button>`;

                    return `
                        <li class="column-item ${this.selectedColumnIndex === actualIndex ? 'selected' : ''}"
                            data-column-index="${actualIndex}"
                            draggable="true"
                            onclick="views.${this.domain}.selectColumn(${actualIndex})">
                            <div class="drag-handle" title="Drag to reorder"></div>
                            <input type="checkbox"
                                   class="column-checkbox"
                                   ${col.visible ? 'checked' : ''}
                                   onclick="event.stopPropagation(); views.${this.domain}.toggleColumnVisibility(${actualIndex})"
                                   title="Toggle visibility">
                            <span class="column-name">${col.displayName}</span>
                            <div class="sort-control ${sortClass}"
                                 onclick="event.stopPropagation(); views.${this.domain}.cycleColumnSort(${actualIndex})"
                                 title="Sort direction">
                                ${sortIcon}
                            </div>
                            <div class="filter-display">
                                ${filterDisplay}
                            </div>
                        </li>
                    `;
                }).join('');
            }

            setupDragListeners() {
                const columnList = this.getElement('column-list');

                columnList.addEventListener('dragstart', (e) => {
                    const columnItem = e.target.closest('.column-item');
                    if (columnItem) {
                        this.draggedColumnIndex = parseInt(columnItem.dataset.columnIndex);
                        columnItem.classList.add('dragging');
                        e.dataTransfer.effectAllowed = 'move';
                        e.dataTransfer.setData('text/html', columnItem.innerHTML);
                    }
                });

                columnList.addEventListener('dragenter', (e) => {
                    const columnItem = e.target.closest('.column-item');
                    if (columnItem) {
                        e.preventDefault();
                        this.updateDropIndicator(columnItem, e.clientY);
                    }
                });

                columnList.addEventListener('dragover', (e) => {
                    const columnItem = e.target.closest('.column-item');
                    if (columnItem) {
                        e.preventDefault();
                        e.dataTransfer.dropEffect = 'move';
                        this.updateDropIndicator(columnItem, e.clientY);
                    }
                });

                columnList.addEventListener('drop', (e) => {
                    const columnItem = e.target.closest('.column-item');
                    if (columnItem) {
                        this.handleColumnDrop(e, columnItem);
                    }
                });

                columnList.addEventListener('dragend', (e) => {
                    const columnItem = e.target.closest('.column-item');
                    if (columnItem) {
                        this.handleColumnDragEnd(e);
                    }
                });
            }

            updateDropIndicator(item, mouseY) {
                const itemIndex = parseInt(item.dataset.columnIndex);
                if (itemIndex === this.draggedColumnIndex) return;

                document.querySelectorAll(`#${this.getElementId('column-list')} .column-item`).forEach(el => {
                    el.classList.remove('drag-over-top', 'drag-over-bottom');
                });

                const rect = item.getBoundingClientRect();
                const midpoint = rect.top + rect.height / 2;

                if (mouseY < midpoint) {
                    item.classList.add('drag-over-top');
                    this.dropPosition = 'before';
                } else {
                    item.classList.add('drag-over-bottom');
                    this.dropPosition = 'after';
                }
            }

            handleColumnDrop(e, dropElement) {
                e.stopPropagation();
                e.preventDefault();

                const dropIndex = parseInt(dropElement.dataset.columnIndex);
                if (this.draggedColumnIndex === null || this.draggedColumnIndex === dropIndex) {
                    return false;
                }

                const draggedCol = this.columnState[this.draggedColumnIndex];
                const dropCol = this.columnState[dropIndex];
                const draggedPos = draggedCol.position;
                const dropPos = dropCol.position;

                let targetPos = dropPos;
                if (this.dropPosition === 'after') {
                    targetPos = dropPos + 1;
                }

                if (draggedPos < targetPos) {
                    this.columnState.forEach(col => {
                        if (col.position > draggedPos && col.position < targetPos) {
                            col.position--;
                        }
                    });
                    draggedCol.position = targetPos - 1;
                } else if (draggedPos > targetPos) {
                    this.columnState.forEach(col => {
                        if (col.position >= targetPos && col.position < draggedPos) {
                            col.position++;
                        }
                    });
                    draggedCol.position = targetPos;
                }

                this.selectedColumnIndex = this.draggedColumnIndex;
                this.renderColumnList();
                this.loadData();
                return false;
            }

            handleColumnDragEnd(e) {
                const columnItem = e.target.closest('.column-item');
                if (columnItem) {
                    columnItem.classList.remove('dragging');
                }

                document.querySelectorAll(`#${this.getElementId('column-list')} .column-item`).forEach(item => {
                    item.classList.remove('drag-over-top', 'drag-over-bottom');
                });

                this.draggedColumnIndex = null;
                this.dropPosition = null;
            }

            selectColumn(index) {
                this.selectedColumnIndex = index;
                this.renderColumnList();
            }

            toggleColumnVisibility(index) {
                this.columnState[index].visible = !this.columnState[index].visible;
                this.currentPage = 1;
                this.renderColumnList();
                this.loadData();
            }

            cycleColumnSort(index) {
                const current = this.columnState[index].sortDirection;
                const cycle = { 'none': 'asc', 'asc': 'desc', 'desc': 'none' };
                this.columnState[index].sortDirection = cycle[current];
                this.currentPage = 1;
                this.renderColumnList();
                this.loadData();
            }

            openFilterModal(columnIndex) {
                this.currentFilterColumnIndex = columnIndex;
                const column = this.columnState[columnIndex];
                const modal = this.getElement('filter-modal-overlay');
                const title = this.getElement('filter-modal-title');
                const hint = this.getElement('filter-hint');
                const input = this.getElement('filter-input');
                const error = this.getElement('filter-error');

                title.textContent = `Filter: ${column.displayName}`;
                hint.textContent = column.filterInfo.syntax_hint;

                const existingFilter = this.activeFilters.find(f => f.columnName === column.name);
                input.value = existingFilter ? existingFilter.filterValue : '';

                error.classList.remove('visible');
                modal.classList.add('active');
                setTimeout(() => input.focus(), 100);
            }

            closeFilterModal() {
                const modal = this.getElement('filter-modal-overlay');
                modal.classList.remove('active');
                this.currentFilterColumnIndex = null;
            }

            saveFilter() {
                if (this.currentFilterColumnIndex === null) return;

                const column = this.columnState[this.currentFilterColumnIndex];
                const input = this.getElement('filter-input');
                const filterValue = input.value.trim();
                const error = this.getElement('filter-error');

                error.classList.remove('visible');

                if (filterValue === '') {
                    this.activeFilters = this.activeFilters.filter(f => f.columnName !== column.name);
                    this.closeFilterModal();
                    this.renderColumnList();
                    this.loadData();
                    return;
                }

                if (filterValue.length > 500) {
                    error.textContent = 'Filter value is too long (max 500 characters)';
                    error.classList.add('visible');
                    return;
                }

                this.activeFilters = this.activeFilters.filter(f => f.columnName !== column.name);
                this.activeFilters.push({
                    columnName: column.name,
                    displayName: column.displayName,
                    filterValue: filterValue
                });

                this.closeFilterModal();
                this.currentPage = 1;
                this.renderColumnList();
                this.loadData();
            }

            removeFilter(columnName) {
                this.activeFilters = this.activeFilters.filter(f => f.columnName !== columnName);
                this.currentPage = 1;
                this.renderColumnList();
                this.loadData();
            }

            async loadData() {
                if (this.columnState.length === 0) {
                    await this.loadMetadata();
                    return;
                }

                try {
                    const visibleColumns = this.columnState
                        .filter(col => col.visible)
                        .sort((a, b) => a.position - b.position);

                    if (visibleColumns.length === 0) {
                        this.getElement('table-header').innerHTML =
                            '<th colspan="1" style="text-align: center; color: #f44336;">No columns selected. Please select columns to display.</th>';
                        this.getElement('table-body').innerHTML =
                            '<tr><td style="text-align: center; color: #666;">Select columns from the sidebar to display data</td></tr>';
                        return;
                    }

                    const headerHtml = visibleColumns.map(col => {
                        const alignStyle = col.alignment === 'Right' ? 'text-align: right' :
                                          col.alignment === 'Center' ? 'text-align: center' : '';
                        return `<th style="${alignStyle}">${col.displayName}</th>`;
                    }).join('');
                    this.getElement('table-header').innerHTML = headerHtml;

                    const itemsPerPage = 25;
                    const offset = (this.currentPage - 1) * itemsPerPage;

                    const queryRequest = {
                        columns: this.columnState.map(col => ({
                            name: col.name,
                            visible: col.visible,
                            sort_direction: col.sortDirection,
                            position: col.position
                        })),
                        filters: this.activeFilters.map(f => ({
                            column: f.columnName,
                            value: f.filterValue
                        })),
                        limit: itemsPerPage,
                        offset: offset
                    };

                    const response = await fetch(`/api/query/${this.domain}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(queryRequest)
                    });
                    const data = await response.json();

                    const tbody = this.getElement('table-body');
                    tbody.innerHTML = '';

                    if (data.rows && data.rows.length > 0) {
                        data.rows.forEach(rowData => {
                            const row = document.createElement('tr');

                            const cellsHtml = rowData.map((cellValue, index) => {
                                const col = visibleColumns[index];
                                const alignStyle = col.alignment === 'Right' ? 'text-align: right' :
                                                  col.alignment === 'Center' ? 'text-align: center' : '';
                                return `<td style="${alignStyle}">${cellValue}</td>`;
                            }).join('');

                            row.innerHTML = cellsHtml;
                            tbody.appendChild(row);
                        });
                    } else {
                        tbody.innerHTML = `<tr><td colspan="${visibleColumns.length}" style="text-align: center; color: #666;">No ${this.domain} found</td></tr>`;
                    }

                    const itemsPerPageDisplay = 25;
                    const showing = data.rows.length;
                    const start = showing > 0 ? ((this.currentPage - 1) * itemsPerPageDisplay) + 1 : 0;
                    const end = Math.min(start + showing - 1, data.total);
                    this.getElement('pagination-info').textContent =
                        `Showing ${start} - ${end} of ${data.total} ${this.domain}`;

                    const hasNext = end < data.total;
                    const hasPrev = this.currentPage > 1;
                    this.getElement('prev-btn').disabled = !hasPrev;
                    this.getElement('next-btn').disabled = !hasNext;

                } catch (error) {
                    console.error(`Failed to load ${this.domain}:`, error);
                    const visibleCount = this.columnState.filter(c => c.visible).length || 1;
                    this.getElement('table-body').innerHTML =
                        `<tr><td colspan="${visibleCount}" style="color: #f44336;">Failed to load ${this.domain}</td></tr>`;
                }
            }

            changePage(delta) {
                this.currentPage += delta;
                window.scrollTo({ top: 0, behavior: 'smooth' });
                this.loadData();
            }
        }

        // Create instances for each domain
        const views = {
            roots: new DataTableView('roots', 'Roots'),
            scans: new DataTableView('scans', 'Scans'),
            items: new DataTableView('items', 'Items'),
            changes: new DataTableView('changes', 'Changes')
        };

        // Global functions for onclick handlers (backwards compatibility)
        function changeRootsPage(delta) { views.roots.changePage(delta); }
        function changeScansPage(delta) { views.scans.changePage(delta); }
        function changeItemsPage(delta) { views.items.changePage(delta); }

        function closeRootsFilterModal() { views.roots.closeFilterModal(); }
        function closeScansFilterModal() { views.scans.closeFilterModal(); }
        function closeItemsFilterModal() { views.items.closeFilterModal(); }

        function saveRootsFilter() { views.roots.saveFilter(); }
        function saveScansFilter() { views.scans.saveFilter(); }
        function saveItemsFilter() { views.items.saveFilter(); }

        function changeChangesPage(delta) { views.changes.changePage(delta); }
        function closeChangesFilterModal() { views.changes.closeFilterModal(); }
        function saveChangesFilter() { views.changes.saveFilter(); }

        // Enhanced showSection to load data when needed
        function showSection(sectionName, updateHash = true) {
            // Update URL hash if requested
            if (updateHash) {
                window.location.hash = '#/' + sectionName;
            }

            // Hide all sections
            document.querySelectorAll('[id$="-section"]').forEach(section => {
                section.style.display = 'none';
            });

            // Show selected section
            document.getElementById(sectionName + '-section').style.display = 'block';

            // Update nav active state
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });

            // Find and activate the correct nav item
            const activeNavItem = Array.from(document.querySelectorAll('.nav-item')).find(item => {
                return item.textContent.toLowerCase().includes(sectionName.toLowerCase());
            });
            if (activeNavItem) {
                activeNavItem.classList.add('active');
            }

            // Load data for specific sections
            if (['roots', 'scans', 'items', 'changes'].includes(sectionName)) {
                views[sectionName].loadData();
            } else if (sectionName === 'manage-roots') {
                loadManageRootsData();
            }

            // Close sidebar on mobile
            if (window.innerWidth <= 768) {
                document.getElementById('sidebar').classList.remove('open');
            }
        }

        // Handle hash-based routing
        function handleRouteChange() {
            const hash = window.location.hash;
            let sectionName = 'overview'; // default

            if (hash.startsWith('#/')) {
                sectionName = hash.substring(2); // Remove '#/'
            }

            // Validate section exists
            const sectionElement = document.getElementById(sectionName + '-section');
            if (!sectionElement) {
                sectionName = 'overview';
            }

            showSection(sectionName, false); // Don't update hash to avoid loop
        }

        // ========================================
        // Manage Roots Functionality
        // ========================================

        let manageRootsCurrentPage = 1;
        const manageRootsPageSize = 25;
        let manageRootsTotalCount = 0;

        async function loadManageRootsData() {
            try {
                // Use the query API to fetch roots sorted by root_path
                const response = await fetch('/api/query/roots', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        columns: [
                            { name: 'root_path', visible: true, sort_direction: 'asc', position: 0 }
                        ],
                        filters: [],
                        limit: manageRootsPageSize,
                        offset: (manageRootsCurrentPage - 1) * manageRootsPageSize
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error ${response.status}`);
                }

                const data = await response.json();
                manageRootsTotalCount = data.total;

                renderManageRootsTable(data.rows);
                updateManageRootsPagination();
            } catch (error) {
                console.error('Error loading manage roots data:', error);
                document.getElementById('manage-roots-table-body').innerHTML = `
                    <tr>
                        <td style="text-align: center; color: #ff3b30; padding: 2rem;">
                            Error loading roots: ${error.message}
                        </td>
                    </tr>
                `;
            }
        }

        function renderManageRootsTable(rows) {
            const tbody = document.getElementById('manage-roots-table-body');

            if (rows.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td style="text-align: center; color: #86868b; padding: 2rem;">
                            No roots found. Click "Add Root" to get started.
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = rows.map(row => `
                <tr>
                    <td style="font-family: 'SF Mono', Monaco, 'Courier New', monospace;">${row[0]}</td>
                </tr>
            `).join('');
        }

        function updateManageRootsPagination() {
            const startIndex = (manageRootsCurrentPage - 1) * manageRootsPageSize + 1;
            const endIndex = Math.min(manageRootsCurrentPage * manageRootsPageSize, manageRootsTotalCount);

            document.getElementById('manage-roots-pagination-info').textContent =
                `Showing ${startIndex} - ${endIndex} of ${manageRootsTotalCount} roots`;

            document.getElementById('manage-roots-prev-btn').disabled = manageRootsCurrentPage === 1;
            document.getElementById('manage-roots-next-btn').disabled =
                manageRootsCurrentPage * manageRootsPageSize >= manageRootsTotalCount;
        }

        function changeManageRootsPage(direction) {
            const newPage = manageRootsCurrentPage + direction;
            const maxPage = Math.ceil(manageRootsTotalCount / manageRootsPageSize);

            if (newPage >= 1 && newPage <= maxPage) {
                manageRootsCurrentPage = newPage;
                loadManageRootsData();
            }
        }

        function showAddRootModal() {
            const overlay = document.getElementById('add-root-modal-overlay');
            const input = document.getElementById('add-root-path-input');
            const errorDiv = document.getElementById('add-root-error');
            const successDiv = document.getElementById('add-root-success');

            // Reset form
            input.value = '';
            errorDiv.classList.remove('visible');
            successDiv.classList.remove('visible');

            // Show modal
            overlay.classList.add('active');

            // Focus input after animation
            setTimeout(() => input.focus(), 100);
        }

        function hideAddRootModal() {
            const overlay = document.getElementById('add-root-modal-overlay');
            overlay.classList.remove('active');
        }

        async function submitNewRoot() {
            const input = document.getElementById('add-root-path-input');
            const errorDiv = document.getElementById('add-root-error');
            const errorText = document.getElementById('add-root-error-text');
            const successDiv = document.getElementById('add-root-success');
            const successText = document.getElementById('add-root-success-text');
            const submitBtn = document.getElementById('add-root-submit-btn');

            const path = input.value.trim();

            // Reset states
            errorDiv.classList.remove('visible');
            successDiv.classList.remove('visible');

            // Validate input
            if (!path) {
                errorText.textContent = 'Please enter a path';
                errorDiv.classList.add('visible');
                return;
            }

            // Disable submit button during request
            submitBtn.disabled = true;
            submitBtn.textContent = 'Adding...';

            try {
                const response = await fetch('/api/roots', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ path })
                });

                const data = await response.json();

                if (response.ok) {
                    // Success
                    successText.textContent = `Root added successfully: ${data.root_path}`;
                    successDiv.classList.add('visible');

                    // Reload the roots list
                    await loadManageRootsData();

                    // Close modal after delay
                    setTimeout(() => {
                        hideAddRootModal();
                    }, 1500);
                } else {
                    // Error from server
                    errorText.textContent = data.error || 'Failed to add root';
                    errorDiv.classList.add('visible');
                }
            } catch (error) {
                console.error('Error adding root:', error);
                errorText.textContent = 'Network error. Please try again.';
                errorDiv.classList.add('visible');
            } finally {
                // Re-enable submit button
                submitBtn.disabled = false;
                submitBtn.textContent = 'Add Root';
            }
        }

        // Add Enter key support for the modal
        document.addEventListener('DOMContentLoaded', () => {
            const input = document.getElementById('add-root-path-input');
            if (input) {
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        submitNewRoot();
                    }
                });

                // Add Escape key to close modal
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        const overlay = document.getElementById('add-root-modal-overlay');
                        if (overlay && overlay.classList.contains('active')) {
                            hideAddRootModal();
                        }
                    }
                });
            }
        });

        // ========================================
        // End Manage Roots Functionality
        // ========================================

        // Listen for hash changes (back/forward buttons)
        window.addEventListener('hashchange', handleRouteChange);

        // Handle initial load based on URL hash
        document.addEventListener('DOMContentLoaded', () => {
            loadDashboardData();
            scanManager.render(); // Initial render to show "No Active Scan" if needed
            scanManager.checkForActiveScan(); // Check for active scan and reconnect if found
            views.items.setupDragListeners();
            views.roots.setupDragListeners();
            views.scans.setupDragListeners();
            views.changes.setupDragListeners();
            handleRouteChange(); // Load the correct section based on URL hash
        });
    </script>
</body>
</html>