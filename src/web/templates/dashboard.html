<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FsPulse Dashboard - Dev Mode</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', system-ui, sans-serif;
            background: #fafafa;
            color: #1d1d1f;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .header {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: saturate(180%) blur(20px);
            border-bottom: 1px solid rgba(0,0,0,0.08);
            padding: 0;
            height: 52px;
            display: flex;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-title {
            font-size: 1.25rem;
            font-weight: 600;
            letter-spacing: -0.01em;
            color: #1d1d1f;
            margin: 0;
            padding: 0 24px;
        }

        .hamburger {
            display: none;
            cursor: pointer;
            font-size: 1.5rem;
        }

        .container {
            display: flex;
            min-height: calc(100vh - 52px);
        }

        .sidebar {
            width: 64px;
            background: #fafafa;
            border-right: 1px solid rgba(0,0,0,0.08);
            padding: 12px 0;
            transition: width 0.2s ease;
            overflow: hidden;
            position: relative;
        }

        .sidebar:hover {
            width: 240px;
        }

        .nav-item {
            padding: 10px 16px;
            margin: 0 8px 2px 8px;
            cursor: pointer;
            border: none;
            background: none;
            width: calc(100% - 16px);
            text-align: left;
            font-size: 0.9375rem;
            font-weight: 400;
            color: #1d1d1f;
            transition: background-color 0.15s ease;
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 12px;
            white-space: nowrap;
        }

        .nav-item:hover {
            background: rgba(0,0,0,0.04);
        }

        .nav-item.active {
            background: rgba(0,122,255,0.1);
            color: #007aff;
            font-weight: 500;
        }

        .nav-icon {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
            opacity: 0.6;
        }

        .nav-item.active .nav-icon {
            opacity: 1;
        }

        .nav-label {
            opacity: 0;
            transition: opacity 0.15s ease;
        }

        .sidebar:hover .nav-label {
            opacity: 1;
        }

        .nav-divider {
            margin: 12px 16px;
            border-top: 1px solid rgba(0,0,0,0.08);
        }

        .nav-section-header {
            font-size: 0.8125rem;
            font-weight: 600;
            letter-spacing: 0.06em;
            text-transform: uppercase;
            color: #86868b;
            padding: 12px 16px 8px 16px;
            margin-top: 8px;
            white-space: nowrap;
        }

        .nav-section-header .nav-label {
            opacity: 0;
            transition: opacity 0.15s ease;
        }

        .sidebar:hover .nav-section-header .nav-label {
            opacity: 1;
        }

        /* Minimal Scan Progress in Header */
        .scan-header-progress {
            flex: 1;
            margin-left: 32px;
            cursor: pointer;
            padding: 4px 12px;
            border-radius: 6px;
            transition: background 0.15s ease;
        }

        .scan-header-progress:hover {
            background: rgba(0,122,255,0.05);
        }

        .scan-header-content {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .scan-header-line1 {
            color: #1d1d1f;
            font-weight: 500;
            font-size: 0.875rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .scan-header-line2 {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #86868b;
            font-size: 0.8125rem;
        }

        .scan-header-bar {
            flex: 1;
            max-width: 200px;
            height: 3px;
            background: rgba(0,0,0,0.08);
            border-radius: 2px;
            overflow: hidden;
        }

        .scan-header-bar-fill {
            height: 100%;
            background: #007aff;
            transition: width 0.3s ease;
            border-radius: 2px;
        }

        #scan-header-percentage {
            min-width: 35px;
            text-align: right;
            font-weight: 500;
            color: #1d1d1f;
        }

        .main-content {
            flex: 1;
            min-width: 0;
            padding: 32px;
            background: #fafafa;
            overflow-x: auto;
        }

        /* Explore Section Tabs */
        .explore-tabs {
            display: flex;
            gap: 4px;
            border-bottom: 1px solid rgba(0,0,0,0.08);
            margin-bottom: 24px;
        }

        .explore-tab {
            padding: 12px 20px;
            border: none;
            background: transparent;
            font-size: 0.9375rem;
            font-weight: 500;
            color: #86868b;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.15s ease;
            border-bottom: 2px solid transparent;
            position: relative;
            top: 1px;
        }

        .explore-tab:hover {
            color: #1d1d1f;
            background: rgba(0,0,0,0.02);
        }

        .explore-tab.active {
            color: #007aff;
            border-bottom-color: #007aff;
        }

        .explore-tab-content {
            display: none;
        }

        .explore-tab-content.active {
            display: block;
        }

        /* Insights tabs - same style as explore tabs */
        .insights-tabs {
            display: flex;
            gap: 4px;
            border-bottom: 1px solid rgba(0,0,0,0.08);
            margin-bottom: 16px;
        }

        .insights-tab {
            padding: 12px 20px;
            border: none;
            background: transparent;
            font-size: 0.9375rem;
            font-weight: 500;
            color: #86868b;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.15s ease;
            border-bottom: 2px solid transparent;
            position: relative;
            top: 1px;
        }

        .insights-tab:hover {
            color: #1d1d1f;
            background: rgba(0,0,0,0.02);
        }

        .insights-tab.active {
            color: #007aff;
            border-bottom-color: #007aff;
        }

        .insights-tab-content {
            display: none;
        }

        .insights-tab-content.active {
            display: block;
        }

        /* Context filter toolbar */
        .context-filter-toolbar {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: rgba(0,0,0,0.02);
            border-radius: 8px;
            margin-bottom: 24px;
        }

        .context-filter-label {
            font-size: 0.9375rem;
            font-weight: 500;
            color: #1d1d1f;
        }

        .context-filter-select {
            padding: 8px 12px;
            border: 1px solid rgba(0,0,0,0.12);
            border-radius: 6px;
            background: white;
            font-size: 0.875rem;
            font-family: inherit;
            color: #1d1d1f;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .context-filter-select:hover {
            border-color: rgba(0,0,0,0.2);
        }

        .context-filter-select:focus {
            outline: none;
            border-color: #007aff;
            box-shadow: 0 0 0 3px rgba(0,122,255,0.1);
        }

        .context-filter-select option:disabled {
            color: #86868b;
        }

        /* Insights content styling */
        .insights-content {
            padding: 1rem;
        }

        /* Insights Alerts Filter Toolbar */
        .insights-alerts-filters {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: rgba(0,0,0,0.02);
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .insights-alerts-filters .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .insights-alerts-filters label {
            font-size: 0.875rem;
            font-weight: 500;
            color: #1d1d1f;
            white-space: nowrap;
        }

        .insights-alerts-filters select,
        .insights-alerts-filters input[type="text"] {
            padding: 8px 12px;
            border: 1px solid rgba(0,0,0,0.12);
            border-radius: 6px;
            background: white;
            font-size: 0.875rem;
            font-family: inherit;
            color: #1d1d1f;
            min-width: 150px;
        }

        .insights-alerts-filters input[type="text"] {
            min-width: 250px;
        }

        .insights-alerts-filters select:hover,
        .insights-alerts-filters input[type="text"]:hover {
            border-color: rgba(0,0,0,0.2);
        }

        .insights-alerts-filters select:focus,
        .insights-alerts-filters input[type="text"]:focus {
            outline: none;
            border-color: #007aff;
            box-shadow: 0 0 0 3px rgba(0,122,255,0.1);
        }

        .action-btn {
            padding: 8px 12px;
            border: 1px solid rgba(0,0,0,0.12);
            border-radius: 6px;
            background: white;
            color: #007aff;
            cursor: pointer;
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .action-btn:hover {
            background: rgba(0,122,255,0.05);
            border-color: #007aff;
        }

        /* Insights Alerts Table */
        .insights-alerts-table {
            width: 100%;
            border-collapse: collapse;
        }

        .insights-alerts-table thead {
            background: rgba(0,0,0,0.02);
        }

        .insights-alerts-table th {
            padding: 12px 16px;
            text-align: left;
            font-size: 0.8125rem;
            font-weight: 600;
            color: #1d1d1f;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            border-bottom: 1px solid rgba(0,0,0,0.08);
        }

        .insights-alerts-table tbody tr {
            border-bottom: 1px solid rgba(0,0,0,0.06);
            transition: background 0.15s ease;
        }

        .insights-alerts-table tbody tr:hover {
            background: rgba(0,0,0,0.02);
        }

        .insights-alerts-table td {
            padding: 12px 16px;
            font-size: 0.9375rem;
            color: #1d1d1f;
            vertical-align: middle;
        }

        .alert-type-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.8125rem;
            font-weight: 500;
        }

        .alert-type-hash {
            background: rgba(255, 149, 0, 0.1);
            color: #ff9500;
        }

        .alert-type-invalid {
            background: rgba(255, 59, 48, 0.1);
            color: #ff3b30;
        }

        .alert-file-path {
            font-family: 'SF Mono', 'Monaco', 'Courier New', monospace;
            font-size: 0.875rem;
            color: #007aff;
            cursor: pointer;
            text-decoration: none;
        }

        .alert-file-path:hover {
            text-decoration: underline;
        }

        .alert-details {
            font-size: 0.875rem;
            color: #86868b;
            line-height: 1.4;
        }

        .alert-details-code {
            font-family: 'SF Mono', 'Monaco', 'Courier New', monospace;
            font-size: 0.75rem;
            background: rgba(0,0,0,0.04);
            padding: 2px 4px;
            border-radius: 3px;
        }

        .alert-status-select {
            padding: 6px 20px 6px 8px;
            border: 1px solid rgba(0,0,0,0.12);
            border-radius: 6px;
            background: white;
            font-size: 0.875rem;
            font-family: inherit;
            color: #1d1d1f;
            cursor: pointer;
            width: 100%;
            min-width: 140px;
            box-sizing: border-box;
        }

        .alert-status-select:hover {
            border-color: rgba(0,0,0,0.2);
        }

        .alert-status-select:focus {
            outline: none;
            border-color: #007aff;
            box-shadow: 0 0 0 3px rgba(0,122,255,0.1);
        }

        .alert-status-select.status-open {
            background: rgba(0, 122, 255, 0.05);
            border-color: #007aff;
            color: #007aff;
        }

        .alert-status-select.status-flagged {
            background: rgba(255, 149, 0, 0.05);
            border-color: #ff9500;
            color: #ff9500;
        }

        .alert-status-select.status-dismissed {
            background: rgba(142, 142, 147, 0.05);
            border-color: #8e8e93;
            color: #8e8e93;
        }

        .overview-modules {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .card {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: left;
        }

        .card h3 {
            margin-bottom: 1rem;
            color: #333;
            font-size: 1.1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .module-link {
            color: #2196f3;
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: normal;
        }

        .module-link:hover {
            text-decoration: underline;
        }

        /* List Components */
        .list-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 16px 12px 16px;
            gap: 12px;
            border-bottom: 1px solid rgba(0,0,0,0.06);
        }

        .search-filter {
            flex: 1;
            max-width: 320px;
        }

        .search-filter input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid rgba(0,0,0,0.12);
            border-radius: 8px;
            font-size: 0.9375rem;
            font-family: inherit;
            background: #fafafa;
            transition: all 0.15s ease;
        }

        .search-filter input:focus {
            outline: none;
            border-color: #007aff;
            background: #ffffff;
            box-shadow: 0 0 0 3px rgba(0,122,255,0.1);
        }

        .search-filter input::placeholder {
            color: #86868b;
        }

        .sortable-header {
            cursor: pointer;
            user-select: none;
            position: relative;
            padding-right: 20px;
        }

        .sortable-header:hover {
            background: #e8f4fd;
        }

        .sort-indicator {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.7rem;
            color: #666;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .sortable-header:hover .sort-indicator {
            opacity: 0.5;
        }

        .sortable-header.active .sort-indicator {
            opacity: 1;
            color: #2196f3;
        }

        .data-table {
            width: auto;
            border-collapse: collapse;
            margin: 0;
        }

        .data-table th,
        .data-table td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid rgba(0,0,0,0.06);
            font-size: 0.9375rem;
        }

        .data-table thead {
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .data-table th {
            background: #fafafa;
            font-weight: 600;
            font-size: 0.8125rem;
            color: #86868b;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            padding: 16px 16px;
            border-bottom: 1px solid rgba(0,0,0,0.08);
        }

        .data-table td {
            color: #1d1d1f;
            line-height: 1.4;
        }

        .data-table tbody tr {
            transition: background-color 0.1s ease;
        }

        .data-table tbody tr:hover {
            background: rgba(0,0,0,0.02);
        }

        .data-table tbody tr:last-child td {
            border-bottom: none;
        }

        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-active {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .status-inactive {
            background: #fff3e0;
            color: #ef6c00;
        }

        .pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            border-top: 1px solid rgba(0,0,0,0.06);
            background: #fafafa;
            border-radius: 0 0 12px 12px;
            align-self: stretch;
        }

        .pagination-info {
            color: #86868b;
            font-size: 0.8125rem;
            font-weight: 500;
        }

        .pagination-controls {
            display: flex;
            gap: 8px;
        }

        .pagination-btn {
            padding: 6px 14px;
            border: 1px solid rgba(0,0,0,0.12);
            background: #ffffff;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            color: #1d1d1f;
            font-family: inherit;
            transition: all 0.15s ease;
        }

        .pagination-btn:hover:not(:disabled) {
            background: #f5f5f7;
            border-color: rgba(0,0,0,0.18);
        }

        .pagination-btn:active:not(:disabled) {
            transform: scale(0.98);
        }

        .pagination-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        /* Entity View Layout - Apple-inspired design */
        .entity-view-header {
            margin-bottom: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .entity-view-title {
            font-size: 2rem;
            font-weight: 600;
            letter-spacing: -0.02em;
            color: #1d1d1f;
            margin: 0;
            padding: 0;
        }

        .primary-action-btn {
            display: inline-flex;
            align-items: center;
            padding: 8px 16px;
            background: #007aff;
            color: #ffffff;
            border: none;
            border-radius: 8px;
            font-size: 0.9375rem;
            font-weight: 500;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.15s ease;
            box-shadow: 0 1px 3px rgba(0,122,255,0.2);
        }

        .primary-action-btn:hover {
            background: #0051d5;
            box-shadow: 0 2px 8px rgba(0,122,255,0.3);
        }

        .primary-action-btn:active {
            transform: scale(0.98);
        }

        .section-with-sidebar {
            display: flex;
            gap: 20px;
            min-height: calc(100vh - 200px);
        }

        .column-list-sidebar {
            min-width: 280px;
            width: fit-content;
            max-width: 400px;
            background: #ffffff;
            border-radius: 12px;
            padding: 0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04), 0 4px 16px rgba(0,0,0,0.06);
            align-self: stretch;
            display: flex;
            flex-direction: column;
        }

        .column-list-header {
            padding: 20px 8px 12px 8px;
            border-bottom: 1px solid rgba(0,0,0,0.06);
            display: flex;
            align-items: center;
        }

        .column-list-header-labels {
            display: flex;
            align-items: center;
            width: 100%;
            padding: 0 8px;
        }

        .column-list-header-labels .drag-spacer {
            width: 28px; /* drag handle 20px + margin 8px */
            flex-shrink: 0;
        }

        .column-list-header-labels .column-label {
            width: 24px; /* checkbox 16px + margin 8px */
            font-size: 0.8125rem;
            font-weight: 600;
            color: #86868b;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            flex-shrink: 0;
        }

        .column-list-header-labels .name-spacer {
            flex: 1;
        }

        .column-list-header-labels .sort-label {
            width: 32px;
            text-align: center;
            font-size: 0.8125rem;
            font-weight: 600;
            color: #86868b;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            flex-shrink: 0;
        }

        .column-list-header-labels .filter-label {
            width: 80px;
            text-align: center;
            font-size: 0.8125rem;
            font-weight: 600;
            color: #86868b;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            flex-shrink: 0;
            margin-left: 8px;
        }

        .column-list {
            list-style: none;
            padding: 8px 8px 16px 8px;
            margin: 0;
            overflow-y: auto;
            flex: 1;
        }

        .column-item {
            display: flex;
            align-items: center;
            padding: 10px 8px;
            margin-bottom: 0;
            background: transparent;
            border: none;
            transition: all 0.15s ease;
            cursor: pointer;
        }

        .column-item:hover {
            background: rgba(0,0,0,0.04);
        }

        .column-item.selected {
            background: rgba(0,122,255,0.1);
        }

        .column-item.dragging {
            opacity: 0.4;
            cursor: grabbing;
        }

        .column-item.drag-over-top {
            box-shadow: inset 0 2px 0 0 #007aff;
        }

        .column-item.drag-over-bottom {
            box-shadow: inset 0 -2px 0 0 #007aff;
        }

        .drag-handle {
            width: 20px;
            height: 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: grab;
            margin-right: 8px;
            color: #86868b;
            user-select: none;
            transition: color 0.15s ease;
        }

        .column-item:hover .drag-handle {
            color: #1d1d1f;
        }

        .drag-handle:active {
            cursor: grabbing;
        }

        .drag-handle::before {
            content: '⋮⋮';
            font-size: 0.875rem;
            letter-spacing: -2px;
            line-height: 1;
        }

        .column-checkbox {
            margin: 0 8px 0 0;
            cursor: pointer;
            width: 16px;
            height: 16px;
            accent-color: #007aff;
        }

        .column-name {
            flex: 1;
            font-size: 0.9375rem;
            font-weight: 400;
            color: #1d1d1f;
            cursor: pointer;
            user-select: none;
            line-height: 1.4;
            white-space: nowrap;
            min-width: 0;
        }

        .sort-control {
            width: 32px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border-radius: 6px;
            color: #86868b;
            font-size: 0.875rem;
            transition: all 0.15s ease;
            flex-shrink: 0;
        }

        .sort-control:hover {
            background: rgba(0,0,0,0.06);
        }

        .sort-control.active {
            color: #007aff;
            background: rgba(0,122,255,0.08);
        }

        .filter-display {
            width: 80px;
            margin-left: 8px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .filter-add-btn {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border-radius: 4px;
            color: #86868b;
            font-size: 1rem;
            transition: all 0.15s ease;
            border: none;
            background: transparent;
            padding: 0;
        }

        .filter-add-btn:hover {
            background: rgba(0,0,0,0.06);
            color: #1d1d1f;
        }

        .filter-value-chip {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 6px;
            background: rgba(0,122,255,0.1);
            border: 1px solid rgba(0,122,255,0.2);
            border-radius: 4px;
            font-size: 0.6875rem;
            color: #007aff;
            font-family: 'SF Mono', Monaco, monospace;
            cursor: pointer;
            transition: all 0.15s ease;
            max-width: 76px;
        }

        .filter-value-chip:hover {
            background: rgba(0,122,255,0.15);
        }

        .filter-value-text {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .filter-value-remove {
            cursor: pointer;
            opacity: 0.6;
            transition: opacity 0.15s ease;
            font-size: 0.75rem;
            line-height: 1;
            flex-shrink: 0;
        }

        .filter-value-remove:hover {
            opacity: 1;
        }

        .section-main-content {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
        }

        .section-main-content .card {
            background: #ffffff;
            border-radius: 12px;
            padding: 0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04), 0 4px 16px rgba(0,0,0,0.06);
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        /* Filter Modal */
        .filter-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.4);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(8px);
        }

        .filter-modal-overlay.active {
            display: flex;
        }

        .filter-modal {
            background: #ffffff;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 480px;
            padding: 0;
            animation: modalSlideIn 0.2s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: scale(0.95) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .filter-modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid rgba(0,0,0,0.06);
        }

        .filter-modal-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1d1d1f;
            margin: 0;
        }

        .filter-modal-body {
            padding: 24px;
        }

        .filter-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid rgba(0,0,0,0.12);
            border-radius: 8px;
            font-size: 0.9375rem;
            font-family: 'SF Mono', Monaco, 'Courier New', monospace;
            background: #fafafa;
            transition: all 0.15s ease;
            margin-bottom: 12px;
        }

        .filter-input:focus {
            outline: none;
            border-color: #007aff;
            background: #ffffff;
            box-shadow: 0 0 0 3px rgba(0,122,255,0.1);
        }

        .filter-hint {
            font-size: 0.8125rem;
            color: #86868b;
            line-height: 1.5;
            white-space: pre-wrap;
            margin: 0;
        }

        .filter-error {
            font-size: 0.8125rem;
            color: #ff3b30;
            margin-top: 8px;
            display: none;
        }

        .filter-error.visible {
            display: block;
        }

        /* Add Root Modal */
        .add-root-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.4);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(8px);
        }

        .add-root-modal-overlay.active {
            display: flex;
        }

        .add-root-modal {
            background: #ffffff;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 540px;
            padding: 0;
            animation: modalSlideIn 0.2s ease;
        }

        .add-root-modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid rgba(0,0,0,0.08);
        }

        .add-root-modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1d1d1f;
            margin: 0;
        }

        .add-root-modal-body {
            padding: 24px;
        }

        .add-root-form-group {
            margin-bottom: 20px;
        }

        .add-root-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: #1d1d1f;
            margin-bottom: 8px;
        }

        .add-root-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid rgba(0,0,0,0.12);
            border-radius: 8px;
            font-size: 0.9375rem;
            font-family: -apple-system, BlinkMacSystemFont, 'SF Mono', 'Monaco', 'Courier New', monospace;
            background: #fafafa;
            transition: all 0.15s ease;
        }

        .add-root-input:focus {
            outline: none;
            border-color: #007aff;
            background: #ffffff;
            box-shadow: 0 0 0 3px rgba(0,122,255,0.1);
        }

        .add-root-hint {
            font-size: 0.8125rem;
            color: #86868b;
            margin-top: 8px;
        }

        .add-root-error {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            padding: 12px;
            background: #fff5f5;
            border: 1px solid rgba(255,59,48,0.2);
            border-radius: 8px;
            margin-top: 12px;
            display: none;
        }

        .add-root-error.visible {
            display: flex;
        }

        .add-root-error-icon {
            color: #ff3b30;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .add-root-error-text {
            font-size: 0.875rem;
            color: #ff3b30;
            line-height: 1.4;
        }

        .add-root-success {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px;
            background: #f0fdf4;
            border: 1px solid rgba(34,197,94,0.2);
            border-radius: 8px;
            margin-top: 12px;
            display: none;
        }

        .add-root-success.visible {
            display: flex;
        }

        .add-root-success-icon {
            color: #22c55e;
            flex-shrink: 0;
        }

        .add-root-success-text {
            font-size: 0.875rem;
            color: #15803d;
            line-height: 1.4;
        }

        .add-root-modal-footer {
            padding: 16px 24px;
            border-top: 1px solid rgba(0,0,0,0.08);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .add-root-btn-cancel {
            padding: 8px 16px;
            border: 1px solid rgba(0,0,0,0.12);
            background: #ffffff;
            border-radius: 8px;
            font-size: 0.9375rem;
            font-weight: 500;
            color: #1d1d1f;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .add-root-btn-cancel:hover {
            background: #f5f5f7;
            border-color: rgba(0,0,0,0.18);
        }

        .add-root-btn-submit {
            padding: 8px 16px;
            background: #007aff;
            color: #ffffff;
            border: none;
            border-radius: 8px;
            font-size: 0.9375rem;
            font-weight: 500;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.15s ease;
            box-shadow: 0 1px 3px rgba(0,122,255,0.2);
        }

        .add-root-btn-submit:hover:not(:disabled) {
            background: #0051d5;
            box-shadow: 0 2px 8px rgba(0,122,255,0.3);
        }

        .add-root-btn-submit:active:not(:disabled) {
            transform: scale(0.98);
        }

        .add-root-btn-submit:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Manage Roots Table - Multi-line entries */
        .root-entry-row {
            cursor: default;
        }

        .root-entry-row:hover {
            background: rgba(0,0,0,0.02);
        }

        .root-entry-cell {
            padding: 16px !important;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .root-entry-content {
            flex: 1;
            min-width: 0;
        }

        .root-path {
            font-size: 0.9375rem;
            font-weight: 600;
            color: #1d1d1f;
            font-family: 'SF Mono', Monaco, 'Courier New', monospace;
            margin-bottom: 6px;
            word-break: break-all;
        }

        .root-scan-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
            font-size: 0.875rem;
            color: #86868b;
        }

        .root-scan-badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8125rem;
            font-weight: 500;
            white-space: nowrap;
        }

        .scan-status-completed {
            background: #f0fdf4;
            color: #15803d;
            border: 1px solid rgba(34,197,94,0.2);
        }

        .scan-status-scanning,
        .scan-status-sweeping,
        .scan-status-analyzing {
            background: #eff6ff;
            color: #1e40af;
            border: 1px solid rgba(59,130,246,0.2);
        }

        .scan-status-pending {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid rgba(245,158,11,0.2);
        }

        .scan-status-incomplete {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid rgba(245,158,11,0.2);
        }

        .scan-status-stopped {
            background: #fff5f5;
            color: #991b1b;
            border: 1px solid rgba(255,59,48,0.2);
        }

        .scan-status-unknown {
            background: #f5f5f7;
            color: #86868b;
            border: 1px solid rgba(0,0,0,0.12);
        }

        .root-never-scanned {
            color: #86868b;
            font-style: italic;
        }

        .root-scan-meta {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .root-action-placeholder {
            width: 100px;
            flex-shrink: 0;
            /* Reserved for future action button */
        }

        .filter-modal-footer {
            padding: 16px 24px;
            border-top: 1px solid rgba(0,0,0,0.06);
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }

        .modal-btn {
            padding: 8px 16px;
            border: 1px solid rgba(0,0,0,0.12);
            background: #ffffff;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            font-family: inherit;
            transition: all 0.15s ease;
        }

        .modal-btn:hover {
            background: #f5f5f7;
            border-color: rgba(0,0,0,0.18);
        }

        .modal-btn.primary {
            background: #007aff;
            border-color: #007aff;
            color: #ffffff;
        }

        .modal-btn.primary:hover {
            background: #0051d5;
            border-color: #0051d5;
        }

        .modal-btn:active {
            transform: scale(0.97);
        }

        .alert-item {
            padding: 0.75rem 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .alert-item:last-child {
            border-bottom: none;
        }

        .alert-severity {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            margin-right: 0.5rem;
        }

        .severity-high {
            background: #ffebee;
            color: #c62828;
        }

        .severity-medium {
            background: #fff3e0;
            color: #ef6c00;
        }

        .severity-low {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .loading {
            color: #666;
            font-style: italic;
        }

        .scan-card {
            background: #ffffff;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04), 0 4px 16px rgba(0,0,0,0.06);
            transition: all 0.15s ease;
        }

        .scan-card:hover {
            box-shadow: 0 2px 6px rgba(0,0,0,0.06), 0 6px 20px rgba(0,0,0,0.08);
        }

        .scan-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
            gap: 16px;
        }

        .scan-title {
            font-size: 1rem;
            font-weight: 500;
            color: #1d1d1f;
            font-family: 'SF Mono', Monaco, monospace;
            flex: 1;
        }

        .scan-progress-section {
            margin-bottom: 12px;
        }

        .scan-progress-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 0.875rem;
            color: #86868b;
        }

        .scan-progress-bar-container {
            width: 100%;
            height: 6px;
            background: rgba(0,0,0,0.06);
            border-radius: 3px;
            overflow: hidden;
        }

        .scan-progress-bar {
            height: 100%;
            background: #007aff;
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .scan-stats {
            font-size: 0.9375rem;
            color: #1d1d1f;
            margin-top: 8px;
        }

        .scan-details-toggle {
            margin-top: 12px;
            padding: 6px 12px;
            border: none;
            background: none;
            color: #007aff;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .scan-details-toggle:hover {
            background: rgba(0,122,255,0.08);
        }

        .scan-details-toggle .chevron {
            transition: transform 0.2s ease;
            font-size: 0.75rem;
            display: inline-block;
        }

        .scan-details-toggle.expanded .chevron {
            transform: rotate(90deg);
        }

        .scan-thread-details {
            margin-top: 12px;
            padding: 12px;
            background: #fafafa;
            border-radius: 8px;
            display: none;
        }

        .scan-thread-details.visible {
            display: block;
        }

        .scan-thread-item {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(0,0,0,0.06);
            font-size: 0.875rem;
        }

        .scan-thread-item:last-child {
            border-bottom: none;
        }

        .scan-thread-status {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            margin-right: 12px;
            width: 80px;
            flex-shrink: 0;
            text-align: center;
        }

        .scan-thread-status.scanning,
        .scan-thread-status.hashing,
        .scan-thread-status.validating {
            background: rgba(52,199,89,0.15);
            color: #34c759;
        }

        .scan-thread-status.idle {
            background: rgba(134,134,139,0.15);
            color: #86868b;
        }

        .scan-thread-file {
            flex: 1;
            color: #1d1d1f;
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 0.8125rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .no-scans-state {
            background: #ffffff;
            border-radius: 12px;
            padding: 32px;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04), 0 4px 16px rgba(0,0,0,0.06);
        }

        .no-scans-state h3 {
            margin-bottom: 16px;
        }

        .start-scan-btn {
            padding: 10px 20px;
            border: none;
            background: #007aff;
            color: #ffffff;
            border-radius: 8px;
            font-size: 0.9375rem;
            font-weight: 500;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.15s ease;
        }

        .start-scan-btn:hover {
            background: #0051d5;
        }

        .start-scan-btn:active {
            transform: scale(0.98);
        }

        .scan-stop-btn {
            padding: 10px 20px;
            border: none;
            background: #ff3b30;
            color: #ffffff;
            border-radius: 8px;
            font-size: 0.9375rem;
            font-weight: 500;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.15s ease;
        }

        .scan-stop-btn:hover {
            background: #e32b1f;
        }

        .scan-stop-btn:active {
            transform: scale(0.98);
        }

        .scan-stop-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .scan-stop-btn:disabled:hover {
            background: #ff3b30;
        }

        /* Responsive design */
        @media (max-width: 480px) {
            .hamburger {
                display: block;
            }

            .sidebar {
                position: fixed;
                left: -250px;
                top: 80px;
                height: calc(100vh - 80px);
                z-index: 1000;
                width: 240px;
                transition: left 0.3s ease;
            }

            .sidebar.open {
                left: 0;
            }

            .sidebar:hover {
                width: 240px;
            }

            .main-content {
                padding: 1rem;
            }

            .overview-modules {
                gap: 1rem;
            }
        }

        /* Query Tab Styles */
        .execute-query-btn {
            padding: 0.625rem 1.25rem;
            background: #0071e3;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.9375rem;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .execute-query-btn:hover {
            background: #0077ED;
        }

        .execute-query-btn:active {
            background: #006EDB;
        }

        .execute-query-btn:disabled {
            background: #d2d2d7;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <header class="header">
        <h1 class="header-title">FsPulse</h1>

        <!-- Minimal Scan Progress (inline in header) -->
        <div id="scan-header-progress" class="scan-header-progress" style="display: none;">
            <div class="scan-header-content">
                <div class="scan-header-line1">
                    <span id="scan-header-status">Scanning</span>: <span id="scan-header-path">-</span>
                </div>
                <div class="scan-header-line2">
                    <span id="scan-header-phase">Discovery</span> •
                    <span id="scan-header-items">0 items</span> •
                    <div class="scan-header-bar">
                        <div class="scan-header-bar-fill" id="scan-header-bar-fill" style="width: 0%"></div>
                    </div>
                    <span id="scan-header-percentage">0%</span>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <nav class="sidebar" id="sidebar">
            <!-- Main Navigation -->
            <button class="nav-item active" onclick="showSection('overview')">
                <svg class="nav-icon" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" />
                </svg>
                <span class="nav-label">Overview</span>
            </button>
            <button class="nav-item" onclick="showSection('scans')">
                <svg class="nav-icon" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M9 9a2 2 0 114 0 2 2 0 01-4 0z" />
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-13a4 4 0 00-3.446 6.032l-2.261 2.26a1 1 0 101.414 1.415l2.261-2.261A4 4 0 1011 5z" clip-rule="evenodd" />
                </svg>
                <span class="nav-label">Scans</span>
            </button>
            <button class="nav-item" onclick="showSection('insights')">
                <svg class="nav-icon" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M11 3a1 1 0 10-2 0v1a1 1 0 102 0V3zM15.657 5.757a1 1 0 00-1.414-1.414l-.707.707a1 1 0 001.414 1.414l.707-.707zM18 10a1 1 0 01-1 1h-1a1 1 0 110-2h1a1 1 0 011 1zM5.05 6.464A1 1 0 106.464 5.05l-.707-.707a1 1 0 00-1.414 1.414l.707.707zM5 10a1 1 0 01-1 1H3a1 1 0 110-2h1a1 1 0 011 1zM8 16v-1h4v1a2 2 0 11-4 0zM12 14c.015-.34.208-.646.477-.859a4 4 0 10-4.954 0c.27.213.462.519.476.859h4.002z" />
                </svg>
                <span class="nav-label">Insights</span>
            </button>
            <button class="nav-item" onclick="showSection('explore')">
                <svg class="nav-icon" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M9 9a2 2 0 114 0 2 2 0 01-4 0z" />
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-13a4 4 0 00-3.446 6.032l-2.261 2.26a1 1 0 101.414 1.415l2.261-2.261A4 4 0 1011 5z" clip-rule="evenodd" />
                </svg>
                <span class="nav-label">Explore</span>
            </button>

            <div class="nav-divider"></div>

            <!-- Settings -->
            <button class="nav-item" onclick="showSection('settings')">
                <svg class="nav-icon" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" />
                </svg>
                <span class="nav-label">Settings</span>
            </button>
        </nav>

        <main class="main-content">
            <div id="overview-section">
                <h2 style="margin-bottom: 1.5rem;">Overview</h2>

                <div class="overview-modules">
                    <div class="card">
                        <h3>
                            📈 System Status
                        </h3>
                        <div id="status-summary" class="loading">Loading status...</div>
                    </div>

                    <div class="card">
                        <h3>
                            🚨 Active Alerts
                            <a href="#" class="module-link" onclick="showSection('alerts')">View All →</a>
                        </h3>
                        <div id="alerts-summary" class="loading">Loading alerts...</div>
                    </div>

                    <div class="card">
                        <h3>
                            📊 Current Activity
                            <a href="#" class="module-link" onclick="showSection('activity')">View All →</a>
                        </h3>
                        <div id="activity-summary" class="loading">Loading activity...</div>
                    </div>

                    <div class="card">
                        <h3>
                            📋 Recent Activity
                            <a href="#" class="module-link" onclick="showSection('activity')">View All →</a>
                        </h3>
                        <div id="recent-activity" class="loading">Loading recent activity...</div>
                    </div>
                </div>
            </div>

            <!-- Insights Section -->
            <div id="insights-section" style="display: none;">
                <div class="entity-view-header">
                    <h1 class="entity-view-title">Insights</h1>
                </div>

                <!-- Tab Bar -->
                <div class="insights-tabs">
                    <button class="insights-tab" onclick="showInsightsTab('alerts')">Alerts</button>
                    <button class="insights-tab" onclick="showInsightsTab('statistics')">Statistics</button>
                    <button class="insights-tab" onclick="showInsightsTab('changes')">Changes</button>
                </div>

                <!-- Context Filter Toolbar -->
                <div class="context-filter-toolbar">
                    <label class="context-filter-label">Context:</label>
                    <select class="context-filter-select" id="insights-context-filter" onchange="handleInsightsContextChange()">
                        <option value="all">All Data</option>
                        <option value="root">By Root</option>
                        <option value="scan">By Scan ID</option>
                    </select>
                    <input type="text"
                           id="insights-context-value"
                           class="context-filter-select"
                           style="display: none; flex: 1;"
                           placeholder=""
                           onkeyup="debounceInsightsContextFilter()">
                </div>

                <!-- Alerts Tab -->
                <div id="insights-alerts" class="insights-tab-content">
                    <!-- Filter Toolbar -->
                    <div class="insights-alerts-filters">
                        <div class="filter-group">
                            <label>Status:</label>
                            <select id="insights-alerts-status-filter" onchange="loadInsightsAlerts()">
                                <option value="">All Status</option>
                                <option value="O" selected>Open</option>
                                <option value="F">Flagged</option>
                                <option value="D">Dismissed</option>
                            </select>
                        </div>

                        <div class="filter-group">
                            <label>Type:</label>
                            <select id="insights-alerts-type-filter" onchange="loadInsightsAlerts()">
                                <option value="">All Types</option>
                                <option value="H">Suspicious Hash</option>
                                <option value="I">Invalid Item</option>
                            </select>
                        </div>

                        <div class="filter-group" style="flex: 1;">
                            <label>Path:</label>
                            <input type="text" id="insights-alerts-search" placeholder="Search file paths..." onkeyup="debounceInsightsAlertsSearch()">
                        </div>

                        <button class="action-btn" onclick="loadInsightsAlerts()" title="Refresh">
                            <svg width="16" height="16" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>

                    <!-- Alerts Table -->
                    <div class="card">
                        <table class="insights-alerts-table">
                            <thead>
                                <tr>
                                    <th style="width: 170px; min-width: 170px;">Status</th>
                                    <th style="width: 130px;">Alert Type</th>
                                    <th style="width: 80px;">Root ID</th>
                                    <th style="width: 80px;">Scan ID</th>
                                    <th>File Path</th>
                                    <th style="width: 250px;">Details</th>
                                    <th style="width: 110px;">Created</th>
                                </tr>
                            </thead>
                            <tbody id="insights-alerts-table-body">
                                <tr>
                                    <td colspan="5" style="text-align: center; padding: 2rem; color: #86868b;">
                                        Loading alerts...
                                    </td>
                                </tr>
                            </tbody>
                        </table>

                        <div class="pagination">
                            <div class="pagination-info" id="insights-alerts-pagination-info">
                                Showing 0 - 0 of 0 alerts
                            </div>
                            <div class="pagination-controls">
                                <button class="pagination-btn" id="insights-alerts-prev-btn" onclick="changeInsightsAlertsPage(-1)">Previous</button>
                                <button class="pagination-btn" id="insights-alerts-next-btn" onclick="changeInsightsAlertsPage(1)">Next</button>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- End Alerts Tab -->

                <!-- Statistics Tab -->
                <div id="insights-statistics" class="insights-tab-content">
                    <div class="card">
                        <h3>Largest Files</h3>
                        <div id="insights-largest-files" class="insights-content">
                            <p style="color: #86868b;">Loading largest files...</p>
                        </div>
                    </div>

                    <div class="card" style="margin-top: 24px;">
                        <h3>File Type Distribution</h3>
                        <div id="insights-file-types" class="insights-content">
                            <p style="color: #86868b;">Loading file type distribution...</p>
                        </div>
                    </div>

                    <div class="card" style="margin-top: 24px;">
                        <h3>Validation Issues</h3>
                        <div id="insights-validation-issues" class="insights-content">
                            <p style="color: #86868b;">Loading validation issues...</p>
                        </div>
                    </div>
                </div>
                <!-- End Statistics Tab -->

                <!-- Changes Tab -->
                <div id="insights-changes" class="insights-tab-content">
                    <div class="card">
                        <h3>Recent Changes</h3>
                        <div id="insights-recent-changes" class="insights-content">
                            <p style="color: #86868b;">Loading recent changes...</p>
                        </div>
                    </div>

                    <div class="card" style="margin-top: 24px;">
                        <h3>Most Active Files</h3>
                        <div id="insights-active-files" class="insights-content">
                            <p style="color: #86868b;">Loading most active files...</p>
                        </div>
                    </div>

                    <div class="card" style="margin-top: 24px;">
                        <h3>Hash Changes</h3>
                        <div id="insights-hash-changes" class="insights-content">
                            <p style="color: #86868b;">Loading hash changes...</p>
                        </div>
                    </div>
                </div>
                <!-- End Changes Tab -->

            </div>

            <!-- Scans Section (Active Scan + Root Management) -->
            <div id="scans-section" style="display: none;">
                <h1 class="entity-view-title" style="margin-bottom: 1.5rem;">Scan</h1>

                <!-- Active Scan Progress (Large view for details) -->
                <div id="scans-active-scan-container">
                    <!-- Will be populated by JavaScript when scan is active -->
                </div>

                <!-- Roots Section -->
                <div class="entity-view-header" style="margin-top: 2rem;">
                    <h2 style="font-size: 1.25rem; font-weight: 600; color: #1d1d1f;">Roots</h2>
                    <button class="primary-action-btn" onclick="showAddRootModal()">
                        <svg width="16" height="16" viewBox="0 0 20 20" fill="currentColor" style="margin-right: 6px;">
                            <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                        </svg>
                        Add Root
                    </button>
                </div>

                <div class="card">
                    <table class="data-table">
                        <tbody id="manage-roots-table-body">
                            <tr>
                                <td style="text-align: center; color: #86868b; padding: 2rem;">
                                    Loading roots...
                                </td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="pagination">
                        <div class="pagination-info" id="manage-roots-pagination-info">
                            Showing 0 - 0 of 0 roots
                        </div>
                        <div class="pagination-controls">
                            <button class="pagination-btn" id="manage-roots-prev-btn" onclick="changeManageRootsPage(-1)">Previous</button>
                            <button class="pagination-btn" id="manage-roots-next-btn" onclick="changeManageRootsPage(1)">Next</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Explore Section with Tabs -->
            <div id="explore-section" style="display: none;">
                <div class="entity-view-header">
                    <h1 class="entity-view-title">Explore</h1>
                </div>

                <!-- Tab Bar -->
                <div class="explore-tabs">
                    <button class="explore-tab" onclick="showExploreTab('roots')">Roots</button>
                    <button class="explore-tab" onclick="showExploreTab('scans')">Scans</button>
                    <button class="explore-tab" onclick="showExploreTab('items')">Items</button>
                    <button class="explore-tab" onclick="showExploreTab('changes')">Changes</button>
                    <button class="explore-tab" onclick="showExploreTab('alerts')">Alerts</button>
                    <button class="explore-tab" onclick="showExploreTab('query')">Query</button>
                </div>

                <!-- Roots Tab -->
                <div id="explore-roots" class="explore-tab-content">

                <div class="section-with-sidebar">
                    <!-- Column List Sidebar -->
                    <aside class="column-list-sidebar">
                        <div class="column-list-header">
                            <div class="column-list-header-labels">
                                <div class="drag-spacer"></div>
                                <div class="column-label">Column</div>
                                <div class="name-spacer"></div>
                                <div class="sort-label">Sort</div>
                                <div class="filter-label">Filter</div>
                            </div>
                        </div>
                        <ul class="column-list" id="roots-column-list">
                            <li style="text-align: center; color: #86868b; padding: 1rem; font-size: 0.875rem;">Loading columns...</li>
                        </ul>
                    </aside>

                    <!-- Main Content Area -->
                    <div class="section-main-content">
                        <div class="card">
                            <table class="data-table">
                                <thead>
                                    <tr id="roots-table-header">
                                        <th colspan="2">Loading...</th>
                                    </tr>
                                </thead>
                                <tbody id="roots-table-body">
                                    <tr><td colspan="2">Loading...</td></tr>
                                </tbody>
                            </table>

                            <div class="pagination">
                                <div class="pagination-info" id="roots-pagination-info">
                                    Showing 0 - 0 of 0 roots
                                </div>
                                <div class="pagination-controls">
                                    <button class="pagination-btn" id="roots-prev-btn" onclick="changeRootsPage(-1)">Previous</button>
                                    <button class="pagination-btn" id="roots-next-btn" onclick="changeRootsPage(1)">Next</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                </div>
                <!-- End Roots Tab -->

                <!-- Scans Tab -->
                <div id="explore-scans" class="explore-tab-content">
                <div class="section-with-sidebar">
                    <!-- Column List Sidebar -->
                    <aside class="column-list-sidebar">
                        <div class="column-list-header">
                            <div class="column-list-header-labels">
                                <div class="drag-spacer"></div>
                                <div class="column-label">Column</div>
                                <div class="name-spacer"></div>
                                <div class="sort-label">Sort</div>
                                <div class="filter-label">Filter</div>
                            </div>
                        </div>
                        <ul class="column-list" id="scans-column-list">
                            <li style="text-align: center; color: #86868b; padding: 1rem; font-size: 0.875rem;">Loading columns...</li>
                        </ul>
                    </aside>

                    <!-- Main Content Area -->
                    <div class="section-main-content">
                        <div class="card">
                            <table class="data-table">
                                <thead>
                                    <tr id="scans-table-header">
                                        <th colspan="9">Loading...</th>
                                    </tr>
                                </thead>
                                <tbody id="scans-table-body">
                                    <tr><td colspan="9">Loading...</td></tr>
                                </tbody>
                            </table>

                            <div class="pagination">
                                <div class="pagination-info" id="scans-pagination-info">
                                    Showing 0 - 0 of 0 scans
                                </div>
                                <div class="pagination-controls">
                                    <button class="pagination-btn" id="scans-prev-btn" onclick="changeScansPage(-1)">Previous</button>
                                    <button class="pagination-btn" id="scans-next-btn" onclick="changeScansPage(1)">Next</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                </div>
                <!-- End Scans Tab -->

                <!-- Items Tab -->
                <div id="explore-items" class="explore-tab-content">
                <div class="section-with-sidebar">
                    <!-- Column List Sidebar -->
                    <aside class="column-list-sidebar">
                        <div class="column-list-header">
                            <div class="column-list-header-labels">
                                <div class="drag-spacer"></div>
                                <div class="column-label">Column</div>
                                <div class="name-spacer"></div>
                                <div class="sort-label">Sort</div>
                                <div class="filter-label">Filter</div>
                            </div>
                        </div>
                        <ul class="column-list" id="items-column-list">
                            <li style="text-align: center; color: #86868b; padding: 1rem; font-size: 0.875rem;">Loading columns...</li>
                        </ul>
                    </aside>

                    <!-- Main Content Area -->
                    <div class="section-main-content">
                        <div class="card">
                            <table class="data-table">
                                <thead>
                                    <tr id="items-table-header">
                                        <th colspan="5">Loading...</th>
                                    </tr>
                                </thead>
                                <tbody id="items-table-body">
                                    <tr><td colspan="5">Loading...</td></tr>
                                </tbody>
                            </table>

                            <div class="pagination">
                                <div class="pagination-info" id="items-pagination-info">
                                    Showing 0 - 0 of 0 items
                                </div>
                                <div class="pagination-controls">
                                    <button class="pagination-btn" id="items-prev-btn" onclick="changeItemsPage(-1)">Previous</button>
                                    <button class="pagination-btn" id="items-next-btn" onclick="changeItemsPage(1)">Next</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                </div>
                <!-- End Items Tab -->

                <!-- Changes Tab -->
                <div id="explore-changes" class="explore-tab-content">
                <div class="section-with-sidebar">
                    <!-- Column List Sidebar -->
                    <aside class="column-list-sidebar">
                        <div class="column-list-header">
                            <div class="column-list-header-labels">
                                <div class="drag-spacer"></div>
                                <div class="column-label">Column</div>
                                <div class="name-spacer"></div>
                                <div class="sort-label">Sort</div>
                                <div class="filter-label">Filter</div>
                            </div>
                        </div>
                        <ul class="column-list" id="changes-column-list">
                            <li style="text-align: center; color: #86868b; padding: 1rem; font-size: 0.875rem;">Loading columns...</li>
                        </ul>
                    </aside>

                    <!-- Main Content Area -->
                    <div class="section-main-content">
                        <div class="card">
                            <table class="data-table">
                                <thead>
                                    <tr id="changes-table-header">
                                        <th colspan="5">Loading...</th>
                                    </tr>
                                </thead>
                                <tbody id="changes-table-body">
                                    <tr><td colspan="5">Loading...</td></tr>
                                </tbody>
                            </table>

                            <div class="pagination">
                                <div class="pagination-info" id="changes-pagination-info">
                                    Showing 0 - 0 of 0 changes
                                </div>
                                <div class="pagination-controls">
                                    <button class="pagination-btn" id="changes-prev-btn" onclick="changeChangesPage(-1)">Previous</button>
                                    <button class="pagination-btn" id="changes-next-btn" onclick="changeChangesPage(1)">Next</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                </div>
                <!-- End Changes Tab -->

                <!-- Alerts Tab -->
                <div id="explore-alerts" class="explore-tab-content">
                <div class="section-with-sidebar">
                    <!-- Column List Sidebar -->
                    <aside class="column-list-sidebar">
                        <div class="column-list-header">
                            <div class="column-list-header-labels">
                                <div class="drag-spacer"></div>
                                <div class="column-label">Column</div>
                                <div class="name-spacer"></div>
                                <div class="sort-label">Sort</div>
                                <div class="filter-label">Filter</div>
                            </div>
                        </div>
                        <ul class="column-list" id="alerts-column-list">
                            <li style="text-align: center; color: #86868b; padding: 1rem; font-size: 0.875rem;">Loading columns...</li>
                        </ul>
                    </aside>

                    <!-- Main Content Area -->
                    <div class="section-main-content">
                        <div class="card">
                            <table class="data-table">
                                <thead>
                                    <tr id="alerts-table-header">
                                        <th colspan="5">Loading...</th>
                                    </tr>
                                </thead>
                                <tbody id="alerts-table-body">
                                    <tr><td colspan="5">Loading...</td></tr>
                                </tbody>
                            </table>

                            <div class="pagination">
                                <div class="pagination-info" id="alerts-pagination-info">
                                    Showing 0 - 0 of 0 alerts
                                </div>
                                <div class="pagination-controls">
                                    <button class="pagination-btn" id="alerts-prev-btn" onclick="changeAlertsPage(-1)">Previous</button>
                                    <button class="pagination-btn" id="alerts-next-btn" onclick="changeAlertsPage(1)">Next</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                </div>
                <!-- End Alerts Tab -->

                <!-- Query Tab -->
                <div id="explore-query" class="explore-tab-content">
                    <div style="padding: 2rem;">
                        <div class="card">
                            <div style="padding: 1.5rem;">
                                <h3 style="font-size: 1.125rem; font-weight: 600; margin-bottom: 1rem; color: #1d1d1f;">Execute FsPulse Query</h3>

                                <!-- Query Input -->
                                <div style="margin-bottom: 1rem;">
                                    <textarea
                                        id="query-input"
                                        placeholder="Enter your FsPulse query here... (e.g., items where item_type:(F) show item_path, file_size limit 10)"
                                        style="width: 100%; min-height: 120px; padding: 0.75rem; font-family: 'SF Mono', Monaco, 'Courier New', monospace; font-size: 0.875rem; border: 1px solid #d2d2d7; border-radius: 6px; resize: vertical;"
                                    ></textarea>
                                </div>

                                <!-- Action Buttons and Documentation -->
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                    <div style="display: flex; gap: 1rem; align-items: center;">
                                        <button onclick="executeQuery()" class="execute-query-btn">Execute Query</button>
                                        <div id="query-status" style="color: #86868b; font-size: 0.875rem;"></div>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <span style="font-size: 1rem;">📖</span>
                                        <a href="https://gtunes-dev.github.io/fspulse/query.html" target="_blank" style="color: #0071e3; text-decoration: none; font-size: 0.875rem; white-space: nowrap;">Query Documentation</a>
                                    </div>
                                </div>

                                <!-- Error Display -->
                                <div id="query-error-container" style="display: none; margin-bottom: 1rem;">
                                    <div style="background: #fff5f5; border: 1px solid #feb2b2; border-radius: 6px; padding: 1rem;">
                                        <div style="color: #c53030; white-space: pre-wrap; font-family: 'SF Mono', Monaco, 'Courier New', monospace; font-size: 0.875rem; overflow-x: auto;" id="query-error-message"></div>
                                    </div>
                                </div>

                                <!-- Example Queries -->
                                <details style="padding: 1rem; background: #f5f5f7; border-radius: 6px;">
                                    <summary style="cursor: pointer; font-weight: 500; color: #1d1d1f; font-size: 0.875rem;">Example Queries</summary>
                                    <div style="margin-top: 0.75rem; font-size: 0.875rem; color: #1d1d1f; font-family: 'SF Mono', Monaco, monospace;">
                                        <div style="margin-bottom: 0.5rem; cursor: pointer;" onclick="setQueryExample('items limit 10')">
                                            <strong>Basic:</strong> items limit 10
                                        </div>
                                        <div style="margin-bottom: 0.5rem; cursor: pointer;" onclick="setQueryExample('items where item_type:(F) show item_path, file_size limit 25')">
                                            <strong>Filter files:</strong> items where item_type:(F) show item_path, file_size limit 25
                                        </div>
                                        <div style="margin-bottom: 0.5rem; cursor: pointer;" onclick="setQueryExample('items where file_size:(>1000000) show item_path, file_size order by file_size desc limit 20')">
                                            <strong>Large files:</strong> items where file_size:(>1000000) show item_path, file_size order by file_size desc limit 20
                                        </div>
                                        <div style="margin-bottom: 0.5rem; cursor: pointer;" onclick="setQueryExample('alerts where alert_status:(O) show alert_type, item_path, created_at limit 15')">
                                            <strong>Open alerts:</strong> alerts where alert_status:(O) show alert_type, item_path, created_at limit 15
                                        </div>
                                        <div style="cursor: pointer;" onclick="setQueryExample('changes where change_type:(M) show item_path, detected_at order by detected_at desc limit 10')">
                                            <strong>Recent modifications:</strong> changes where change_type:(M) show item_path, detected_at order by detected_at desc limit 10
                                        </div>
                                    </div>
                                </details>
                            </div>
                        </div>

                        <!-- Query Results -->
                        <div id="query-results-container" style="display: none; margin-top: 1.5rem;">
                            <div class="card">
                                <div style="overflow-x: auto;">
                                    <table class="data-table">
                                        <thead>
                                            <tr id="query-results-header"></tr>
                                        </thead>
                                        <tbody id="query-results-body"></tbody>
                                    </table>
                                </div>
                                <div style="padding: 1rem; text-align: center; color: #86868b; font-size: 0.875rem;" id="query-results-info">
                                    0 rows returned
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- End Query Tab -->

            </div>
            <!-- End Explore Section -->

            <!-- Settings Section -->
            <div id="settings-section" style="display: none;">
                <h2>Settings</h2>
                <p>System configuration and preferences...</p>
            </div>
        </main>
    </div>

    <!-- Filter Modals -->
    <!-- Items Filter Modal -->
    <div class="filter-modal-overlay" id="items-filter-modal-overlay" onclick="closeItemsFilterModal()">
        <div class="filter-modal" onclick="event.stopPropagation()">
            <div class="filter-modal-header">
                <h2 class="filter-modal-title" id="items-filter-modal-title">Filter Column</h2>
            </div>
            <div class="filter-modal-body">
                <input type="text" class="filter-input" id="items-filter-input" placeholder="Enter filter value...">
                <p class="filter-hint" id="items-filter-hint">Filter syntax hint will appear here</p>
                <p class="filter-error" id="items-filter-error">Error message</p>
            </div>
            <div class="filter-modal-footer">
                <button class="modal-btn" onclick="closeItemsFilterModal()">Cancel</button>
                <button class="modal-btn primary" onclick="saveItemsFilter()">Apply Filter</button>
            </div>
        </div>
    </div>

    <!-- Roots Filter Modal -->
    <div class="filter-modal-overlay" id="roots-filter-modal-overlay" onclick="closeRootsFilterModal()">
        <div class="filter-modal" onclick="event.stopPropagation()">
            <div class="filter-modal-header">
                <h2 class="filter-modal-title" id="roots-filter-modal-title">Filter Column</h2>
            </div>
            <div class="filter-modal-body">
                <input type="text" class="filter-input" id="roots-filter-input" placeholder="Enter filter value...">
                <p class="filter-hint" id="roots-filter-hint">Filter syntax hint will appear here</p>
                <p class="filter-error" id="roots-filter-error">Error message</p>
            </div>
            <div class="filter-modal-footer">
                <button class="modal-btn" onclick="closeRootsFilterModal()">Cancel</button>
                <button class="modal-btn primary" onclick="saveRootsFilter()">Apply Filter</button>
            </div>
        </div>
    </div>

    <!-- Scans Filter Modal -->
    <div class="filter-modal-overlay" id="scans-filter-modal-overlay" onclick="closeScansFilterModal()">
        <div class="filter-modal" onclick="event.stopPropagation()">
            <div class="filter-modal-header">
                <h2 class="filter-modal-title" id="scans-filter-modal-title">Filter Column</h2>
            </div>
            <div class="filter-modal-body">
                <input type="text" class="filter-input" id="scans-filter-input" placeholder="Enter filter value...">
                <p class="filter-hint" id="scans-filter-hint">Filter syntax hint will appear here</p>
                <p class="filter-error" id="scans-filter-error">Error message</p>
            </div>
            <div class="filter-modal-footer">
                <button class="modal-btn" onclick="closeScansFilterModal()">Cancel</button>
                <button class="modal-btn primary" onclick="saveScansFilter()">Apply Filter</button>
            </div>
        </div>
    </div>

    <!-- Changes Filter Modal -->
    <div class="filter-modal-overlay" id="changes-filter-modal-overlay" onclick="closeChangesFilterModal()">
        <div class="filter-modal" onclick="event.stopPropagation()">
            <div class="filter-modal-header">
                <h2 class="filter-modal-title" id="changes-filter-modal-title">Filter Column</h2>
            </div>
            <div class="filter-modal-body">
                <input type="text" class="filter-input" id="changes-filter-input" placeholder="Enter filter value...">
                <p class="filter-hint" id="changes-filter-hint">Filter syntax hint will appear here</p>
                <p class="filter-error" id="changes-filter-error">Error message</p>
            </div>
            <div class="filter-modal-footer">
                <button class="modal-btn" onclick="closeChangesFilterModal()">Cancel</button>
                <button class="modal-btn primary" onclick="saveChangesFilter()">Apply Filter</button>
            </div>
        </div>
    </div>

    <!-- Alerts Filter Modal -->
    <div class="filter-modal-overlay" id="alerts-filter-modal-overlay" onclick="closeAlertsFilterModal()">
        <div class="filter-modal" onclick="event.stopPropagation()">
            <div class="filter-modal-header">
                <h2 class="filter-modal-title" id="alerts-filter-modal-title">Filter Column</h2>
            </div>
            <div class="filter-modal-body">
                <input type="text" class="filter-input" id="alerts-filter-input" placeholder="Enter filter value...">
                <p class="filter-hint" id="alerts-filter-hint">Filter syntax hint will appear here</p>
                <p class="filter-error" id="alerts-filter-error">Error message</p>
            </div>
            <div class="filter-modal-footer">
                <button class="modal-btn" onclick="closeAlertsFilterModal()">Cancel</button>
                <button class="modal-btn primary" onclick="saveAlertsFilter()">Apply Filter</button>
            </div>
        </div>
    </div>

    <!-- Insights Alerts Filter Modal -->
    <div class="filter-modal-overlay" id="insights-alerts-filter-modal-overlay" onclick="closeInsightsAlertsFilterModal()">
        <div class="filter-modal" onclick="event.stopPropagation()">
            <div class="filter-modal-header">
                <h2 class="filter-modal-title" id="insights-alerts-filter-modal-title">Filter Column</h2>
            </div>
            <div class="filter-modal-body">
                <input type="text" class="filter-input" id="insights-alerts-filter-input" placeholder="Enter filter value...">
                <p class="filter-hint" id="insights-alerts-filter-hint">Filter syntax hint will appear here</p>
                <p class="filter-error" id="insights-alerts-filter-error">Error message</p>
            </div>
            <div class="filter-modal-footer">
                <button class="modal-btn" onclick="closeInsightsAlertsFilterModal()">Cancel</button>
                <button class="modal-btn primary" onclick="saveInsightsAlertsFilter()">Apply Filter</button>
            </div>
        </div>
    </div>

    <!-- Start New Scan Modal -->
    <div class="filter-modal-overlay" id="start-scan-modal-overlay" onclick="closeStartScanModal()">
        <div class="filter-modal" onclick="event.stopPropagation()">
            <div class="filter-modal-header">
                <h2 class="filter-modal-title">Choose Root to Scan</h2>
            </div>
            <div class="filter-modal-body">
                <select id="scan-root-select" class="filter-input" style="font-family: inherit; margin-bottom: 20px;" onchange="handleRootSelection()">
                    <option value="">Loading roots...</option>
                </select>

                <!-- Scan Options (always shown) -->
                <div id="scan-options">
                    <div style="margin-bottom: 16px;">
                        <label style="font-size: 0.875rem; font-weight: 600; color: #1d1d1f; display: block; margin-bottom: 8px;">Hash:</label>
                        <label style="display: inline-flex; align-items: center; margin-right: 16px; cursor: pointer;">
                            <input type="radio" name="hash-mode" value="None" style="margin-right: 6px;">
                            <span style="font-size: 0.875rem;">None</span>
                        </label>
                        <label style="display: inline-flex; align-items: center; margin-right: 16px; cursor: pointer;">
                            <input type="radio" name="hash-mode" value="New" style="margin-right: 6px;">
                            <span style="font-size: 0.875rem;">New or Changed</span>
                        </label>
                        <label style="display: inline-flex; align-items: center; cursor: pointer;">
                            <input type="radio" name="hash-mode" value="All" checked style="margin-right: 6px;">
                            <span style="font-size: 0.875rem;">All</span>
                        </label>
                    </div>

                    <div>
                        <label style="font-size: 0.875rem; font-weight: 600; color: #1d1d1f; display: block; margin-bottom: 8px;">Validate:</label>
                        <label style="display: inline-flex; align-items: center; margin-right: 16px; cursor: pointer;">
                            <input type="radio" name="validate-mode" value="None" style="margin-right: 6px;">
                            <span style="font-size: 0.875rem;">None</span>
                        </label>
                        <label style="display: inline-flex; align-items: center; margin-right: 16px; cursor: pointer;">
                            <input type="radio" name="validate-mode" value="New" checked style="margin-right: 6px;">
                            <span style="font-size: 0.875rem;">New or Changed</span>
                        </label>
                        <label style="display: inline-flex; align-items: center; cursor: pointer;">
                            <input type="radio" name="validate-mode" value="All" style="margin-right: 6px;">
                            <span style="font-size: 0.875rem;">All</span>
                        </label>
                    </div>
                </div>

                <p class="filter-error" id="scan-error">Error message</p>
            </div>
            <div class="filter-modal-footer">
                <button class="modal-btn" onclick="closeStartScanModal()">Cancel</button>
                <button class="modal-btn primary" id="scan-action-btn" onclick="startScan()">Start Scan</button>
            </div>
        </div>
    </div>

    <!-- Add Root Modal -->
    <div class="add-root-modal-overlay" id="add-root-modal-overlay" onclick="hideAddRootModal()">
        <div class="add-root-modal" onclick="event.stopPropagation()">
            <div class="add-root-modal-header">
                <h2 class="add-root-modal-title">Add New Root</h2>
            </div>
            <div class="add-root-modal-body">
                <div class="add-root-form-group">
                    <label class="add-root-label" for="add-root-path-input">Root Path</label>
                    <input
                        type="text"
                        class="add-root-input"
                        id="add-root-path-input"
                        placeholder="/absolute/path/to/directory"
                        autocomplete="off"
                        spellcheck="false">
                    <p class="add-root-hint">Enter the absolute path to the directory you want to track</p>
                </div>

                <div class="add-root-error" id="add-root-error">
                    <svg class="add-root-error-icon" width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                    </svg>
                    <p class="add-root-error-text" id="add-root-error-text">Error message</p>
                </div>

                <div class="add-root-success" id="add-root-success">
                    <svg class="add-root-success-icon" width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                    </svg>
                    <p class="add-root-success-text" id="add-root-success-text">Root added successfully!</p>
                </div>
            </div>
            <div class="add-root-modal-footer">
                <button class="add-root-btn-cancel" onclick="hideAddRootModal()">Cancel</button>
                <button class="add-root-btn-submit" id="add-root-submit-btn" onclick="submitNewRoot()">Add Root</button>
            </div>
        </div>
    </div>

    <script>
        // Minimal Header Scan Progress Functions
        function updateHeaderProgress(data) {
            const header = document.getElementById('scan-header-progress');

            if (!data) {
                header.style.display = 'none';
                return;
            }

            header.style.display = 'block';

            // Update status and path
            document.getElementById('scan-header-status').textContent = data.status;
            document.getElementById('scan-header-path').textContent = data.root_path;
            document.getElementById('scan-header-phase').textContent = data.phase;

            // Phase-based display (matching large progress view)
            if (data.scanPhase === 3) {
                // Analysis phase: show X/Y files and percentage
                const itemsText = `${data.current.toLocaleString()} / ${data.total.toLocaleString()} files`;
                document.getElementById('scan-header-items').textContent = itemsText;

                const percentage = Math.round(data.percentage);
                document.getElementById('scan-header-bar-fill').style.width = percentage + '%';
                document.getElementById('scan-header-percentage').textContent = percentage + '%';
            } else {
                // Scanning/Tombstoning: show file counts, not percentage
                const itemsText = `${data.files.toLocaleString()} files in ${data.directories.toLocaleString()} directories`;
                document.getElementById('scan-header-items').textContent = itemsText;

                // Hide percentage display during scanning phases
                document.getElementById('scan-header-bar-fill').style.width = '0%';
                document.getElementById('scan-header-percentage').textContent = '';
            }
        }

        function hideHeaderProgress() {
            document.getElementById('scan-header-progress').style.display = 'none';
        }

        // Click handler for header progress - navigate to Scans page
        document.addEventListener('DOMContentLoaded', () => {
            const headerProgress = document.getElementById('scan-header-progress');
            if (headerProgress) {
                headerProgress.addEventListener('click', () => {
                    showSection('scans');
                });
            }
        });

        // Load dashboard data
        async function loadDashboardData() {
            try {
                // Load status
                const statusResponse = await fetch('/api/status');
                const statusData = await statusResponse.json();
                document.getElementById('status-summary').innerHTML = `
                    <div>Server: <strong>${statusData.server}</strong></div>
                    <div>Database: <strong>${statusData.database}</strong></div>
                    <div>Active Scans: <strong>${statusData.active_scans}</strong></div>
                `;

                // Load alerts
                const alertsResponse = await fetch('/api/alerts');
                const alertsData = await alertsResponse.json();
                const alertsHtml = alertsData.alerts.slice(0, 3).map(alert => `
                    <div class="alert-item">
                        <span class="alert-severity severity-${alert.severity}">${alert.severity}</span>
                        <div>${alert.message}</div>
                        <small style="color: #666;">${new Date(alert.timestamp).toLocaleString()}</small>
                    </div>
                `).join('');
                document.getElementById('alerts-summary').innerHTML = alertsHtml || '<div>No active alerts</div>';

                // Load activity
                const activityResponse = await fetch('/api/activity');
                const activityData = await activityResponse.json();
                const currentScans = activityData.current_scans;
                const activityHtml = currentScans.length > 0 ?
                    currentScans.map(scan => `
                        <div>Scanning: <strong>${scan.root_path}</strong></div>
                        <div>Progress: <strong>${scan.progress}%</strong> (${scan.files_scanned}/${scan.files_total} files)</div>
                    `).join('') :
                    '<div>No active scans</div>';
                document.getElementById('activity-summary').innerHTML = activityHtml;

                // Load recent activity
                const recentHtml = [
                    ...activityData.recent_scans.slice(0, 3).map(scan => `
                        <div class="alert-item">
                            <div>Completed scan: <strong>${scan.root_path}</strong></div>
                            <small style="color: #666;">
                                ${scan.files_scanned} files scanned in ${scan.duration_seconds}s
                                • ${new Date(scan.completed).toLocaleString()}
                            </small>
                        </div>
                    `),
                    ...activityData.recent_changes.slice(0, 2).map(change => `
                        <div class="alert-item">
                            <div>File ${change.change_type}: <strong>${change.file_path}</strong></div>
                            <small style="color: #666;">${new Date(change.timestamp).toLocaleString()}</small>
                        </div>
                    `)
                ].join('');
                document.getElementById('recent-activity').innerHTML = recentHtml || '<div>No recent activity</div>';

            } catch (error) {
                console.error('Failed to load dashboard data:', error);
                document.querySelectorAll('.loading').forEach(el => {
                    el.innerHTML = '<div style="color: #f44336;">Failed to load data</div>';
                });
            }
        }

        // =============================================================================
        // ScanManager - Manages active scans display and WebSocket updates
        // =============================================================================

        class ScanManager {
            constructor() {
                this.activeScans = new Map(); // scanId -> scan data
                this.ws = null; // Current WebSocket connection
                this.expandedScans = new Set(); // Track which scan details are expanded
                this.currentScanId = null;
                this.scanPhase = 1; // Track current phase (1=scanning, 2=sweeping, 3=analyzing)
                this.threadStates = new Map(); // Track individual thread states
                this.scanningCounts = { files: 0, directories: 0 }; // Track scanning progress
                this.phaseBreadcrumbs = []; // Track completed phases
                this.renderPending = false; // Track if a render is already scheduled
                this.stateChangeCallbacks = []; // Callbacks to notify when scan state changes
                this.completedScans = new Set(); // Track scans that have already shown completion
            }

            // Subscribe to scan state changes
            onStateChange(callback) {
                this.stateChangeCallbacks.push(callback);
            }

            // Notify all subscribers of state change
            notifyStateChange() {
                this.stateChangeCallbacks.forEach(callback => {
                    try {
                        callback(this.currentScanId, this.activeScans);
                    } catch (error) {
                        console.error('Error in state change callback:', error);
                    }
                });
            }

            // Get currently active scan ID
            getActiveScanId() {
                return this.currentScanId;
            }

            // =========================================================================
            // UNIFIED DATA MODEL - Single source of truth for all display logic
            // =========================================================================
            getScanDisplayData(scan) {
                const statusValue = scan.status?.status || 'running';
                const phaseNames = ['Scanning Files', 'Tombstoning Deletes', 'Analyzing'];
                const phaseName = phaseNames[scan.phase - 1] || 'Processing';
                const percentage = scan.progress?.percentage || 0;

                // Phase-specific item counts (matches original updateScanCard logic)
                let itemsText = '';
                let showPercentageInStats = false;

                if (scan.phase === 3) {
                    // Analysis phase: show X / Y files
                    itemsText = `${scan.progress.current.toLocaleString()} / ${scan.progress.total.toLocaleString()} files`;
                    showPercentageInStats = true;
                } else if (scan.phase === 1) {
                    // Scanning phase: show file/directory counts
                    itemsText = `Scanned ${this.scanningCounts.files.toLocaleString()} files in ${this.scanningCounts.directories.toLocaleString()} directories...`;
                    showPercentageInStats = false;
                } else if (scan.phase === 2) {
                    // Tombstoning phase
                    itemsText = `Processing...`;
                    showPercentageInStats = false;
                }

                // Status-specific display properties
                const statusDisplay = {
                    running: { label: 'Running', showStopBtn: true, stopBtnText: 'Stop', stopBtnDisabled: false },
                    cancelling: { label: 'Cancelling...', showStopBtn: true, stopBtnText: 'Stopping', stopBtnDisabled: true },
                    stopped: { label: 'Stopped', showStopBtn: true, stopBtnText: 'Stopped', stopBtnDisabled: true },
                    completed: { label: 'Completed', showStopBtn: false, stopBtnText: 'Completed', stopBtnDisabled: true },
                    error: { label: 'Error', showStopBtn: false, stopBtnText: '', stopBtnDisabled: true }
                };

                const status = statusDisplay[statusValue] || statusDisplay.running;

                return {
                    // Core scan data
                    phase: scan.phase,
                    phaseName: phaseName,
                    phaseLabel: `Phase ${scan.phase} of 3: ${phaseName}`,

                    // Progress data
                    percentage: Math.round(percentage),
                    percentageFormatted: `${percentage.toFixed(1)}%`,
                    progressBarWidth: `${percentage}%`,

                    // Status data
                    status: statusValue,
                    statusLabel: status.label,

                    // Items/stats display
                    itemsText: itemsText,
                    showPercentageInStats: showPercentageInStats,

                    // Button state
                    showStopButton: status.showStopBtn,
                    stopButtonText: status.stopBtnText,
                    stopButtonDisabled: status.stopBtnDisabled,

                    // Thread details (phase 3 only)
                    showThreads: scan.phase === 3 && scan.threads?.length > 0,
                    threads: scan.threads || [],

                    // Phase breadcrumbs
                    breadcrumbs: this.phaseBreadcrumbs,

                    // Raw data for special cases
                    files: this.scanningCounts.files || 0,
                    directories: this.scanningCounts.directories || 0,
                    current: scan.progress?.current || 0,
                    total: scan.progress?.total || 0,

                    // Root path
                    rootPath: scan.root_path
                };
            }

            scheduleRender() {
                // Use requestAnimationFrame to batch renders and sync with browser paint cycle
                // This prevents render() from interfering with event handling while ensuring
                // all state updates are displayed accurately
                if (!this.renderPending) {
                    this.renderPending = true;
                    requestAnimationFrame(() => {
                        this.renderPending = false;
                        this.render();
                    });
                }
            }

            render() {
                // Render ONLY for Scans page (scan UI has been moved there)
                const container = document.getElementById('scans-active-scan-container');
                if (!container) return;

                if (this.activeScans.size === 0) {
                    container.innerHTML = `
                        <div class="no-scans-state">
                            <h3 style="margin-bottom: 1rem; font-size: 1.1rem; color: #333;">No Active Scan</h3>
                            <button class="start-scan-btn" onclick="showStartScanModal()">+ Start New Scan</button>
                        </div>
                    `;
                } else {
                    // Remove "No Active Scan" UI if present
                    const noScansState = container.querySelector('.no-scans-state');
                    if (noScansState) {
                        noScansState.remove();
                    }

                    // Check if scan card already exists
                    for (const [scanId, scan] of this.activeScans.entries()) {
                        let scanCard = document.getElementById(`scan-card-${scanId}`);

                        if (!scanCard) {
                            // Create the scan card structure once
                            scanCard = this.createScanCard(scanId, scan);
                            container.appendChild(scanCard);
                        }

                        // Update only the dynamic content
                        this.updateScanCard(scanId, scan);
                    }
                }
            }

            createScanCard(scanId, scan) {
                // Create the scan card DOM structure once - this stays in the DOM
                const card = document.createElement('div');
                card.className = 'scan-card';
                card.id = `scan-card-${scanId}`;

                card.innerHTML = `
                    <div class="scan-header">
                        <div class="scan-title">Scanning: ${scan.root_path}</div>
                        <button id="stop-btn-${scanId}" class="scan-stop-btn" style="display: none;">Stop</button>
                    </div>
                    <div id="breadcrumbs-${scanId}"></div>
                    <div class="scan-progress-section">
                        <div class="scan-progress-label">
                            <span id="phase-label-${scanId}"></span>
                            <span id="percentage-${scanId}"></span>
                        </div>
                        <div class="scan-progress-bar-container">
                            <div id="progress-bar-${scanId}" class="scan-progress-bar" style="width: 0%"></div>
                        </div>
                        <div id="stats-${scanId}" class="scan-stats"></div>
                    </div>
                    <button id="details-btn-${scanId}" class="scan-details-toggle" data-scan-id="${scanId}" style="display: none;">
                        <span>Details</span>
                        <span class="chevron">▶</span>
                    </button>
                    <div id="thread-details-${scanId}" class="scan-thread-details"></div>
                `;

                // Attach click handlers directly to the buttons
                const stopButton = card.querySelector(`#stop-btn-${scanId}`);
                stopButton.addEventListener('click', () => {
                    this.stopScan(scanId);
                });

                const detailsButton = card.querySelector(`#details-btn-${scanId}`);
                detailsButton.addEventListener('click', () => {
                    this.toggleDetails(scanId);
                });

                return card;
            }

            updateScanCard(scanId, scan) {
                // Update only the dynamic content using unified data model
                const displayData = this.getScanDisplayData(scan);

                // Update breadcrumbs
                const breadcrumbsContainer = document.getElementById(`breadcrumbs-${scanId}`);
                if (displayData.breadcrumbs.length > 0) {
                    breadcrumbsContainer.innerHTML = `
                        <div style="margin-bottom: 12px;">
                            ${displayData.breadcrumbs.map(crumb => `
                                <div style="font-size: 0.875rem; color: #34c759; margin-bottom: 4px;">
                                    ✓ ${crumb}
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else {
                    breadcrumbsContainer.innerHTML = '';
                }

                // Update phase label
                document.getElementById(`phase-label-${scanId}`).textContent = displayData.phaseLabel;

                // Update percentage (only show during phase 3 - Analysis)
                const percentageElement = document.getElementById(`percentage-${scanId}`);
                if (displayData.showPercentageInStats) {
                    percentageElement.textContent = displayData.percentageFormatted;
                    percentageElement.style.display = '';
                } else {
                    percentageElement.textContent = '';
                    percentageElement.style.display = 'none';
                }

                // Update progress bar (only show during phase 3)
                const progressBar = document.getElementById(`progress-bar-${scanId}`);
                if (displayData.showPercentageInStats) {
                    progressBar.style.width = displayData.progressBarWidth;
                } else {
                    progressBar.style.width = '0%';
                }

                // Update stats
                const statsContainer = document.getElementById(`stats-${scanId}`);
                statsContainer.textContent = displayData.itemsText;
                statsContainer.style.color = scan.phase === 1 ? '#007aff' : '';

                // Update Stop button visibility and state
                const stopButton = document.getElementById(`stop-btn-${scanId}`);

                if (displayData.status === 'running') {
                    stopButton.style.display = 'inline-block';
                    stopButton.disabled = false;
                    stopButton.textContent = 'Stop';
                } else if (displayData.status === 'cancelling') {
                    stopButton.style.display = 'inline-block';
                    stopButton.disabled = true;
                    stopButton.textContent = 'Stopping';
                } else if (displayData.status === 'stopped') {
                    stopButton.style.display = 'inline-block';
                    stopButton.disabled = true;
                    stopButton.textContent = 'Stopped';
                } else if (displayData.status === 'completed') {
                    // Check if we were in the middle of stopping (race condition)
                    if (stopButton.textContent === 'Stopping') {
                        // User clicked stop but scan completed anyway
                        stopButton.style.display = 'inline-block';
                        stopButton.disabled = true;
                        stopButton.textContent = 'Completed';
                    } else {
                        // Normal completion - hide button
                        stopButton.style.display = 'none';
                    }
                } else {
                    // error - hide button
                    stopButton.style.display = 'none';
                }

                // Show/hide and update button for phase 3
                const button = document.getElementById(`details-btn-${scanId}`);
                const threadDetailsContainer = document.getElementById(`thread-details-${scanId}`);

                if (displayData.showThreads || displayData.phase === 3) {
                    button.style.display = 'flex';

                    // Load expanded state from localStorage if not yet in set
                    if (!this.expandedScans.has(scanId) && this.loadExpandedState()) {
                        this.expandedScans.add(scanId);
                    }

                    // Update button expanded state
                    const isExpanded = this.expandedScans.has(scanId);
                    button.className = `scan-details-toggle ${isExpanded ? 'expanded' : ''}`;
                    threadDetailsContainer.className = `scan-thread-details ${isExpanded ? 'visible' : ''}`;

                    // Update thread details content
                    if (displayData.threads.length > 0) {
                        const threadsHtml = displayData.threads.map(thread => {
                            let operation = 'idle';
                            let filePath = thread.current_file || '-';

                            if (thread.current_file) {
                                if (thread.current_file.startsWith('Hashing:')) {
                                    operation = 'hashing';
                                    filePath = thread.current_file.substring(9).trim();
                                } else if (thread.current_file.startsWith('Validating:')) {
                                    operation = 'validating';
                                    filePath = thread.current_file.substring(12).trim();
                                } else if (thread.status === 'active') {
                                    operation = 'scanning';
                                }
                            }

                            const statusLabels = {
                                'hashing': 'HASHING',
                                'validating': 'VALIDATING',
                                'scanning': 'SCANNING',
                                'idle': 'IDLE'
                            };

                            return `
                                <div class="scan-thread-item">
                                    <span class="scan-thread-status ${operation}">${statusLabels[operation]}</span>
                                    <span class="scan-thread-file">${filePath}</span>
                                </div>
                            `;
                        }).join('');
                        threadDetailsContainer.innerHTML = threadsHtml;
                    } else {
                        threadDetailsContainer.innerHTML = '<div style="padding: 12px; color: #86868b; font-style: italic;">Waiting for thread activity...</div>';
                    }
                } else {
                    button.style.display = 'none';
                    threadDetailsContainer.innerHTML = '';
                }
            }

            toggleDetails(scanId) {
                // Toggle the expanded state
                if (this.expandedScans.has(scanId)) {
                    this.expandedScans.delete(scanId);
                } else {
                    this.expandedScans.add(scanId);
                }

                // Save to localStorage
                localStorage.setItem('fspulse.scan.details.expanded', this.expandedScans.has(scanId) ? 'true' : 'false');

                // Directly update the button and details container - no re-render needed
                const isExpanded = this.expandedScans.has(scanId);
                const button = document.getElementById(`details-btn-${scanId}`);
                const threadDetailsContainer = document.getElementById(`thread-details-${scanId}`);

                if (button) {
                    button.className = `scan-details-toggle ${isExpanded ? 'expanded' : ''}`;
                }
                if (threadDetailsContainer) {
                    threadDetailsContainer.className = `scan-thread-details ${isExpanded ? 'visible' : ''}`;
                }
            }

            loadExpandedState() {
                // Load the expanded state from localStorage
                const saved = localStorage.getItem('fspulse.scan.details.expanded');
                return saved === 'true';
            }

            async stopScan(scanId) {
                // Optimistically update button state immediately
                const stopButton = document.getElementById(`stop-btn-${scanId}`);
                if (stopButton) {
                    stopButton.disabled = true;
                    stopButton.textContent = 'Stopping';
                }

                try {
                    const response = await fetch(`/api/scans/${scanId}/cancel`, {
                        method: 'POST'
                    });

                    if (!response.ok) {
                        console.error('Failed to cancel scan:', response.statusText);
                        alert('Failed to cancel scan. Please try again.');
                        // Revert button state on error
                        if (stopButton) {
                            stopButton.disabled = false;
                            stopButton.textContent = 'Stop';
                        }
                    }
                    // Backend will set status to "cancelling" which will update the UI via WebSocket
                } catch (error) {
                    console.error('Error cancelling scan:', error);
                    alert('Error cancelling scan. Please check your connection.');
                    // Revert button state on error
                    if (stopButton) {
                        stopButton.disabled = false;
                        stopButton.textContent = 'Stop';
                    }
                }
            }

            connectScanWebSocket(scanId, rootPath) {
                // Close existing connection if any
                if (this.ws) {
                    this.ws.close();
                }

                // Initialize scan state
                this.currentScanId = scanId;
                this.scanPhase = 1;
                this.threadStates.clear();
                this.scanningCounts = { files: 0, directories: 0 };
                this.phaseBreadcrumbs = [];

                this.activeScans.set(scanId, {
                    scan_id: scanId,
                    root_path: rootPath,
                    phase: 1,
                    progress: {
                        current: 0,
                        total: 1,
                        percentage: 0
                    },
                    threads: []
                });
                this.expandedScans.add(scanId); // Expand by default
                this.scheduleRender();
                this.notifyStateChange(); // Notify subscribers of new scan

                // Connect to WebSocket
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}/ws/scans/progress`;

                this.ws = new WebSocket(wsUrl);

                this.ws.onopen = () => {
                    // WebSocket connected
                };

                this.ws.onmessage = (event) => {
                    const state = JSON.parse(event.data);
                    this.handleStateUpdate(state);
                };

                this.ws.onerror = (error) => {
                    console.error('WebSocket error:', error);
                };

                this.ws.onclose = () => {
                    // Remove scan from active list after a delay
                    setTimeout(() => {
                        this.activeScans.delete(scanId);
                        this.currentScanId = null; // Clear active scan ID
                        hideHeaderProgress(); // Hide header at the same time as Scans page
                        this.scheduleRender();
                        this.notifyStateChange(); // Notify subscribers scan ended
                    }, 2000);
                };
            }

            handleStateUpdate(state) {
                // Handle error state
                if (state.error) {
                    console.error('WebSocket error:', state.error);
                    return;
                }

                // Update or create scan data from complete state snapshot
                const scanData = this.activeScans.get(state.scan_id) || {
                    scan_id: state.scan_id,
                    root_path: state.root_path,
                    phase: 1,
                    progress: { current: 0, total: 1, percentage: 0 },
                    threads: []
                };

                // Map phase name to phase number
                if (state.current_phase) {
                    if (state.current_phase.name === 'scanning') {
                        scanData.phase = 1;
                        this.scanPhase = 1;
                    } else if (state.current_phase.name === 'sweeping') {
                        scanData.phase = 2;
                        this.scanPhase = 2;
                    } else if (state.current_phase.name === 'analyzing') {
                        scanData.phase = 3;
                        this.scanPhase = 3;
                    }
                }

                // Update completed phase breadcrumbs
                this.phaseBreadcrumbs = state.completed_phases || [];

                // Update scanning progress (phase 1)
                if (state.scanning_progress) {
                    this.scanningCounts = {
                        files: state.scanning_progress.files_scanned || 0,
                        directories: state.scanning_progress.directories_scanned || 0
                    };
                }

                // Update overall progress (phase 3)
                if (state.overall_progress) {
                    scanData.progress = {
                        current: state.overall_progress.completed,
                        total: state.overall_progress.total,
                        percentage: state.overall_progress.percentage
                    };
                }

                // Update thread states
                if (state.thread_states && state.thread_states.length > 0) {
                    scanData.threads = state.thread_states.map(thread => {
                        if (thread.operation.type === 'idle') {
                            return { id: thread.thread_index, status: 'idle', current_file: null };
                        }

                        let prefix = '';
                        let file = '';
                        if (thread.operation.type === 'hashing') {
                            prefix = 'Hashing:';
                            file = thread.operation.file;
                        } else if (thread.operation.type === 'validating') {
                            prefix = 'Validating:';
                            file = thread.operation.file;
                        }

                        return {
                            id: thread.thread_index,
                            status: 'active',
                            current_file: prefix ? `${prefix} ${file}` : file
                        };
                    });
                }

                // Update scan status
                if (state.status) {
                    scanData.status = state.status;
                }

                // Update the scan in activeScans
                this.activeScans.set(state.scan_id, scanData);
                this.notifyStateChange(); // Notify subscribers of state update

                // Update the persistent scan progress banner
                this.updateBanner(state, scanData);

                // Handle scan completion
                // Status is an object like {status: "running"}, check the status field
                if (state.status && state.status.status) {
                    const statusValue = state.status.status;

                    if (statusValue === 'completed') {
                        // Only handle completion once per scan
                        if (!this.completedScans.has(state.scan_id)) {
                            this.completedScans.add(state.scan_id);

                            // Scan completed - remove after delay
                            setTimeout(() => {
                                this.activeScans.delete(state.scan_id);
                                this.completedScans.delete(state.scan_id); // Clean up tracking
                                this.currentScanId = null; // Clear active scan ID
                                hideHeaderProgress(); // Hide header at the same time as Scans page
                                this.scheduleRender();
                                this.notifyStateChange(); // Notify subscribers scan completed
                            }, 2000);
                        }
                    } else if (statusValue === 'stopped') {
                        // Only handle stop once per scan
                        if (!this.completedScans.has(state.scan_id)) {
                            this.completedScans.add(state.scan_id);

                            // Scan stopped (cancelled) - remove after delay
                            setTimeout(() => {
                                this.activeScans.delete(state.scan_id);
                                this.completedScans.delete(state.scan_id); // Clean up tracking
                                this.currentScanId = null; // Clear active scan ID
                                hideHeaderProgress(); // Hide header at the same time as Scans page
                                this.scheduleRender();
                                this.notifyStateChange(); // Notify subscribers scan stopped
                            }, 2000);
                        }
                    } else if (statusValue === 'error') {
                        // Only handle error once per scan
                        if (!this.completedScans.has(state.scan_id)) {
                            this.completedScans.add(state.scan_id);

                            console.error('Scan error:', state.status.message);
                            alert(`Scan error: ${state.status.message}`);
                            // Remove scan on error after delay
                            setTimeout(() => {
                                this.activeScans.delete(state.scan_id);
                                this.completedScans.delete(state.scan_id); // Clean up tracking
                                this.currentScanId = null; // Clear active scan ID
                                hideHeaderProgress(); // Hide header at the same time as Scans page
                                this.scheduleRender();
                                this.notifyStateChange(); // Notify subscribers scan errored
                            }, 3000);
                        }
                    }
                    // For 'running' and 'cancelling' states, keep the scan visible
                }

                this.scheduleRender();
            }

            // Update the header progress (minimal, always visible)
            // Uses unified data model via getScanDisplayData()
            updateBanner(state, scanData) {
                const statusValue = state.status?.status;

                if (statusValue === 'running' || statusValue === 'cancelling') {
                    // Get unified display data
                    const displayData = this.getScanDisplayData(scanData);

                    const headerData = {
                        status: statusValue === 'running' ? 'Scanning' : 'Cancelling',
                        root_path: this.shortenPath(state.root_path || 'Unknown', 50),
                        phase: displayData.phaseName,
                        scanPhase: displayData.phase,
                        percentage: displayData.percentage,
                        files: displayData.files,
                        directories: displayData.directories,
                        current: displayData.current,
                        total: displayData.total
                    };

                    updateHeaderProgress(headerData);
                } else if (statusValue === 'completed') {
                    // Show completion briefly - header will be hidden when scan is removed from activeScans
                    if (!this.completedScans.has(state.scan_id)) {
                        const completionData = {
                            status: 'Completed',
                            root_path: this.shortenPath(state.root_path || '', 50),
                            phase: 'Complete',
                            scanPhase: 3,
                            percentage: 100,
                            files: this.scanningCounts.files || 0,
                            directories: this.scanningCounts.directories || 0
                        };
                        updateHeaderProgress(completionData);
                        // Note: hideHeaderProgress() will be called when scan is removed from activeScans
                    }
                } else if (statusValue === 'stopped' || statusValue === 'error') {
                    // These will be hidden when scan is removed from activeScans
                    // No need to hide here
                } else {
                    // No active scan or unknown state - hide
                    hideHeaderProgress();
                }
            }

            // Helper to get friendly phase name
            getPhaseName(phaseName) {
                if (!phaseName) return 'Initializing';
                switch (phaseName.toLowerCase()) {
                    case 'scanning': return 'Discovery';
                    case 'sweeping': return 'Sweep';
                    case 'analyzing': return 'Analysis';
                    default: return phaseName;
                }
            }

            // Helper to shorten file paths for display
            shortenPath(path, maxLength = 60) {
                if (!path || path.length <= maxLength) return path;
                const parts = path.split('/');
                if (parts.length <= 2) return path;
                return '.../' + parts.slice(-2).join('/');
            }

            // Demo method - adds a mock scan for testing UI
            addMockScan() {
                const mockScan = {
                    scan_id: '123',
                    root_path: '/Users/demo/Documents',
                    phase: 2,
                    phase_name: 'Analysis',
                    total_phases: 3,
                    progress: {
                        current: 2450,
                        total: 5400,
                        percentage: 45.37
                    },
                    threads: [
                        { id: 1, status: 'active', current_file: 'Hashing: /Users/demo/Documents/video.mp4' },
                        { id: 2, status: 'active', current_file: 'Validating: /Users/demo/Documents/report.pdf' },
                        { id: 3, status: 'active', current_file: 'Hashing: /Users/demo/Documents/photo.jpg' },
                        { id: 4, status: 'idle', current_file: null }
                    ]
                };

                this.activeScans.set('123', mockScan);
                this.expandedScans.add('123'); // Expand by default
                this.scheduleRender();
            }

            async checkForActiveScan() {
                try {
                    const response = await fetch('/api/scans/current');
                    if (!response.ok) return;

                    const data = await response.json();

                    // If there's an active scan, connect to WebSocket for state updates
                    if (data && data.scan_id) {
                        console.log('Found active scan:', data);
                        // Connect to WebSocket - state snapshots will rebuild the UI automatically
                        this.connectScanWebSocket(data.scan_id, data.root_path);
                    }
                } catch (error) {
                    console.error('Failed to check for active scan:', error);
                }
            }

        }

        // Global scan manager instance
        const scanManager = new ScanManager();

        // Store scan status data globally
        let scanStatusData = null;

        // Start New Scan Modal Functions
        async function showStartScanModal() {
            const modal = document.getElementById('start-scan-modal-overlay');
            const select = document.getElementById('scan-root-select');
            const error = document.getElementById('scan-error');

            error.classList.remove('visible');

            // Load scan status (includes roots and incomplete scan info)
            try {
                const response = await fetch('/api/scans/status');
                scanStatusData = await response.json();

                if (scanStatusData.roots && scanStatusData.roots.length > 0) {
                    // Populate dropdown with roots (no "Select a root..." option)
                    select.innerHTML = scanStatusData.roots.map(root => {
                        const label = root.has_incomplete_scan
                            ? `${root.root_path} (Resume)`
                            : root.root_path;
                        return `<option value="${root.root_id}">${label}</option>`;
                    }).join('');

                    // Trigger selection handler for first root
                    handleRootSelection();
                } else {
                    select.innerHTML = '<option value="">No roots available</option>';
                }
            } catch (err) {
                console.error('Failed to load scan status:', err);
                select.innerHTML = '<option value="">Error loading roots</option>';
            }

            modal.classList.add('active');
        }

        function handleRootSelection() {
            const select = document.getElementById('scan-root-select');
            const rootId = parseInt(select.value);

            if (!rootId || !scanStatusData) return;

            const root = scanStatusData.roots.find(r => r.root_id === rootId);
            if (!root) return;

            const actionBtn = document.getElementById('scan-action-btn');

            // Get all radio inputs
            const hashRadios = document.querySelectorAll('input[name="hash-mode"]');
            const validateRadios = document.querySelectorAll('input[name="validate-mode"]');

            if (root.has_incomplete_scan) {
                // Resume mode: Set values from existing scan and make read-only
                actionBtn.textContent = 'Resume Scan';

                // Set radio values to match existing scan
                hashRadios.forEach(radio => {
                    radio.checked = radio.value === root.scan_options.hash_mode;
                    radio.disabled = true;
                    radio.parentElement.style.opacity = '0.6';
                    radio.parentElement.style.cursor = 'not-allowed';
                });

                validateRadios.forEach(radio => {
                    radio.checked = radio.value === root.scan_options.validate_mode;
                    radio.disabled = true;
                    radio.parentElement.style.opacity = '0.6';
                    radio.parentElement.style.cursor = 'not-allowed';
                });
            } else {
                // New scan mode: Enable editing with defaults
                actionBtn.textContent = 'Start Scan';

                // Reset to defaults and enable
                hashRadios.forEach(radio => {
                    radio.checked = radio.value === 'All'; // Default to All
                    radio.disabled = false;
                    radio.parentElement.style.opacity = '1';
                    radio.parentElement.style.cursor = 'pointer';
                });

                validateRadios.forEach(radio => {
                    radio.checked = radio.value === 'New'; // Default to New
                    radio.disabled = false;
                    radio.parentElement.style.opacity = '1';
                    radio.parentElement.style.cursor = 'pointer';
                });
            }
        }

        function closeStartScanModal() {
            const modal = document.getElementById('start-scan-modal-overlay');
            modal.classList.remove('active');
        }

        async function startScan() {
            const select = document.getElementById('scan-root-select');
            const rootId = parseInt(select.value);
            const root = scanStatusData.roots.find(r => r.root_id === rootId);
            const error = document.getElementById('scan-error');

            error.classList.remove('visible');

            // Determine scan options
            let hashMode, validateMode;
            if (root.has_incomplete_scan) {
                // Use existing scan options
                hashMode = root.scan_options.hash_mode;
                validateMode = root.scan_options.validate_mode;
            } else {
                // Use user-selected options
                hashMode = document.querySelector('input[name="hash-mode"]:checked').value;
                validateMode = document.querySelector('input[name="validate-mode"]:checked').value;
            }

            try {
                // Call the API to start/resume the scan
                const response = await fetch('/api/scans/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        root_id: rootId,
                        hash_mode: hashMode,
                        validate_mode: validateMode
                    })
                });

                if (!response.ok) {
                    throw new Error(`Failed to start scan: ${response.statusText}`);
                }

                const data = await response.json();
                const scanId = data.scan_id;

                // Connect to WebSocket for real-time progress
                scanManager.connectScanWebSocket(scanId, root.root_path);

                closeStartScanModal();
            } catch (err) {
                console.error('Failed to start scan:', err);
                error.textContent = `Failed to start scan: ${err.message}`;
                error.classList.add('visible');
            }
        }

        // =============================================================================
        // DataTableView - Unified implementation for Roots, Scans, and Items
        // =============================================================================
        // Single class handles all table views with column management & filtering
        // Eliminates ~1000 lines of duplicated code
        // =============================================================================

        class DataTableView {
            constructor(domain, displayName) {
                this.domain = domain;
                this.displayName = displayName;
                this.columnState = [];
                this.selectedColumnIndex = null;
                this.activeFilters = [];
                this.currentFilterColumnIndex = null;
                this.currentPage = 1;
                this.draggedColumnIndex = null;
                this.dropPosition = null;
            }

            // DOM ID helpers
            getElementId(suffix) {
                return `${this.domain}-${suffix}`;
            }

            getElement(suffix) {
                return document.getElementById(this.getElementId(suffix));
            }

            async loadMetadata() {
                try {
                    const response = await fetch(`/api/metadata/${this.domain}`);
                    const data = await response.json();

                    this.columnState = data.columns.map((col, index) => ({
                        name: col.name,
                        displayName: col.display_name,
                        colType: col.col_type,
                        alignment: col.alignment,
                        visible: col.is_default,
                        sortDirection: 'none',
                        position: index,
                        filterInfo: col.filter_info
                    }));

                    this.renderColumnList();
                    this.loadData();
                } catch (error) {
                    console.error(`Failed to load ${this.domain} metadata:`, error);
                    this.getElement('column-list').innerHTML =
                        '<li style="color: #f44336; padding: 1rem;">Failed to load columns</li>';
                }
            }

            renderColumnList() {
                const list = this.getElement('column-list');
                const sortedColumns = [...this.columnState].sort((a, b) => a.position - b.position);

                list.innerHTML = sortedColumns.map((col, displayIndex) => {
                    const actualIndex = this.columnState.findIndex(c => c.name === col.name);
                    const sortIcon = col.sortDirection === 'asc' ? '↑' :
                                    col.sortDirection === 'desc' ? '↓' : '·';
                    const sortClass = col.sortDirection !== 'none' ? 'active' : '';

                    const activeFilter = this.activeFilters.find(f => f.columnName === col.name);
                    const filterDisplay = activeFilter
                        ? `<div class="filter-value-chip" onclick="event.stopPropagation(); views.${this.domain}.openFilterModal(${actualIndex})" title="${activeFilter.filterValue}">
                             <span class="filter-value-text">${activeFilter.filterValue}</span>
                             <span class="filter-value-remove" onclick="event.stopPropagation(); views.${this.domain}.removeFilter('${col.name}')">×</span>
                           </div>`
                        : `<button class="filter-add-btn" onclick="event.stopPropagation(); views.${this.domain}.openFilterModal(${actualIndex})" title="Add filter">+</button>`;

                    return `
                        <li class="column-item ${this.selectedColumnIndex === actualIndex ? 'selected' : ''}"
                            data-column-index="${actualIndex}"
                            draggable="true"
                            onclick="views.${this.domain}.selectColumn(${actualIndex})">
                            <div class="drag-handle" title="Drag to reorder"></div>
                            <input type="checkbox"
                                   class="column-checkbox"
                                   ${col.visible ? 'checked' : ''}
                                   onclick="event.stopPropagation(); views.${this.domain}.toggleColumnVisibility(${actualIndex})"
                                   title="Toggle visibility">
                            <span class="column-name">${col.displayName}</span>
                            <div class="sort-control ${sortClass}"
                                 onclick="event.stopPropagation(); views.${this.domain}.cycleColumnSort(${actualIndex})"
                                 title="Sort direction">
                                ${sortIcon}
                            </div>
                            <div class="filter-display">
                                ${filterDisplay}
                            </div>
                        </li>
                    `;
                }).join('');
            }

            setupDragListeners() {
                const columnList = this.getElement('column-list');

                columnList.addEventListener('dragstart', (e) => {
                    const columnItem = e.target.closest('.column-item');
                    if (columnItem) {
                        this.draggedColumnIndex = parseInt(columnItem.dataset.columnIndex);
                        columnItem.classList.add('dragging');
                        e.dataTransfer.effectAllowed = 'move';
                        e.dataTransfer.setData('text/html', columnItem.innerHTML);
                    }
                });

                columnList.addEventListener('dragenter', (e) => {
                    const columnItem = e.target.closest('.column-item');
                    if (columnItem) {
                        e.preventDefault();
                        this.updateDropIndicator(columnItem, e.clientY);
                    }
                });

                columnList.addEventListener('dragover', (e) => {
                    const columnItem = e.target.closest('.column-item');
                    if (columnItem) {
                        e.preventDefault();
                        e.dataTransfer.dropEffect = 'move';
                        this.updateDropIndicator(columnItem, e.clientY);
                    }
                });

                columnList.addEventListener('drop', (e) => {
                    const columnItem = e.target.closest('.column-item');
                    if (columnItem) {
                        this.handleColumnDrop(e, columnItem);
                    }
                });

                columnList.addEventListener('dragend', (e) => {
                    const columnItem = e.target.closest('.column-item');
                    if (columnItem) {
                        this.handleColumnDragEnd(e);
                    }
                });
            }

            updateDropIndicator(item, mouseY) {
                const itemIndex = parseInt(item.dataset.columnIndex);
                if (itemIndex === this.draggedColumnIndex) return;

                document.querySelectorAll(`#${this.getElementId('column-list')} .column-item`).forEach(el => {
                    el.classList.remove('drag-over-top', 'drag-over-bottom');
                });

                const rect = item.getBoundingClientRect();
                const midpoint = rect.top + rect.height / 2;

                if (mouseY < midpoint) {
                    item.classList.add('drag-over-top');
                    this.dropPosition = 'before';
                } else {
                    item.classList.add('drag-over-bottom');
                    this.dropPosition = 'after';
                }
            }

            handleColumnDrop(e, dropElement) {
                e.stopPropagation();
                e.preventDefault();

                const dropIndex = parseInt(dropElement.dataset.columnIndex);
                if (this.draggedColumnIndex === null || this.draggedColumnIndex === dropIndex) {
                    return false;
                }

                const draggedCol = this.columnState[this.draggedColumnIndex];
                const dropCol = this.columnState[dropIndex];
                const draggedPos = draggedCol.position;
                const dropPos = dropCol.position;

                let targetPos = dropPos;
                if (this.dropPosition === 'after') {
                    targetPos = dropPos + 1;
                }

                if (draggedPos < targetPos) {
                    this.columnState.forEach(col => {
                        if (col.position > draggedPos && col.position < targetPos) {
                            col.position--;
                        }
                    });
                    draggedCol.position = targetPos - 1;
                } else if (draggedPos > targetPos) {
                    this.columnState.forEach(col => {
                        if (col.position >= targetPos && col.position < draggedPos) {
                            col.position++;
                        }
                    });
                    draggedCol.position = targetPos;
                }

                this.selectedColumnIndex = this.draggedColumnIndex;
                this.renderColumnList();
                this.loadData();
                return false;
            }

            handleColumnDragEnd(e) {
                const columnItem = e.target.closest('.column-item');
                if (columnItem) {
                    columnItem.classList.remove('dragging');
                }

                document.querySelectorAll(`#${this.getElementId('column-list')} .column-item`).forEach(item => {
                    item.classList.remove('drag-over-top', 'drag-over-bottom');
                });

                this.draggedColumnIndex = null;
                this.dropPosition = null;
            }

            selectColumn(index) {
                this.selectedColumnIndex = index;
                this.renderColumnList();
            }

            toggleColumnVisibility(index) {
                this.columnState[index].visible = !this.columnState[index].visible;
                this.currentPage = 1;
                this.renderColumnList();
                this.loadData();
            }

            cycleColumnSort(index) {
                const current = this.columnState[index].sortDirection;
                const cycle = { 'none': 'asc', 'asc': 'desc', 'desc': 'none' };
                this.columnState[index].sortDirection = cycle[current];
                this.currentPage = 1;
                this.renderColumnList();
                this.loadData();
            }

            openFilterModal(columnIndex) {
                this.currentFilterColumnIndex = columnIndex;
                const column = this.columnState[columnIndex];
                const modal = this.getElement('filter-modal-overlay');
                const title = this.getElement('filter-modal-title');
                const hint = this.getElement('filter-hint');
                const input = this.getElement('filter-input');
                const error = this.getElement('filter-error');

                title.textContent = `Filter: ${column.displayName}`;
                hint.textContent = column.filterInfo.syntax_hint;

                const existingFilter = this.activeFilters.find(f => f.columnName === column.name);
                input.value = existingFilter ? existingFilter.filterValue : '';

                error.classList.remove('visible');
                modal.classList.add('active');
                setTimeout(() => input.focus(), 100);
            }

            closeFilterModal() {
                const modal = this.getElement('filter-modal-overlay');
                modal.classList.remove('active');
                this.currentFilterColumnIndex = null;
            }

            saveFilter() {
                if (this.currentFilterColumnIndex === null) return;

                const column = this.columnState[this.currentFilterColumnIndex];
                const input = this.getElement('filter-input');
                const filterValue = input.value.trim();
                const error = this.getElement('filter-error');

                error.classList.remove('visible');

                if (filterValue === '') {
                    this.activeFilters = this.activeFilters.filter(f => f.columnName !== column.name);
                    this.closeFilterModal();
                    this.renderColumnList();
                    this.loadData();
                    return;
                }

                if (filterValue.length > 500) {
                    error.textContent = 'Filter value is too long (max 500 characters)';
                    error.classList.add('visible');
                    return;
                }

                this.activeFilters = this.activeFilters.filter(f => f.columnName !== column.name);
                this.activeFilters.push({
                    columnName: column.name,
                    displayName: column.displayName,
                    filterValue: filterValue
                });

                this.closeFilterModal();
                this.currentPage = 1;
                this.renderColumnList();
                this.loadData();
            }

            removeFilter(columnName) {
                this.activeFilters = this.activeFilters.filter(f => f.columnName !== columnName);
                this.currentPage = 1;
                this.renderColumnList();
                this.loadData();
            }

            async loadData() {
                if (this.columnState.length === 0) {
                    await this.loadMetadata();
                    return;
                }

                try {
                    const visibleColumns = this.columnState
                        .filter(col => col.visible)
                        .sort((a, b) => a.position - b.position);

                    if (visibleColumns.length === 0) {
                        this.getElement('table-header').innerHTML =
                            '<th colspan="1" style="text-align: center; color: #f44336;">No columns selected. Please select columns to display.</th>';
                        this.getElement('table-body').innerHTML =
                            '<tr><td style="text-align: center; color: #666;">Select columns from the sidebar to display data</td></tr>';
                        return;
                    }

                    const headerHtml = visibleColumns.map(col => {
                        const alignStyle = col.alignment === 'Right' ? 'text-align: right' :
                                          col.alignment === 'Center' ? 'text-align: center' : '';
                        return `<th style="${alignStyle}">${col.displayName}</th>`;
                    }).join('');
                    this.getElement('table-header').innerHTML = headerHtml;

                    const itemsPerPage = 25;
                    const offset = (this.currentPage - 1) * itemsPerPage;

                    const queryRequest = {
                        columns: this.columnState.map(col => ({
                            name: col.name,
                            visible: col.visible,
                            sort_direction: col.sortDirection,
                            position: col.position
                        })),
                        filters: this.activeFilters.map(f => ({
                            column: f.columnName,
                            value: f.filterValue
                        })),
                        limit: itemsPerPage,
                        offset: offset
                    };

                    const response = await fetch(`/api/query/${this.domain}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(queryRequest)
                    });
                    const data = await response.json();

                    const tbody = this.getElement('table-body');
                    tbody.innerHTML = '';

                    if (data.rows && data.rows.length > 0) {
                        data.rows.forEach(rowData => {
                            const row = document.createElement('tr');

                            const cellsHtml = rowData.map((cellValue, index) => {
                                const col = visibleColumns[index];
                                const alignStyle = col.alignment === 'Right' ? 'text-align: right' :
                                                  col.alignment === 'Center' ? 'text-align: center' : '';
                                return `<td style="${alignStyle}">${cellValue}</td>`;
                            }).join('');

                            row.innerHTML = cellsHtml;
                            tbody.appendChild(row);
                        });
                    } else {
                        tbody.innerHTML = `<tr><td colspan="${visibleColumns.length}" style="text-align: center; color: #666;">No ${this.domain} found</td></tr>`;
                    }

                    const itemsPerPageDisplay = 25;
                    const showing = data.rows.length;
                    const start = showing > 0 ? ((this.currentPage - 1) * itemsPerPageDisplay) + 1 : 0;
                    const end = Math.min(start + showing - 1, data.total);
                    this.getElement('pagination-info').textContent =
                        `Showing ${start} - ${end} of ${data.total} ${this.domain}`;

                    const hasNext = end < data.total;
                    const hasPrev = this.currentPage > 1;
                    this.getElement('prev-btn').disabled = !hasPrev;
                    this.getElement('next-btn').disabled = !hasNext;

                } catch (error) {
                    console.error(`Failed to load ${this.domain}:`, error);
                    const visibleCount = this.columnState.filter(c => c.visible).length || 1;
                    this.getElement('table-body').innerHTML =
                        `<tr><td colspan="${visibleCount}" style="color: #f44336;">Failed to load ${this.domain}</td></tr>`;
                }
            }

            changePage(delta) {
                this.currentPage += delta;
                window.scrollTo({ top: 0, behavior: 'smooth' });
                this.loadData();
            }
        }

        // Create instances for each domain
        const views = {
            roots: new DataTableView('roots', 'Roots'),
            scans: new DataTableView('scans', 'Scans'),
            items: new DataTableView('items', 'Items'),
            changes: new DataTableView('changes', 'Changes'),
            alerts: new DataTableView('alerts', 'Alerts')
        };

        // Global functions for onclick handlers (backwards compatibility)
        function changeRootsPage(delta) { views.roots.changePage(delta); }
        function changeScansPage(delta) { views.scans.changePage(delta); }
        function changeItemsPage(delta) { views.items.changePage(delta); }
        function changeAlertsPage(delta) { views.alerts.changePage(delta); }

        function closeRootsFilterModal() { views.roots.closeFilterModal(); }
        function closeScansFilterModal() { views.scans.closeFilterModal(); }
        function closeItemsFilterModal() { views.items.closeFilterModal(); }

        function saveRootsFilter() { views.roots.saveFilter(); }
        function saveScansFilter() { views.scans.saveFilter(); }
        function saveItemsFilter() { views.items.saveFilter(); }

        function changeChangesPage(delta) { views.changes.changePage(delta); }
        function closeChangesFilterModal() { views.changes.closeFilterModal(); }
        function saveChangesFilter() { views.changes.saveFilter(); }

        function closeAlertsFilterModal() { views.alerts.closeFilterModal(); }
        function saveAlertsFilter() { views.alerts.saveFilter(); }

        // ========================================
        // Routing and Navigation System
        // ========================================

        // Configuration for sections with tabs
        const TAB_CONFIG = {
            explore: {
                defaultTab: 'roots',
                loadData: (tabName) => {
                    // Query tab has no data to load, it's handled by executeQuery()
                    if (tabName === 'query') return;

                    // Data Explorer tabs use the views system
                    if (views[tabName]) {
                        views[tabName].loadData();
                    }
                }
            },
            insights: {
                defaultTab: 'alerts',
                loadData: (tabName) => {
                    if (tabName === 'alerts') {
                        loadInsightsAlerts();
                    } else if (tabName === 'statistics') {
                        loadInsightsStatistics();
                    } else if (tabName === 'changes') {
                        loadInsightsChanges();
                    }
                }
            }
        };

        // Unified tab switching function - works for any section
        function showTab(sectionName, tabName, updateHash = true) {
            const config = TAB_CONFIG[sectionName];
            if (!config) return;

            // Hide all tab contents for this section
            document.querySelectorAll(`.${sectionName}-tab-content`).forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab
            const selectedTab = document.getElementById(`${sectionName}-${tabName}`);
            if (selectedTab) {
                selectedTab.classList.add('active');
            }

            // Update tab buttons active state
            document.querySelectorAll(`.${sectionName}-tab`).forEach(btn => {
                btn.classList.remove('active');
            });

            // Find and activate the correct tab button
            // Uses text matching for now (could be improved with data attributes)
            const activeBtn = Array.from(document.querySelectorAll(`.${sectionName}-tab`)).find(btn => {
                return btn.textContent.toLowerCase() === tabName.toLowerCase();
            });
            if (activeBtn) {
                activeBtn.classList.add('active');
            }

            // Update URL hash for deep linking
            if (updateHash) {
                window.location.hash = `#/${sectionName}/${tabName}`;
            }

            // Load data for this tab
            config.loadData(tabName);
        }

        // Backwards compatibility wrappers
        function showExploreTab(tabName, updateHash = true) {
            showTab('explore', tabName, updateHash);
        }

        function showInsightsTab(tabName, updateHash = true) {
            showTab('insights', tabName, updateHash);
        }

        // Show a section (top-level navigation)
        function showSection(sectionName, updateHash = true) {
            currentSection = sectionName;

            // Update URL hash if requested
            if (updateHash) {
                const config = TAB_CONFIG[sectionName];
                if (config) {
                    // Section has tabs - include default tab in URL
                    window.location.hash = `#/${sectionName}/${config.defaultTab}`;
                } else {
                    // Simple section with no tabs
                    window.location.hash = `#/${sectionName}`;
                }
            }

            // Hide all sections
            document.querySelectorAll('[id$="-section"]').forEach(section => {
                section.style.display = 'none';
            });

            // Show selected section
            document.getElementById(sectionName + '-section').style.display = 'block';

            // Update nav active state
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });

            // Find and activate the correct nav item
            const activeNavItem = Array.from(document.querySelectorAll('.nav-item')).find(item => {
                return item.textContent.toLowerCase().includes(sectionName.toLowerCase());
            });
            if (activeNavItem) {
                activeNavItem.classList.add('active');
            }

            // Load data for scans section (special case - has no tabs)
            if (sectionName === 'scans') {
                loadManageRootsData();
            }

            // Close sidebar on mobile
            if (window.innerWidth <= 768) {
                document.getElementById('sidebar').classList.remove('open');
            }
        }

        function handleInsightsContextChange() {
            const contextFilter = document.getElementById('insights-context-filter');
            const contextValue = document.getElementById('insights-context-value');
            const selectedContext = contextFilter.value;

            // Show/hide and configure input based on context selection
            if (selectedContext === 'all') {
                contextValue.style.display = 'none';
                contextValue.value = '';
            } else if (selectedContext === 'root') {
                contextValue.style.display = 'block';
                contextValue.placeholder = 'e.g., 1 or 1, 2 or 1..5';
                contextValue.value = '';
            } else if (selectedContext === 'scan') {
                contextValue.style.display = 'block';
                contextValue.placeholder = 'e.g., 100 or 100, 200 or 100..200';
                contextValue.value = '';
            }

            // Store context in localStorage for persistence
            localStorage.setItem('fspulse.insights.context', selectedContext);

            // Reload current tab data with new context
            const activeTab = document.querySelector('.insights-tab.active');
            if (activeTab) {
                const tabName = activeTab.textContent.toLowerCase();
                if (tabName === 'alerts') {
                    loadInsightsAlerts();
                } else if (tabName === 'statistics') {
                    loadInsightsStatistics();
                } else if (tabName === 'changes') {
                    loadInsightsChanges();
                }
            }
        }

        // Insights Alerts State
        let insightsAlertsState = {
            currentPage: 1,
            pageSize: 25,
            totalCount: 0,
            searchDebounceTimer: null,
            contextDebounceTimer: null
        };

        async function loadInsightsAlerts() {
            const typeFilter = document.getElementById('insights-alerts-type-filter').value;
            const statusFilter = document.getElementById('insights-alerts-status-filter').value;
            const searchValue = document.getElementById('insights-alerts-search').value;
            const contextFilter = document.getElementById('insights-context-filter').value;
            const contextValue = document.getElementById('insights-context-value').value.trim();

            const tbody = document.getElementById('insights-alerts-table-body');
            tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 2rem; color: #86868b;">Loading...</td></tr>';

            try {
                // Build WHERE clause from filters
                let whereClause = '';
                const filterParts = [];

                // Add context filter if applicable
                if (contextFilter && contextFilter !== 'all' && contextValue) {
                    if (contextFilter === 'root') {
                        filterParts.push(`root_id:(${contextValue})`);
                    } else if (contextFilter === 'scan') {
                        filterParts.push(`scan_id:(${contextValue})`);
                    }
                }

                if (typeFilter) {
                    filterParts.push(`alert_type:(${typeFilter})`);
                }
                if (statusFilter) {
                    filterParts.push(`alert_status:(${statusFilter})`);
                }
                if (searchValue) {
                    filterParts.push(`item_path:('%${searchValue}%')`);
                }
                if (filterParts.length > 0) {
                    whereClause = ' where ' + filterParts.join(', ');
                }

                // Execute count query first to get total
                const countQuery = `alerts${whereClause}`;
                const countResponse = await fetch('/api/query/execute', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query: countQuery })
                });

                if (!countResponse.ok) {
                    const errorText = await countResponse.text();
                    throw new Error(errorText || `HTTP error! status: ${countResponse.status}`);
                }

                const countData = await countResponse.json();
                insightsAlertsState.totalCount = countData.rows.length;

                // Build and execute data query with pagination
                const offset = (insightsAlertsState.currentPage - 1) * insightsAlertsState.pageSize;
                const dataQuery = `alerts${whereClause} show alert_id, alert_type, alert_status, root_id, scan_id, item_path, created_at@timestamp, hash_old, hash_new, val_error order by created_at desc limit ${insightsAlertsState.pageSize} offset ${offset}`;

                const dataResponse = await fetch('/api/query/execute', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query: dataQuery })
                });

                if (!dataResponse.ok) {
                    const errorText = await dataResponse.text();
                    throw new Error(errorText || `HTTP error! status: ${dataResponse.status}`);
                }

                const data = await dataResponse.json();
                renderInsightsAlertsTable(data.rows || []);

                // Update pagination
                updateInsightsAlertsPagination();

            } catch (error) {
                console.error('Error loading insights alerts:', error);
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 2rem; color: #ff3b30;">Error loading alerts. Please try again.</td></tr>';
            }
        }

        function renderInsightsAlertsTable(rows) {
            const tbody = document.getElementById('insights-alerts-table-body');

            if (rows.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 2rem; color: #86868b;">No alerts found.</td></tr>';
                return;
            }

            tbody.innerHTML = rows.map(row => {
                const alertId = row[0]; // alert_id
                const alertType = row[1]; // alert_type
                const alertStatus = row[2]; // alert_status
                const rootId = row[3]; // root_id
                const scanId = row[4]; // scan_id
                const itemPath = row[5]; // item_path
                const createdAt = row[6]; // created_at
                const hashOld = row[7]; // hash_old
                const hashNew = row[8]; // hash_new
                const valError = row[9]; // val_error

                // Format alert type
                const typeBadge = alertType === 'H'
                    ? '<span class="alert-type-badge alert-type-hash">Suspicious Hash</span>'
                    : '<span class="alert-type-badge alert-type-invalid">Invalid Item</span>';

                // Format details based on alert type
                let details = '';
                if (alertType === 'H') {
                    details = `<div class="alert-details">Hash changed<br><span class="alert-details-code">Old: ${hashOld || 'N/A'}</span><br><span class="alert-details-code">New: ${hashNew || 'N/A'}</span></div>`;
                } else {
                    details = `<div class="alert-details">${valError || 'Validation error'}</div>`;
                }

                // Format created time
                // createdAt is a raw UTC timestamp from query processor (using @timestamp format)
                const createdDate = new Date(parseInt(createdAt) * 1000);
                const timeAgo = formatTimeAgo(createdDate);

                // Status dropdown with color
                const statusClass = alertStatus === 'O' ? 'status-open' : alertStatus === 'F' ? 'status-flagged' : 'status-dismissed';
                const statusDropdown = `
                    <select class="alert-status-select ${statusClass}" onchange="updateAlertStatus(${alertId}, this.value)">
                        <option value="O" ${alertStatus === 'O' ? 'selected' : ''}>Open</option>
                        <option value="F" ${alertStatus === 'F' ? 'selected' : ''}>Flagged</option>
                        <option value="D" ${alertStatus === 'D' ? 'selected' : ''}>Dismissed</option>
                    </select>
                `;

                return `
                    <tr>
                        <td>${statusDropdown}</td>
                        <td>${typeBadge}</td>
                        <td style="color: #86868b;">${rootId}</td>
                        <td style="color: #86868b;">${scanId}</td>
                        <td><span class="alert-file-path" title="${itemPath}">${truncatePath(itemPath, 60)}</span></td>
                        <td>${details}</td>
                        <td style="color: #86868b; font-size: 0.875rem;">${timeAgo}</td>
                    </tr>
                `;
            }).join('');
        }

        function updateInsightsAlertsPagination() {
            const start = (insightsAlertsState.currentPage - 1) * insightsAlertsState.pageSize + 1;
            const end = Math.min(start + insightsAlertsState.pageSize - 1, insightsAlertsState.totalCount);

            document.getElementById('insights-alerts-pagination-info').textContent =
                `Showing ${start} - ${end} of ${insightsAlertsState.totalCount} alerts`;

            document.getElementById('insights-alerts-prev-btn').disabled = insightsAlertsState.currentPage === 1;
            document.getElementById('insights-alerts-next-btn').disabled = end >= insightsAlertsState.totalCount;
        }

        function changeInsightsAlertsPage(delta) {
            insightsAlertsState.currentPage += delta;
            if (insightsAlertsState.currentPage < 1) insightsAlertsState.currentPage = 1;
            loadInsightsAlerts();
        }

        function debounceInsightsAlertsSearch() {
            clearTimeout(insightsAlertsState.searchDebounceTimer);
            insightsAlertsState.searchDebounceTimer = setTimeout(() => {
                insightsAlertsState.currentPage = 1;
                loadInsightsAlerts();
            }, 500);
        }

        function debounceInsightsContextFilter() {
            clearTimeout(insightsAlertsState.contextDebounceTimer);
            insightsAlertsState.contextDebounceTimer = setTimeout(() => {
                insightsAlertsState.currentPage = 1;
                loadInsightsAlerts();
            }, 500);
        }

        async function updateAlertStatus(alertId, newStatus) {
            try {
                const response = await fetch(`/api/alerts/${alertId}/status`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: newStatus })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                // Optionally reload alerts to reflect the change
                // loadInsightsAlerts();

            } catch (error) {
                console.error('Error updating alert status:', error);
                alert('Failed to update alert status. Please try again.');
                loadInsightsAlerts(); // Reload to reset the dropdown
            }
        }

        function truncatePath(path, maxLength) {
            if (path.length <= maxLength) return path;
            const parts = path.split('/');
            if (parts.length <= 2) return path;

            const filename = parts[parts.length - 1];
            const remaining = maxLength - filename.length - 5; // 5 for ".../"

            if (remaining <= 0) return '.../' + filename;

            let prefix = parts.slice(0, -1).join('/');
            if (prefix.length > remaining) {
                prefix = prefix.substring(0, remaining);
            }

            return prefix + '/.../' + filename;
        }

        function formatTimeAgo(date) {
            const now = new Date();
            const seconds = Math.floor((now - date) / 1000);

            if (seconds < 60) return 'just now';
            if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
            if (seconds < 604800) return `${Math.floor(seconds / 86400)}d ago`;

            return date.toLocaleDateString();
        }

        function loadInsightsStatistics() {
            // TODO: Implement statistics loading
            console.log('Loading insights statistics...');
        }

        function loadInsightsChanges() {
            // TODO: Implement changes loading
            console.log('Loading insights changes...');
        }

        // Track current section to avoid unnecessary reloads
        let currentSection = 'overview';

        // Handle hash-based routing
        function handleRouteChange() {
            const hash = window.location.hash;
            let sectionName = 'overview';
            let tabName = null;

            // Parse URL hash
            if (hash.startsWith('#/')) {
                const parts = hash.substring(2).split('/');
                sectionName = parts[0];
                tabName = parts[1] || null;
            }

            // Validate section exists
            if (!document.getElementById(sectionName + '-section')) {
                sectionName = 'overview';
                tabName = null;
            }

            // Update section if it changed
            if (currentSection !== sectionName) {
                showSection(sectionName, false);
            }

            // Show tab if this section has tabs
            const config = TAB_CONFIG[sectionName];
            if (config) {
                const tab = tabName || config.defaultTab;
                showTab(sectionName, tab, false);
            }
        }

        // ========================================
        // Manage Roots Functionality
        // ========================================

        let manageRootsCurrentPage = 1;
        const manageRootsPageSize = 25;
        let manageRootsTotalCount = 0;
        let manageRootsCachedData = []; // Cache roots data for re-rendering
        let manageRootsPreviousScanId = null; // Track previous active scan ID

        // Subscribe to scan state changes to update the Manage Roots display
        scanManager.onStateChange((activeScanId, activeScans) => {
            // Only update if we're currently on the Manage Roots page and have data
            const manageRootsSection = document.getElementById('manage-roots-section');
            if (manageRootsSection && manageRootsSection.style.display !== 'none') {
                // Detect if a scan just completed (previous scan ID existed, now it's null)
                const scanJustCompleted = manageRootsPreviousScanId !== null && activeScanId === null;

                if (scanJustCompleted) {
                    // Reload data from server to get updated scan states
                    loadManageRootsData();
                } else if (manageRootsCachedData.length > 0) {
                    // Just re-render with cached data (scan is still active or just started)
                    renderManageRootsTable(manageRootsCachedData);
                }

                // Update previous scan ID for next comparison
                manageRootsPreviousScanId = activeScanId;
            }
        });

        async function loadManageRootsData() {
            try {
                // Fetch roots with their last scan information
                const response = await fetch('/api/roots/with-scans');

                if (!response.ok) {
                    throw new Error(`HTTP error ${response.status}`);
                }

                const roots = await response.json();
                manageRootsTotalCount = roots.length;
                manageRootsCachedData = roots; // Cache for re-rendering on scan state changes

                renderManageRootsTable(roots);
                updateManageRootsPagination();
            } catch (error) {
                console.error('Error loading manage roots data:', error);
                document.getElementById('manage-roots-table-body').innerHTML = `
                    <tr>
                        <td style="text-align: center; color: #ff3b30; padding: 2rem;">
                            Error loading roots: ${error.message}
                        </td>
                    </tr>
                `;
            }
        }

        function formatTimestamp(unixTimestamp) {
            const date = new Date(unixTimestamp * 1000);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'just now';
            if (diffMins < 60) return `${diffMins} minute${diffMins > 1 ? 's' : ''} ago`;
            if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
            if (diffDays < 7) return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;

            return date.toLocaleDateString();
        }

        function renderManageRootsTable(roots) {
            const tbody = document.getElementById('manage-roots-table-body');

            if (roots.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td style="text-align: center; color: #86868b; padding: 2rem;">
                            No roots found. Click "Add Root" to get started.
                        </td>
                    </tr>
                `;
                return;
            }

            // Get active scan ID from ScanManager
            const activeScanId = scanManager.getActiveScanId();

            tbody.innerHTML = roots.map(root => {
                const scanInfo = root.last_scan;
                let scanHtml = '';

                if (scanInfo) {
                    // Determine display state and class
                    let displayState = scanInfo.state;
                    let stateClass = `scan-status-${scanInfo.state.toLowerCase()}`;

                    // Non-terminal states are: Pending, Scanning, Sweeping, Analyzing
                    const nonTerminalStates = ['Pending', 'Scanning', 'Sweeping', 'Analyzing'];
                    const isNonTerminal = nonTerminalStates.includes(scanInfo.state);

                    if (isNonTerminal) {
                        // Check if this scan is currently active
                        if (activeScanId && activeScanId === scanInfo.scan_id) {
                            displayState = 'Scanning';
                            stateClass = 'scan-status-scanning';
                        } else {
                            displayState = 'Incomplete';
                            stateClass = 'scan-status-incomplete';
                        }
                    }

                    const timestamp = scanInfo.scan_time_display;

                    let counts = '';
                    if (scanInfo.file_count !== null || scanInfo.folder_count !== null) {
                        const filePart = scanInfo.file_count !== null ?
                            `${scanInfo.file_count.toLocaleString()} file${scanInfo.file_count !== 1 ? 's' : ''}` : '';
                        const folderPart = scanInfo.folder_count !== null ?
                            `${scanInfo.folder_count.toLocaleString()} folder${scanInfo.folder_count !== 1 ? 's' : ''}` : '';

                        if (filePart && folderPart) {
                            counts = `<span class="root-scan-meta">${filePart}, ${folderPart}</span>`;
                        } else if (filePart) {
                            counts = `<span class="root-scan-meta">${filePart}</span>`;
                        } else if (folderPart) {
                            counts = `<span class="root-scan-meta">${folderPart}</span>`;
                        }
                    }

                    scanHtml = `
                        <div class="root-scan-info">
                            <span class="root-scan-badge ${stateClass}">${displayState}</span>
                            <span class="root-scan-meta">${timestamp}</span>
                            ${counts}
                        </div>
                    `;
                } else {
                    scanHtml = `
                        <div class="root-scan-info">
                            <span class="root-never-scanned">Never scanned</span>
                        </div>
                    `;
                }

                return `
                    <tr class="root-entry-row">
                        <td class="root-entry-cell">
                            <div class="root-entry-content">
                                <div class="root-path">${root.root_path}</div>
                                ${scanHtml}
                            </div>
                            <div class="root-action-placeholder">
                                <!-- Reserved for future action button -->
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function updateManageRootsPagination() {
            const startIndex = (manageRootsCurrentPage - 1) * manageRootsPageSize + 1;
            const endIndex = Math.min(manageRootsCurrentPage * manageRootsPageSize, manageRootsTotalCount);

            document.getElementById('manage-roots-pagination-info').textContent =
                `Showing ${startIndex} - ${endIndex} of ${manageRootsTotalCount} roots`;

            document.getElementById('manage-roots-prev-btn').disabled = manageRootsCurrentPage === 1;
            document.getElementById('manage-roots-next-btn').disabled =
                manageRootsCurrentPage * manageRootsPageSize >= manageRootsTotalCount;
        }

        function changeManageRootsPage(direction) {
            const newPage = manageRootsCurrentPage + direction;
            const maxPage = Math.ceil(manageRootsTotalCount / manageRootsPageSize);

            if (newPage >= 1 && newPage <= maxPage) {
                manageRootsCurrentPage = newPage;
                loadManageRootsData();
            }
        }

        function showAddRootModal() {
            const overlay = document.getElementById('add-root-modal-overlay');
            const input = document.getElementById('add-root-path-input');
            const errorDiv = document.getElementById('add-root-error');
            const successDiv = document.getElementById('add-root-success');

            // Reset form
            input.value = '';
            errorDiv.classList.remove('visible');
            successDiv.classList.remove('visible');

            // Show modal
            overlay.classList.add('active');

            // Focus input after animation
            setTimeout(() => input.focus(), 100);
        }

        function hideAddRootModal() {
            const overlay = document.getElementById('add-root-modal-overlay');
            overlay.classList.remove('active');
        }

        async function submitNewRoot() {
            const input = document.getElementById('add-root-path-input');
            const errorDiv = document.getElementById('add-root-error');
            const errorText = document.getElementById('add-root-error-text');
            const successDiv = document.getElementById('add-root-success');
            const successText = document.getElementById('add-root-success-text');
            const submitBtn = document.getElementById('add-root-submit-btn');

            const path = input.value.trim();

            // Reset states
            errorDiv.classList.remove('visible');
            successDiv.classList.remove('visible');

            // Validate input
            if (!path) {
                errorText.textContent = 'Please enter a path';
                errorDiv.classList.add('visible');
                return;
            }

            // Disable submit button during request
            submitBtn.disabled = true;
            submitBtn.textContent = 'Adding...';

            try {
                const response = await fetch('/api/roots', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ path })
                });

                const data = await response.json();

                if (response.ok) {
                    // Success
                    successText.textContent = `Root added successfully: ${data.root_path}`;
                    successDiv.classList.add('visible');

                    // Reload the roots list
                    await loadManageRootsData();

                    // Close modal after delay
                    setTimeout(() => {
                        hideAddRootModal();
                    }, 1500);
                } else {
                    // Error from server
                    errorText.textContent = data.error || 'Failed to add root';
                    errorDiv.classList.add('visible');
                }
            } catch (error) {
                console.error('Error adding root:', error);
                errorText.textContent = 'Network error. Please try again.';
                errorDiv.classList.add('visible');
            } finally {
                // Re-enable submit button
                submitBtn.disabled = false;
                submitBtn.textContent = 'Add Root';
            }
        }

        // Add Enter key support for the modal
        document.addEventListener('DOMContentLoaded', () => {
            const input = document.getElementById('add-root-path-input');
            if (input) {
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        submitNewRoot();
                    }
                });

                // Add Escape key to close modal
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        const overlay = document.getElementById('add-root-modal-overlay');
                        if (overlay && overlay.classList.contains('active')) {
                            hideAddRootModal();
                        }
                    }
                });
            }
        });

        // ========================================
        // End Manage Roots Functionality
        // ========================================

        // Listen for hash changes (back/forward buttons)
        window.addEventListener('hashchange', handleRouteChange);

        // Call handleRouteChange immediately to set correct tab before first render
        // This prevents flash of default tab when loading deep links
        handleRouteChange();

        // Handle initial load based on URL hash
        document.addEventListener('DOMContentLoaded', () => {
            loadDashboardData();
            scanManager.render(); // Initial render to show "No Active Scan" if needed
            scanManager.checkForActiveScan(); // Check for active scan and reconnect if found
            views.items.setupDragListeners();
            views.roots.setupDragListeners();
            views.scans.setupDragListeners();
            views.changes.setupDragListeners();
            // No need to call handleRouteChange() again - already called above
        });

        // ==========================================
        // Query Tab Functions
        // ==========================================

        function setQueryExample(query) {
            document.getElementById('query-input').value = query;
        }

        async function executeQuery() {
            const queryInput = document.getElementById('query-input');
            const query = queryInput.value.trim();

            if (!query) {
                showQueryError('Please enter a query');
                return;
            }

            // Hide previous results/errors
            document.getElementById('query-results-container').style.display = 'none';
            document.getElementById('query-error-container').style.display = 'none';

            // Show status
            const statusDiv = document.getElementById('query-status');
            statusDiv.textContent = 'Executing query...';
            statusDiv.style.color = '#0071e3';

            // Disable button
            const executeBtn = document.querySelector('.execute-query-btn');
            executeBtn.disabled = true;

            try {
                const response = await fetch('/api/query/execute', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ query })
                });

                if (!response.ok) {
                    // Try to get error message from response body
                    const errorText = await response.text();
                    throw new Error(errorText || `Query failed: ${response.statusText}`);
                }

                const data = await response.json();

                // Show results
                displayQueryResults(data.columns, data.rows);
                statusDiv.textContent = `Query completed (${data.rows.length} rows)`;
                statusDiv.style.color = '#34c759';

            } catch (error) {
                console.error('Query execution error:', error);
                showQueryError(error.message || 'Failed to execute query');
                statusDiv.textContent = '';
            } finally {
                executeBtn.disabled = false;
            }
        }

        function displayQueryResults(columns, rows) {
            const headerRow = document.getElementById('query-results-header');
            const tbody = document.getElementById('query-results-body');
            const resultsInfo = document.getElementById('query-results-info');
            const resultsContainer = document.getElementById('query-results-container');

            // Clear previous results
            headerRow.innerHTML = '';
            tbody.innerHTML = '';

            // Build header
            columns.forEach(col => {
                const th = document.createElement('th');
                th.textContent = col;
                headerRow.appendChild(th);
            });

            // Build rows
            if (rows.length === 0) {
                const tr = document.createElement('tr');
                const td = document.createElement('td');
                td.colSpan = columns.length;
                td.style.textAlign = 'center';
                td.style.color = '#86868b';
                td.textContent = 'No results found';
                tr.appendChild(td);
                tbody.appendChild(tr);
            } else {
                rows.forEach(row => {
                    const tr = document.createElement('tr');
                    row.forEach(cell => {
                        const td = document.createElement('td');
                        td.textContent = cell;
                        tr.appendChild(td);
                    });
                    tbody.appendChild(tr);
                });
            }

            // Update info
            resultsInfo.textContent = `${rows.length} row${rows.length !== 1 ? 's' : ''} returned`;

            // Show results container
            resultsContainer.style.display = 'block';
        }

        function showQueryError(message) {
            const errorContainer = document.getElementById('query-error-container');
            const errorMessage = document.getElementById('query-error-message');

            errorMessage.textContent = message;
            errorContainer.style.display = 'block';
        }
    </script>
</body>
</html>